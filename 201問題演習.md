### モニタリングに使用するシステム達
- sar...System Activity Repoter
- sadc... System Activity Data Collector
- sadf...System Activity Data Formatter
- iostat
- mpstat...multi prosesser statistics
- pidstat... PID statistics
- nfsiostat...network file system io statistics
- cifsiostat... common interface file systemd io statistics


#### vmstat
- メモリ，及び仮想メモリの詳細を監視する
- オプションを何もしていしなければ，その瞬間の計測量を１行で表示する
- `vmstat [表示間隔] [回数]`
- 表示項目
  - proc
    - r...実行待ちプロセス数(runnable)
    - b...割り込み不可能なスリープ状態のプロセス数(blocked)，uninterrupt sleepともいう
  - memory
    - swpd...スワップサイズ
    - free...空きメモリサイズ
    - buff...バッファに割り当てられているメモリ(KB)
    - cache...キャッシュに割り当てられているメモリサイズ(KB)
  - swap
    - si...ディスクからスワップインされているメモリサイズ(KB/s)
    - so...ディスクへスワップアウトされているメモリサイズ(KB/s)
  - io
    - bi...ブロックデバイスから受け取った前ブロック数．（ブロック数/s）
    - bo...ブロックデバイスに送られたブロック数．（ブロック数/s）
  - system
    - in...1s当たりの割り込み回数．クロック割り込みも含む
    - cs...1s当たりのコンテキストスイッチの回数
  - cpu
    - us...ユーザプロセスがCPUを利用している時間の割合(user)
    - sy...カーネルがCPUを使用している時間の割合(system)
    - id...CPUがアイドル状態の時間の割合(idole)
    - wa...ディスクがI/O待ちの時間の割合(wait)
    - st...ゲストOSがCPUを割り当てられなかった時間の割合(steal)

#### モジュール関連
- lsmod
- modinfo
- insmod、modprobe
- rmmod、modprobe -r
- depmod
  - modules.dep
- modprobe.conf
  - alias
  - options
  - install
  - remove
  - blacklist
- `/lib/modules/$(uname -r)/kernel/drivers/{any}.ko`
### Linuxがカーネルがある場所
- kenel.org
- usr/src/linux
  - ここから.config,makeを実施
- bzImage,zImageを作成
- vmlinuz(Virtual Memory Linuz Zipeed)
  - /boot/vmlinuz-*/

#### tarのさらなるオmプション
- bzipやgzip、xzと違って元のファイルは残す
- また、指定したファイルだけを取り出すこともできる
- `tar -xvf sample.tar /{path} [option]`
  - ディレクトリ、ファイルだけ取り出すのも可能
- オプション
  - --wildcards "{expand_word}"...特定の形式のファイルを取り出す

#### ssdにおいて、データを削除する
- TRIM機能
- 実行は`fstrim -v`
  - fstabに沿ってtrimしたりもできる
    - オプションにdiscardがついていれば、マウント時にfstrim
#### mdadm主要なオプション
- RAID構成するアレ
- 作成
  - `mdadm -Ca -l=1 -n=2 /dev/sda1 /dev/sdb1`
- 操作
  - `mdadm --manage --add /dev/md0 /dev/sdd1 `
    - デフォルトではホットスペアとして追加される
  - `mdadm --manage --remove /dev/md0 /dev/sda1`
  - `mdadm --fall /dev/md0 /dev/sda1`
- その他
  - `mdadm -Q`...状態確認
  - `mdadm -D`...詳細な状態を確認
  - `mdadm -E`...構成デバイスの状態を確認
- ドライ実行できないので注意


#### 覚えておくべきRAID
- 0...2台以上のストライピング構成。異なるストレージとして使用
- 1...2台以上同期構成。同じストレージとして使用
- 4...3台以上のストライピング・パリティ構成。専用ディスク
- 5...3台以上のストライピング・パリティ構成。分散思考
- 6...4台以上のストライピング・パリティ構成。2台故障補償。分散
- 10...4台以上でストライプと同期構成を取る

### 論理ストレージから削除する
- vgreduce,vgremove
- lvreduce,lvremove
- reduceを使用すると、部分的に除外する
  - vgreduce {pv}..vgからpvを外す
  - vgremove {vg}...vgをまるっと削除する
- lvの場合
  - lvreduce -L {vol} {lv}...容量を減らす
  - lvremove {lv} ...lvが完全に消える

### /proc/mdstatを読む
- コンピュータ上に構成されるマルチデバイス構成を検出
```
$ cat /proc/mdstat
Personalities : [raid1] [raid5]
md0 : active raid5 sdc1[3] sdd1[2] sdb1[1]
      1953383488 blocks super 1.2 level 5, 512k chunk, algorithm 2
      [3/3] [UUU]

md1 : active raid1 sde1[0] sdf1[1]
      9766304 blocks super 1.2 [2/2] [UU]

unused devices: <none>
```
- わかること
  - mddevファイルがどんな構成で実行されているのか
  - 構成ディスクとそのRAID内部管理番号(sdc[3])
  - 構成ディスクの扱い
    - (S)...Spare
      - スタンバイ構成
    - (F)...Faulty
    - (W)...Write-mostly
    - (R)...Repalcement
      - 同期中
    - (J)...Journal
  - [N/M]...N台を想定して、M台起動している
    - ここが1を超えていると故障であることがわかる
    - ここにスペアは表示しない
  - [UUU]...故障があると表記が変わる
    - [U_U]だと中央が故障している
#### fstabを復習
- `/etc/fstab`
  - 1. デバイスファイル/ラベル/UUID
  - 2. マウントポイント
  - 3. ファイルシステムの種類
  - 4. マウントオプション
  - 5. dumpの対象か？
  - 6. ブート時にfsckするかどうか？
- マウントオプション
  - default
    - rw
    - suid
    - dev
    - exec
    - auto
    - nouser
    - async
- ちょっと古いデバイス特有のオプション
  - uid,gid...この名前/グループを所有者とする
  - umask...アクセス権に関するumaskを定義
  - fmask...ファイルの権限だけをumask形式で定義
  - dmask...ディレクトリの権限だけをumask形式で定義
  - shortname...FATファイル名の扱いを指定
  - iocharset...文字コードを指定
### デバイスの命名規則
- IDE接続
  - 40/80ピン
  - これはストレージのみ接続される
  - /dev/hda
  - /dev/hdb
  - /dev/hdc
  - /dev/hdd
  - 上記4台のみ定義される
- SATA
  - まず、何が接続されたかか確認する
    - ストレージの場合
      - /dev/sda
      - /dev/sdb
    - 光学ディスクの場合
      - /dev/sr0
      - /dev/sr1
      - ※ 1からナンバリングしていく
- Linux Kernel 2.6以降は、全てのデバイスに対して/dev/sd*という命名になった

### syncコマンドについて
- メモリ上のキャッシュデータを強制的に書き込むコマンド
- 基本オプションは入れない
- 利用ケース
  - OSを再起動する前
  - umountする前
- `sar -r`,`/proc/meminfo`で見れる内容でDirtryになってるやつをディスクに戻す


###　ラベルを変更する方法
- tune2fs -L {name} {dev}
  - ext系のみ
- btrfs filesystem label {dev} {label}
  - btrfsのみ
  - subvolumeじゃ無い方
- ntfslabel {dev} {name}
  - ntfsのみ
- mkswap -L {name} {dev}
  - 再度作成するようになる。
- lvrename {vg_name} {old_lv_name} {new_lv_name}
- cryptsetup config {dev} --label={label_namme}
  - 暗号化したディスク向け

#### 暗号化管理するcrypysetup
- cryptsetup create...パスフレーズを設定して暗号ディスク作成
- cryptsetup remove...カーネル上の共通鍵を削除
- cryptsetup open...devにmapperを作成
  - はじめてcreateされた場合は、自動でmapperを作成するため不要
- cryptsetup close...devからmapeerを削除
- ファイルシステムはマッパーに対して作成すること！
  - 暗号化　→　マウント　→　ファイルシステム作成の流れ

- 状態確認系
  - `cryptsetup status {name}`
    - mapperの名前を指定して、ステータスを表示
      - 暗号、サイズなど
  - `cryptsetup lucksDump {dev}`
    - キーロット、暗号設定、ハッシュ
#### cryptsetupで扱える暗号
- `--type={name}`オプションで設定可能
  - LUKS1...
    - AES128,192,256で暗号化する
    - ハッシュ化もする。sha1
  - LUKS2...
    - AES,Twofish,Camelliaなどで暗号化可能
    - ハッシュもある。sha-2-256など
#### 「systemdは独自のUEFIブートローダがある」
- systemd-bootがvmlinuzを読めるという意味

#### 再起動プロセス
- システムレベル
  - 0...停止
  - 1...シングルユーザ
  - 2,3,4,5...マルチユーザ
  - 6...再起動
  - s...シングルユーザ

### 再起動せずにシステムレベルを切り替える
systemctl isolate
systemctl default
init
telinit

### sysvinitランレベルの変更コマンド
- `init X`
- `telinit X`
- ※ 


### 「systemdは独自のUEFIブートローダが存在する」
- 基本はGRUB2が動作すると考えて良い
  - SYSLINUX...Fatシステム（usb）などからカーネルを起動
  - ISOLINUX...ISO9660(CD-ROM)からカーネルを起動
  - EXTLINUX...ext2/ext3/ext4からカーネルを起動
  - PXELINUX...PXEを使ってネットワークブートを実行
  - systemd-boot...UEFIのみ対応．
  - U-boot...組み込み系のboot．PowerPC，ARM，MIPSに対応
#### UEFIにおけるEFIの選択
- ファームウェアによって.efiを選択する
  - この選択はNVRAMによって選択
- ブートメニューが選べるのはGRUBの機能
  - 他のブートローダにチェーンもできる
  - UEFIの機能でブートローダの呼び出し選択はできる
- systemd-bootなどは.confに従う。

#### ランレベルとファイル
- 主要なファイル
  - `/etc/rc{X}.d/`
    - ランレベルにそってこれが実行される
  - `/etc/init.d/{script}`
    - スクリプトの実態はここにある
- 主要なコマンド
  - `chkconfig --level N httpd on`
    - レベルNのS01httpdサービスを投入
      - --list
      - --add
      - --del
      - service on
      - service off
      - などなど
  - `update-rc.d`
    - こちらもサービスのリンクを扱うことができる
      - default,remove,enable,disableなどなど
    - `update-rc.d -f remove <service>`シンボリックリンクを削除する
      - -fナシだと、通常は既に同名のリンクがある場合はエラーになる。
      - スクリプトの実態は削除されない
    - `update-rc.d -n`ドライ実行
#### /systemd/system/ユニットファイルの配置
- `/etc/`...管理者投入
- `/run/`...一時参照
- `/lib/`...デフォルト


#### 色々なinit
- /etc/inittab...SysVinit
- /etc/init.d/...各サービスの起動スクリプト
- /etc/init/*.conf...Updtartイベント

#### efibootmgr
- UEFIにおけるブート情報の設定変更
- 書き換えは、カーネルのNVRAMを書き換えている
- どの順番でefiファイルを実行するのか？
- efiファイルの中身を変更しているわけではない
  - BOOTORDER: 0001,0002,0003
  - BOOT0000* ...
  - BOOT0001* ...
  - BOOT0002* ...
- efiを指すディスクパスが独自のものになっている。
  - MBRとはまた違う形式
  - EFIデバイスパスと呼ばれるもの

### NVRAM vs .efiファイル
- NVRAM...Non-Volatile RAM
  - マザーボード上の不揮発性メモリ上に存在
  - メタデータが存在する
  - どのEFIファイルを起動するかはここで決めている
- EFIファイル
  - ディスク上にある。
  - systemd-bootやgrubの実態はこれ


#### /etc/inittab
- Sysinitの実行
- initによって呼び出される
  - ランレベルごとのシステムサービス実行
    - ここがSysVinitのミソ
  - tty(getty)の実行
  - ctrl-Alt-del押下時のアクション
  - が定義
- systemdにおいては、ランレベルという定義が無い
  - 同様の動作をするための互換性は持っている

#### sarコマンド
- sar -b
  - ブロック統計。→ 違うっぽい？
- sar -n
  - ネットワーク統計
- sar -r
  - メモリ統計
  - memory residentの略らしい
#### /boot/config-{varname}
- カーネルビルド時の設定ファイル
- config-linux-{version}ではない
- config-{vesion}なので注意

#### top vs ps aux
- top
  - A...平均CPU使用率に変更
  - P...CPU使用順にソート
  - M...メモリ順にソート
  - N...PIDソート
  - T...設定の保存
  - W...設定のファイル保存
  - ※ デフォルトではがCPU消費量が多い順
- ps aux
  - ※ デフォルトではPIDが小さい順

#### トラフィックの考え方
- これはNWがメインで使用する言葉。
- メモリではIOとか言う

#### 統計・ステータス表示XXstat
- sar...sacが収集
- iostat...CPU/ブロックデバイス
- vmstat...メモリ/プロセス/CPU
- netstat...ネットワーク
- mapstat...CPUコアごとの稼働
- nfsiostat...NFSマウント経由のIO統計
- cifsiostat...SMB,CIFSマウント経由でのIO統計

| 統計対象     | sar | iostat | vmstat | netstat | mpstat |
|--------------|-----|--------|--------|---------|--------|
| CPU          | ○   | ○      | ○      | ×       | ○      |
| メモリ       | ○   | ×      | ○      | ×       | ×      |
| I/O          | ○   | ○      | ○      | ×       | ×      |
| ネットワーク | ○   | ×      | ×      | ○       | ×      |
| プロセス     | ×   | ×      | ○      | ×       | ×      |

- free...メモリのみ
- lsof...ファイルのIO、マウント、ソケットのファイルも含む
- `pidof {command}`...実行中のコマンドのPIDを戻す

####　ネットワークリンクを監視する
- ネットワークリンク
  - 帯域使用率...ネットワークがどれだけ使用されているか？
    - 回線やNICのスペックのこと
  - 遅延...パケットが送信元から目的地に到着するまで
  - パケット損失率
  - ジッター...到着時間のばらつき
  - エラー率...NICで検出される送受信エラー
  - 接続状態...リンクが使用可能かどうか

#### sarコマンドまとめ
- 保存先は、/var/log/sa/saXX
- sar ...保存済み、リアルタイムの統計を表示。system activity Repoter
- sa1...cronで実行されている集計実行コマンド。
- sa2...集計済みの結果を日次、月次集計レポート。
- sadf...sarログをCSV,XMLで出力。System Activity data formatter
- sadc...集計実行コマンド。sa1はこれを呼んでいる。System Activity data collector


#### tcpd
- tcp wrapperの管理
- Firewallを持たないサービスを保護する
- フィルタの設定は`/etc/hosts.alow`,`/etc/hosts.deny`
  - 接続元ホスト/IP・NWマスク
  - プロトコル名、ポート

#### ipconfig
- `ifconfig [NIF] {pram}`
  - NICに対する設定
  - ルートテーブルに関しては設定の対象外

#### dig vs traceroute
- dig...DNSの解決にかかる時間を検索
- traceroute...ipにそって経路にかかる時間を表示

#### tcpdump
- NICを通過するパケットを監視。
  - 方向も管理できる

- ホスト、ネットワーク指定
  - `tcpdump host XXX.XXX.XXX.XXX`
  - `tcpdump src host X.X.X.X`
    - src...どこから来たパケットか？
  - `tcp.dumo dst host X.X.X.X`
    - dst...宛先
- ポートサービス
- `tcpdump port XX`
- プロトコル
  - `tcpdump icmp`
  - `tcpdump arp`
#### ip コマンド
- `ip link show/add`
- `ip addr show/add/del`
- `ip route show/add/del`

#### ipコマンドから情報を得る
- mtu...Maximum Transmission Unit
  - 一度に送ることができるパケット量
- qlen...Queue Length
  - キューに保持できるパケット最大数
- brd...broadcast address
  - ブロードキャストアドレス
- metric...routing metric
  - ルーティングメトリクス。
  - 経路評価値など。
  - 優先度。低いほど優秀な経路
　
#### tcpdump -lで名前データを確認する
- 出力
  - {時間} IP {srcIP.port} {dstIP.port} 補足情報
- ポートはドットで繋ぐのがミソ


#### iw コマンドにおけるphyとdev
- phy...phisical wireless device
  - 物理ハードウェア
  - NICに複数のVIFが存在しているものもあるが、その時に検出されるのは1つのphy
- dev...wireless interface
  - ip link showで見えるのはこれ
  - OSに認識される論理インタフェース
- `iw phy info`
  - 最大SSID数
  - 暗号化方式
  - チャネル
  - 帯域幅
  - モード
- `iw dev info`
  - OSが認識しているインタフェース名
  - タイプなど

