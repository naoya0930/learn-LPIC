# webサーバ、プロキシサーバ

### Apache
- ここでの文脈はほとんどApache HTTP Serverのこと
- 
- 2.0系からMulti-processing Moduleを採用
  - リクエストをプロセス、スレッド、イベントのどの手順で捌くかを設定
  - prefork...プロセスを新規で起こす
  - worker...スレッドを新規で起こす
  - event...Keep Aliveを非同期にする
- IPv6の対応も2.0系から

### Apache HTTPの設定
- `httpd.conf`で設定
- ディストリビューションによって配置は様々
- 配置
  - RHEL/CentOS
    - `/etc/httpd/conf/httpd.conf`
    - これは1ファイルに全て書いていく思想
  - Debian/Ubuntu
    - `/etc/apache2/apache2.conf`
    - 他ファイルでわけていく思想
### 設定ファイルの用語
- ディレクティブ
  - 設定の単位
- コンテキスト
  - ディレクティブが使用できる場所
  - 各ディレクティブによって有効なコンテキストが存在する
- 仮想環境
  - 1台のApache、1つのIP/Port、複数のHTTPSサイトを実現する論理的な分離
  - ServerName/SNI(Server Name Indication)

### SNI(Server Name Indicaton)って何？
- L4の話。FQDNにおけるホスト部をいい感じに解釈してTLSする
- TSLするための証明書の発行単位がドメイン(IPでない)ために発生する
  - www.example.comや、api.example.comの1対1で証明書は存在
  - DNSではexample.comのIP変換までしかやってくれない
  - SSL/TLSが`Client Hello`するの際に指定するSNI
    - `SNI = xxx.example.com`によって証明書を選択する
    - サーバは、どの証明書を出せばよいのかL4で判断できる
- クライアントの対応が必須
- サーバ側で使用する証明書、対応するHTTPS仮想ホストを選択
- これが無い場合、TLSするためには、IP/Portを分けなければならない

### 主要なディレクティブ
- Listen
- MaxClients
- StartServers
- MinSpareServers
- MaxSpareServers
- KeepAlive
- KeepAliveTimeout
- Alias
- Redirect
- ErrorDocument
- DocumentRoot
- DirectoryIndex
- Options Indexes
- Options FollowSymLinks
- UserDir
- AllowOverride
- AccessFileNmae
- <Directory>
- AuthType
- AuthName
- AuthUserFile
- Require
- Order
- Allow
- Deny
- Satisfy
- SSLEngine
- SSLCertificateKeyFile
- SSLCertificateFile
- SSLVerifyClient
- <VietualHost>
- NameVirtualHost
- CustomLog
- LogFormat
- ErrorLog
- LoadModule

### 主要なディレクティブの詳細
- Listen
  - Apacheが待ち受けるIPとポート番号
- MaxClients (=MaxRequestWorkers)
  - 同時に処理できる最大クライアント数
  - workerモデルであればスレッド、preforkであればプロセスの最大数
- StartServers
  - Apache起動時に生成する子プロセス数を指定します。
- MinSpareServers
  - 待機状態で最低限維持する子プロセス数を指定します。
- MaxSpareServers
  - 待機状態で保持する子プロセス数の上限を指定します。
- KeepAlive
  - HTTPの維持接続（同一接続の再利用）を有効・無効にします
- KeepAliveTimeout
  - KeepAliveの維持時間（秒）を設定します。
- Alias
  - URLパスを実際のファイルシステム上の別ディレクトリに対応させます
- Redirect
  - クライアントを別のURLへリダイレクトします
- ErrorDocument
  - エラー発生時に表示するカスタムページを指定します。
- DocumentRoot
  - Webコンテンツの期限となるディレクトリを指定します。
- DirectoryIndex
  - ディレクトリにアクセスされた際に表示する規定ファイルを指定します。
- Options Indexes
  - インデックスファイルが無い場合にディレクトリ一覧表示を許可
- Options FollowSymLinks
  - シンボリックリンクをさかのぼることを許可します。
- UserDir
  - ユーザのホームディレクトリ配下を公開する仕組みを有効化します。
- AllowOverride
  - `.htaccess`で上書き可能な設定範囲を指定
- AccessFileNmae
  - ディレクトリ毎に読み込む設定ファイル名を指定
  - 普通は`.htaccess`
- <Directory>
  - 特定のディレクトリに対する設定ブロックを定義します。
- AuthType
  - 使用する認証方法（Basicなど）を指定します。
- AuthName
  - 認証ダイアログに表示される認証領域名を指定
- AuthUserFile
  - ユーザ名とパスワードを格納したファイルを指定
- Require
  - アクセスを評価する対象を指定
- Order
  - Allow/Denyの評価順序を指定
- Allow
  - アクセスを許可する対象
- Deny
  - アクセスを拒否する対象
- Satisfy
  - 認証とアクセス制限のどちらかを満たせば許可するか指定
- SSLEngine
  - SSL/TLS通信を有効、無効にする
- SSLCertificateKeyFile
  - サーバ証明書に対応する秘密鍵ファイル
- SSLCertificateFile
  - サーバ証明書ファイル
- SSLVerifyClient
  - クライアント証明書の検証要否
- <VietualHost>
  - IP,ポート、SNIごとの仮想ホスト設定
- NameVirtualHost
  - 名前ベースのvirtualhostを有効化。
  - この設定は古い
- CustomLog
  - アクセスログの出力先と形式の指定
- LogFormat
  - アクセスログのフォーマットを指定
- ErrorLog
  - エラーログの出力先を指定
- LoadModule
  - Apacheの機能を提供するモジュール

#### リクエストを別のファイルに転送する(Alias、Redirect)
- `Alias /doc /usr/share/doc`
  - これは、他のサーバに送ることはできない
  - `DocumentRoot`とはまた別の設定
  - Aliasしたからといって読めるわけではない。
    - Direvtory,Require等の制御をちゃんと見る必要がある。
  - パスの話なので証明書は関係ない
- `Redirect /doc https://www.sample/doc`
  - リダイレクトするようレスポンスを出す
  - サーバ側が知ることができる
#### エラーした際のデフォルトのエラーメッセージ(ErrorDocument)
- `ErrorDocument 404 {遷移先}`
- エラー先の表示ファイルの遷移先を定義する
  - 使用できるのは下記
    - ローカルファイル
    - URLパス
    - 外部URL
    - インライン文字列
- 指定できるエラーコード
  - 401 ... Unauthorized ...ユーザが認証に失敗
  - 403 ... Forbidden ...サーバがアクセス権の無いファイルにアクセス
  - 404 ... NotFound ... 指定されたファイルは存在しない
  - 500 ... Server error ... CGIや拡張モジュール等のサーバ内部エラー

#### DocumentRootの役割
- URLパスをファイルシステム上のどこに対応付けるか？
  - `/var/www/html`(最後の/は付けない)とする
  - html配下にファイル`index.html`を配置すると
  - `https://example.com/index.html`へのアクセスが成立する
- 公開範囲の境界線として動作する
  - Directoryで指定しない限り、クライアントはここ以外に行けない
- 仮想ホストはDocumentRootごとに確立する。
  - 仮想ホストは管理概念。
  - TLSは断裂する。
  - HTTP KeepAliveは継続。
  - Cookieは設定で継続しなければ断裂。

#### 最初に表示するファイル(DirectoryIndex)
- `DirectoryIndex index.php index.html index.htm`
  - 指定したファイルを左から右に見ていく。
- すべて見つからなかった場合は下記
  - Options Indexesによってファイルのリストを返す
  - Options Indexesが無い場合は403を戻す

#### optionsディレクティブの指定
- Optionsに続いて書く。有効、無効はマイナス、プラスを書いても良い
- Options
  - Indexes ...完全上書き
  - +Indexes...親コンテキストから追加
  - -Indexes...親コンテキストから削除
- 主要なOptions
  - Options indexes
  - Options FollowSymLinks
  - Options SymLinksIfOwnerMatch
  - Options execCGI
  - Options Includes
  - Options MultiViewer

#### DocumentRoot外にアクセスする、Options FollowSymlinks、SymLinksIfOwnerMatch
- FollowSymlinks
  - シンボリックリンクをたどることを許可する。
- SymLinksIfOwnerMatch
  - ファイルの所有者が一致していればシンボリックリンク経由可能
  - ここでの所有者はファイルの所有者
  - OSによって作成されたファイル
  - `apache`、`www-data`などが該当
- ※ このほかにもCGIAlias(scriptAlias)によっても外部にアクセスできる
#### OSのユーザディレクトリを公開する
- `UserDir dir1`を設定すると
- `https://home/~user1/dir1`をアクセス可能にする 
- 検証環境、共有サーバで使用されていた
- ユーザの検証を実施しない
- DocumentRootと別枠で公開される

#### .htaccess
- リクエストされたパスの親ディレクトリから探索して初めて見つかる.htaccessという名前のファイルを参照する
- 内容は設定のオーバライド
  - 特定パスへのユーザの制限
  - 認証・認可
  - URLリライト
  - ディレクトリオプションの変更
- .htaccessを書けばどんな編集をできるわけではない
- `AllowOverride`によってある程度規制をかけられる
  - `AllowOrverride None` ...何も編集しない
  - `AllowOrverride AuthConfig` ...認証関連
  - `AllowOrverride FileInfo` ...Reqrite/ErrorDocument
  - `AllowOrverride Indexes` ... Options/Indexes
  - `AllowOrverride Limit` ... Require/Allow 
  - `AllowOrverride All`...すべて
- .htacessは`AccessFileName`によって指定されている名前。変更可能

#### Access方式 vs Requireディレクティブ
- Access...Order、Denyとセットで使用する
  - `Order allow deny`...どちらを優先的に処理するか。例ではallowが優先
  - 非定義なIP(allowもdenyもしないIP)は優先されたOrderに準拠する
  - `Allow from 10.0.0.0/8`
  - `Deny from all`
  - `Deny from env=VAR`
- Require...許可するIPのみを指定する
  - `Require ip 192.168.0.0/16`
  - `Require all granted`...全許可
  - `Require all deny`...全拒否
  - `Require ip 192.168.1.0`
  - `Require host example.com` ※ 逆引きDNSでアクセス元を特定
  - `Require user alice` ※ 要認証
  - `Require group admin` ※ 要認証
  - `Require vailid-user` ※ 要認証
  - `Require env ALLOW_ACEESS`
  - `<RequiteAll>`や`<RequoteAny>`を使用して、複数を組み合わせることも可能
  - 特定のモジュールが必要なものもある

#### 認証関係
- AuthType...Basic(base64)/Digest(nonce+hash)から選択できる
  - `AuthType Basic`
- AuthName...認可領域の名前を指定
  - 既定の認可領域。同じサーバでもAuthNameが違えば、別認証として処理
  - クライアントがどの領域ににログインしようとしているのか判断する
  - `AuthName Admin`
- AuthUserFiles...認証に使用するユーザとパスワードが格納されたファイルを指定
- Satisfy...ホストのアクセス制御とユーザ認証両方が指定されればアクセス許可？
  - `Satisfy Any`...アクセス制御かユーザ認証どちらかでOK
  - `Satisfy All`...アクセス制御とユーザ認証双方を要求（デフォルト）

#### apacheにおけるモジュール()
- 方法は以下の2つ
  - apacheに入っているものを探す。
  - ソースからビルドして.soや.dllを作成する
- .so、.dllファイルによってインポート
  - `LoadModule {モジュール名} {モジュールのパス}`
##### セキュリティ関係のモジュール
- requireで特殊な条件を組み込む際に必要となる
  - mod_authz_core...env,all,method
  - mod_authz_user...user,calod-user
  - mod_authz_host...ip,host,forward-dns,local
  - mod_authz_groupfile...プレーンテキストファイルによるグループ指定
##### ☆セキュリティ関係のモジュール挙動
- mod_authz_*をインポートした場合
  - Requireで動作する
  - Access方式(Order,Allow,Deny)が無効化される
- `mod_authz_compat`があればそ両方動作する(可読性の面で非推奨)

### apacheの管理を実行する
- apachectlコマンド、httpdコマンドの双方が使用される
- `apachectl`
  - start...httpdの起動
  - stop...httpdデーモンの停止
  - restart...httpdデーモンの再起動
  - graceful...クライアントの接続完了を待ってhttpdを再起動
  - graceful-stop ... クライアントの接続完了を待ってhttpdを停止
  - configtest ....設定ファイルの書式チェック
  - httpdのラッパーコマンドなので、httpdのコマンドも使える
- `httpd`
  - -t...設定の確認
  - -S...読み込まれる設定ファイル一覧
  - -M...読み込まれているモジュールを一覧表示
### apacheでユーザ認証するために、アカウント、パスワードを作成する(htpasswd)
- `htpasswd`コマンド
- `htpasswd -c /var/www/htpasswd user1`...ユーザとパスワードを作成
- `htpasswd -D /var/www/htpasswd user1`...削除
- `htpasswd -n ryo`...ユーザエントリを標準出力に表示
  - この出力を.htpasswdなどに保存すれば有効な値として扱われる
  - 例：`testuser:$apr1$abcd1234$eFghIjklMNOpqRstUvwxy/`
    - {ユーザ名}:{パスワードハッシュ}で構成
    - パスワードハッシュは、apr1,salt,hashで構成されている
- .htpasswd
  - ユーザ認証データベース
  - AuthUserFileでファイル名として指定することがある
    - `AuthUserFile /etc/apache2/.htpasswd`