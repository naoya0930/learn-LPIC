# webサーバ、プロキシサーバ

### Apache
- ここでの文脈はほとんどApache HTTP Serverのこと
- 
- 2.0系からMulti-processing Moduleを採用
  - リクエストをプロセス、スレッド、イベントのどの手順で捌くかを設定
  - prefork...プロセスを新規で起こす
  - worker...スレッドを新規で起こす
  - event...Keep Aliveを非同期にする
- IPv6の対応も2.0系から

### Apache HTTPの設定
- `httpd.conf`で設定
- ディストリビューションによって配置は様々
- 配置
  - RHEL/CentOS
    - `/etc/httpd/conf/httpd.conf`
    - これは1ファイルに全て書いていく思想
  - Debian/Ubuntu
    - `/etc/apache2/apache2.conf`
    - 他ファイルでわけていく思想
### 設定ファイルの用語
- ディレクティブ
  - 設定の単位
- コンテキスト
  - ディレクティブが使用できる場所
  - 各ディレクティブによって有効なコンテキストが存在する
- 仮想環境
  - 1台のApache、1つのIP/Port、複数のHTTPSサイトを実現する論理的な分離
  - ServerName/SNI(Server Name Indication)

### SNI(Server Name Indicaton)って何？
- L4の話。FQDNにおけるホスト部をいい感じに解釈してTLSする
- TSLするための証明書の発行単位がドメイン(IPでない)ために発生する
  - www.example.comや、api.example.comの1対1で証明書は存在
  - DNSではexample.comのIP変換までしかやってくれない
  - SSL/TLSが`Client Hello`するの際に指定するSNI
    - `SNI = xxx.example.com`によって証明書を選択する
    - サーバは、どの証明書を出せばよいのかL4で判断できる
- クライアントの対応が必須
- サーバ側で使用する証明書、対応するHTTPS仮想ホストを選択
- これが無い場合、TLSするためには、IP/Portを分けなければならない

### 主要なディレクティブ
- Listen
- MaxClients
- StartServers
- MinSpareServers
- MaxSpareServers
- KeepAlive
- KeepAliveTimeout
- Alias
- Redirect
- ErrorDocument
- DocumentRoot
- DirectoryIndex
- Options Indexes
- Options FollowSymLinks
- UserDir
- AllowOverride
- AccessFileNmae
- <Directory>
- AuthType
- AuthName
- AuthUserFile
- Require
- Order
- Allow
- Deny
- Satisfy
- SSLEngine
- SSLCertificateKeyFile
- SSLCertificateFile
- SSLVerifyClient
- <VirtualHost>
- NameVirtualHost
- CustomLog
- LogFormat
- ErrorLog
- LoadModule

### 主要なディレクティブの詳細
- Listen
  - Apacheが待ち受けるIPとポート番号
- MaxClients (=MaxRequestWorkers)
  - 同時に処理できる最大クライアント数
  - workerモデルであればスレッド、preforkであればプロセスの最大数
- StartServers
  - Apache起動時に生成する子プロセス数を指定します。
- MinSpareServers
  - 待機状態で最低限維持する子プロセス数を指定します。
- MaxSpareServers
  - 待機状態で保持する子プロセス数の上限を指定します。
- KeepAlive
  - HTTPの維持接続（同一接続の再利用）を有効・無効にします
- KeepAliveTimeout
  - KeepAliveの維持時間（秒）を設定します。
- Alias
  - URLパスを実際のファイルシステム上の別ディレクトリに対応させます
- Redirect
  - クライアントを別のURLへリダイレクトします
- ErrorDocument
  - エラー発生時に表示するカスタムページを指定します。
- DocumentRoot
  - Webコンテンツの期限となるディレクトリを指定します。
- DirectoryIndex
  - ディレクトリにアクセスされた際に表示する規定ファイルを指定します。
- Options Indexes
  - インデックスファイルが無い場合にディレクトリ一覧表示を許可
- Options FollowSymLinks
  - シンボリックリンクをさかのぼることを許可します。
- UserDir
  - ユーザのホームディレクトリ配下を公開する仕組みを有効化します。
- AllowOverride
  - `.htaccess`で上書き可能な設定範囲を指定
- AccessFileNmae
  - ディレクトリ毎に読み込む設定ファイル名を指定
  - 普通は`.htaccess`
- <Directory>
  - 特定のディレクトリに対する設定ブロックを定義します。
- AuthType
  - 使用する認証方法（Basicなど）を指定します。
- AuthName
  - 認証ダイアログに表示される認証領域名を指定
- AuthUserFile
  - ユーザ名とパスワードを格納したファイルを指定
- Require
  - アクセスを評価する対象を指定
- Order
  - Allow/Denyの評価順序を指定
- Allow
  - アクセスを許可する対象
- Deny
  - アクセスを拒否する対象
- Satisfy
  - 認証とアクセス制限のどちらかを満たせば許可するか指定
- SSLEngine
  - SSL/TLS通信を有効、無効にする
- SSLCertificateKeyFile
  - サーバ証明書に対応する秘密鍵ファイル
- SSLCertificateFile
  - サーバ証明書ファイル
- SSLVerifyClient
  - クライアント証明書の検証要否
- <VietualHost>
  - IP,ポート、SNIごとの仮想ホスト設定
- NameVirtualHost
  - 名前ベースのvirtualhostを有効化。
  - この設定は古い
- CustomLog
  - アクセスログの出力先と形式の指定
- LogFormat
  - アクセスログのフォーマットを指定
- ErrorLog
  - エラーログの出力先を指定
- LoadModule
  - Apacheの機能を提供するモジュール

#### リクエストを別のファイルに転送する(Alias、Redirect)
- `Alias /doc /usr/share/doc`
  - これは、他のサーバに送ることはできない
  - `DocumentRoot`とはまた別の設定
  - Aliasしたからといって読めるわけではない。
    - Direvtory,Require等の制御をちゃんと見る必要がある。
  - パスの話なので証明書は関係ない
- `Redirect /doc https://www.sample/doc`
  - リダイレクトするようレスポンスを出す
  - サーバ側が知ることができる
#### エラーした際のデフォルトのエラーメッセージ(ErrorDocument)
- `ErrorDocument 404 {遷移先}`
- エラー先の表示ファイルの遷移先を定義する
  - 使用できるのは下記
    - ローカルファイル
    - URLパス
    - 外部URL
    - インライン文字列
- 指定できるエラーコード
  - 401 ... Unauthorized ...ユーザが認証に失敗
  - 403 ... Forbidden ...サーバがアクセス権の無いファイルにアクセス
  - 404 ... NotFound ... 指定されたファイルは存在しない
  - 500 ... Server error ... CGIや拡張モジュール等のサーバ内部エラー

#### DocumentRootの役割
- URLパスをファイルシステム上のどこに対応付けるか？
  - `/var/www/html`(最後の/は付けない)とする
  - html配下にファイル`index.html`を配置すると
  - `https://example.com/index.html`へのアクセスが成立する
- 公開範囲の境界線として動作する
  - Directoryで指定しない限り、クライアントはここ以外に行けない
- 仮想ホストはDocumentRootごとに確立する。
  - 仮想ホストは管理概念。
  - TLSは断裂する。
  - HTTP KeepAliveは継続。
  - Cookieは設定で継続しなければ断裂。

#### 最初に表示するファイル(DirectoryIndex)
- `DirectoryIndex index.php index.html index.htm`
  - 指定したファイルを左から右に見ていく。
- すべて見つからなかった場合は下記
  - Options Indexesによってファイルのリストを返す
  - Options Indexesが無い場合は403を戻す

#### optionsディレクティブの指定
- Optionsに続いて書く。有効、無効はマイナス、プラスを書いても良い
- Options
  - Indexes ...完全上書き
  - +Indexes...親コンテキストから追加
  - -Indexes...親コンテキストから削除
- 主要なOptions
  - Options indexes
  - Options FollowSymLinks
  - Options SymLinksIfOwnerMatch
  - Options execCGI
  - Options Includes
  - Options MultiViewer

#### DocumentRoot外にアクセスする、Options FollowSymlinks、SymLinksIfOwnerMatch
- FollowSymlinks
  - シンボリックリンクをたどることを許可する。
- SymLinksIfOwnerMatch
  - ファイルの所有者が一致していればシンボリックリンク経由可能
  - ここでの所有者はファイルの所有者
  - OSによって作成されたファイル
  - `apache`、`www-data`などが該当
- ※ このほかにもCGIAlias(scriptAlias)によっても外部にアクセスできる
#### OSのユーザディレクトリを公開する
- `UserDir dir1`を設定すると
- `https://home/~user1/dir1`をアクセス可能にする 
- 検証環境、共有サーバで使用されていた
- ユーザの検証を実施しない
- DocumentRootと別枠で公開される

#### .htaccess
- リクエストされたパスの親ディレクトリから探索して初めて見つかる.htaccessという名前のファイルを参照する
- 内容は設定のオーバライド
  - 特定パスへのユーザの制限
  - 認証・認可
  - URLリライト
  - ディレクトリオプションの変更
- .htaccessを書けばどんな編集をできるわけではない
- `AllowOverride`によってある程度規制をかけられる
  - `AllowOrverride None` ...何も編集しない
  - `AllowOrverride AuthConfig` ...認証関連
  - `AllowOrverride FileInfo` ...Reqrite/ErrorDocument
  - `AllowOrverride Indexes` ... Options/Indexes
  - `AllowOrverride Limit` ... Require/Allow 
  - `AllowOrverride All`...すべて
- .htacessは`AccessFileName`によって指定されている名前。変更可能

#### Access方式 vs Requireディレクティブ
- Access...Order、Denyとセットで使用する
  - `Order allow deny`...どちらを優先的に処理するか。例ではallowが優先
  - 非定義なIP(allowもdenyもしないIP)は優先されたOrderに準拠する
  - `Allow from 10.0.0.0/8`
  - `Deny from all`
  - `Deny from env=VAR`
- Require...許可するIPのみを指定する
  - `Require ip 192.168.0.0/16`
  - `Require all granted`...全許可
  - `Require all deny`...全拒否
  - `Require ip 192.168.1.0`
  - `Require host example.com` ※ 逆引きDNSでアクセス元を特定
  - `Require user alice` ※ 要認証
  - `Require group admin` ※ 要認証
  - `Require vailid-user` ※ 要認証
  - `Require env ALLOW_ACEESS`
  - `<RequiteAll>`や`<RequoteAny>`を使用して、複数を組み合わせることも可能
  - 特定のモジュールが必要なものもある

#### 認証関係
- AuthType...Basic(base64)/Digest(nonce+hash)から選択できる
  - `AuthType Basic`
- AuthName...認可領域の名前を指定
  - 既定の認可領域。同じサーバでもAuthNameが違えば、別認証として処理
  - クライアントがどの領域ににログインしようとしているのか判断する
  - `AuthName Admin`
- AuthUserFiles...認証に使用するユーザとパスワードが格納されたファイルを指定
- Satisfy...ホストのアクセス制御とユーザ認証両方が指定されればアクセス許可？
  - `Satisfy Any`...アクセス制御かユーザ認証どちらかでOK
  - `Satisfy All`...アクセス制御とユーザ認証双方を要求（デフォルト）

#### apacheにおけるモジュール()
- 方法は以下の2つ
  - apacheに入っているものを探す。
  - ソースからビルドして.soや.dllを作成する
- .so、.dllファイルを指定してインポート
  - `LoadModule {モジュール名} {モジュールのファイル名}`
##### セキュリティ関係のモジュール
- requireで特殊な条件を組み込む際に必要となる
  - mod_authz_core...env,all,method
  - mod_authz_user...user,calod-user
  - mod_authz_host...ip,host,forward-dns,local
  - mod_authz_groupfile...プレーンテキストファイルによるグループ指定
##### ☆セキュリティ関係のモジュール挙動
- mod_authz_*をインポートした場合
  - Requireで動作する
  - Access方式(Order,Allow,Deny)が無効化される
- `mod_authz_compat`があればそ両方動作する(可読性の面で非推奨)

#### SSL方式に関する設定
- 最低限`SSLEngine on`にする必要がある
  - これはサーバ証明書の話
  - これは可能にするだけで、強制ではない
  - 強制はヘッダーによって実施する
- SSLCertificateKeyFile...秘密鍵の場所(公開不可)
  - `SSLCertificateKeyFile /etc/pki/tls/certs/server.crt`
- SSLCertificateFile...公開鍵の場所。CA中間証明書を同封することもある（apache 2.4.8以降）(公開設定必須)
  - `SSLCertificateFile /etc/pli/tls/private/server.key`
  - 同封する場合以下のように記載する


```
-----BEGIN CERTIFICATE-----
（サーバ証明書）
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
（中間CA証明書）
-----END CERTIFICATE-----
```

- クライアント証明書は`SSLVerifyClient`を使用する
  - クライアントに要求するか否かを指定
    - SSLVerifyClient none ... クライアントを要求しない
    - SSLVerifyClient optional ... 要求するが必須としない
    - SSLVerifyClient require ... 証明書を必須とする
    - SSLVerifyClient optional_no_ca ... CA未検証でも受け入れる
  - TLSハンドシェイクで落ちるため、HTTPSステータスコードは戻らない

#### バーチャルホストの利用(VirtualHost)
- 複数の仮想サーバがあるようにみせかける技術
  - サイトの論理分離
  - 設定の切り替え<VirtualHost>句で切り替えが可能
  - 1サーバで複数のサイトを運営する
- 例えばHTTPリクエストのHostヘッダを見て設定を分離する

 ```
 <VirtualHost *:80>
  Require all granted
</VirtualHost>

<VirtualHost *:80>
  Require ip 192.168.0.0/16 *これはリクエスト元
</VirtualHost>
 ```

- 他に以下のような出しわけができる
  - IPアドレス 
    - `<VirtualHost 192.0.2.10:80>`
    - これはサーバ自身のIPを指している
    - ApacheがLinstenしているIP
  - ポート
    - `<VirtualHost *:8080>`
    - これもApacheがこのポートをListenしている必要あり
  - ホスト名 
    - `<VirtualHost *80> ServerName xxx.com`
    - 昔は`NameVirtualHost {IP}`を事前に宣言しなければならなかった
    - 現在は廃止(2.4以降)

#### 暗黙のメインサーバ
- 本来であれば、apacheは（形式上の）仮想サーバを立ててリクエストを処理
- なので、大元となるメインサーバ(httpd)が存在
- Virtualhostが存在する環境では、デフォルトVirtualHostが定義される。
- VirtualHostが一切存在しなければ、リクエストはメインサーバで処理される

#### Virtualhost vs Directory
- Apacheは以下の手順でリクエストを処理する
  - 1. 受信
  - 2. VirtualHostを決定(host/SNI)
  - 3. URL -> ファイルパスへ解決
  - 4. Direvtory / Files /Locationを評価
  - 5. レスポンスを生成
- なので処理優先としてはVirtualHostが優位

#### ログの管理(CustomLog,LogFormat)
- `LogFormat {書式} {file_name}` 
- `CustomLog log/access_log {file_name}`
- filename
  - conbined(Apacheが認識できる名前)
  - common(Apacheが認識できる名前)
- 書式
  - %h ...ホスト名
  - %l ... リモートログ名。通常は`-`
  - %u ...認証ユーザ名
  - %t ...リクエスト時刻
  - %r ...リクエスト行
  - %>s...最終的なHTTPステータスコード
  - %b ...レスポンスバイト数
  - %{Referer}i ... リファラ、どこから来たか
  - %{User-Agent}i ... ブラウザ、クライアント情報
  - %v...リクエストで指定されたHostヘッダ
  - %V...実際に処理したVirtulalHost名
  - %a...実際のクライアントIP
  - %{X-Forwarded-For}i ...プロキシ越しのIP
  - 


### apacheの管理を実行する
- apachectlコマンド、httpdコマンドの双方が使用される
- `apachectl`
  - start...httpdの起動
  - stop...httpdデーモンの停止
  - restart...httpdデーモンの再起動
  - graceful...クライアントの接続完了を待ってhttpdを再起動
  - graceful-stop ... クライアントの接続完了を待ってhttpdを停止
  - configtest ....設定ファイルの書式チェック
  - httpdのラッパーコマンドなので、httpdのコマンドも使える
- `httpd`
  - -t...設定の確認
  - -S...読み込まれる設定ファイル一覧
  - -M...読み込まれているモジュールを一覧表示
  - -v...apacheのバージョン
  - -V...コンパイルの設定
### apacheでユーザ認証するために、アカウント、パスワードを作成する(htpasswd)
- `htpasswd`コマンド
- `htpasswd -c /var/www/htpasswd user1`...ユーザとパスワードを作成
- `htpasswd -D /var/www/htpasswd user1`...削除
- `htpasswd -n ryo`...ユーザエントリを標準出力に表示
  - この出力を.htpasswdなどに保存すれば有効な値として扱われる
  - 例：`testuser:$apr1$abcd1234$eFghIjklMNOpqRstUvwxy/`
    - {ユーザ名}:{パスワードハッシュ}で構成
    - パスワードハッシュは、apr1,salt,hashで構成されている
- .htpasswd
  - ユーザ認証データベース
  - AuthUserFileでファイル名として指定することがある
    - `AuthUserFile /etc/apache2/.htpasswd`


## Nginxについて
- webサーバ、リバースプロキシサーバとしての役割
  - HTTPサーバ
  - FastCGIサーバへのプロキシ
  - HTTPSサーバ絵のリバースプロキシ/LB
  - SMTPおよびPOP3/IMAPへのリバースプロキシ/LB
- 自身でリクエストを処理することもできるし、ロードバランシングもできる
### Nginx設定ファイルの構成
- `/etc/nginx/nginx.conf`で管理
- 階層構造を持つ
- `include /etc/nginx/conf.d/*.conf`とすることが多い
  - `conf.d`配下にサイトごとのファイルを配置したりする。
  - `/etc/nginx/snipets/`で設定を再利用することもできる
- コンテキストと呼ばれる要素によって定義
  - main...全体設定
  - event...接続処理
  - http...HTTP全体
  - server...仮想ホスト
  - location...URI単位の制御
  - stream...TCP/UDP
- 参照はhttpd -> server -> location
- 要素
  - `httpd.`..1個だけ存在する
    - MIME
    - ログフォーマット
    - タイムアウト
    - gzip
    - proxy
    - serverへのInclude文もここ
  - `server`...Virtualhostのような役割
    - listen
    - server_name
    - root....ドキュメントルート
    - index...デフォルトファイル
  - `location {URI}`...Directoryのような感じ
    - root {file}
  - `Stream`
    - HTTP以外をL4でロードバランシングする
#### Nginxのリソース分配
- location単位でreverse proxyを指定できる
- 拡張子、パス単位で振り分けを実施
- 静的配信と動的配信の分離
  - `locaion ~* \.(jpg|png|css|js)$ {proxy_pass {URI}`
- CDN/API/認証サーバの分離

#### プロキシとして利用する際のNginxTLS証明書分配
- TLS終端にNginxを使用することが多い。

```
events {
    worker_connections 1024;
}

http {
    server {
        listen 80;
        server_name localhost; ※ ここの値はDNSではない

        location / {     ※ 要求されているパス名
            ※ 戻す
            root /var/www/html;
            return 200 "nginx is running\n";

        }
    }
}
```


#### Apache vs nginx
- Apache (VitualHost -> Directory)
  - 処理群を限定的に記載していくイメージ
- nginx (Server -> location)
  - 条件と、処理の関係

#### w3m コマンド
- テキストベースのブラウザ
- できること
  - フォームの入力
  - Cookieの送受信
  - Basic認証
- できないこと
  - JSの実行
  - SPAの遷移

#### Nginx Server{Listen}で扱える項目
- default_server...デフォルトサーバに設定
- ssl...SSLを受け付ける
- http2...HHTP/2を受け付ける
- spdy...SPDYを受け付ける
- proxy_protocol...PROXYプロトコルを受け入れる


## Squid
- フォワードプロキシ
- `/etc/squid/squid.conf`を使用
- 設定例

```
# Squid が待ち受けるポート
http_port 3128

# 全てのクライアントを許可（検証用）
acl all src all
http_access allow all

# キャッシュディレクトリ（ufs形式）
cache_dir ufs /var/spool/squid 100 16 256

# キャッシュ管理用ログ
access_log /var/log/squid/access.log
cache_log  /var/log/squid/cache.log
```

### squidにおけるアクセス制御
- 以下の2段階で定義
  - `acl {acl_name} {acl_type} {引数}`
    - acl_nameを指定する
  - `http_access allow|deny {acl_name}|!{acl_name}`
    - acl_nameのアクセスを制御する
- acl_type
  - src...発信元IP
  - dst...宛先IP
  - time...曜日と時刻
  - url_regex...URLの正規表現
  - port...宛先のポート番号
  - proto...転送プロトコル
  - method...HTTPリクエストメソッド
  - proxy_auth...ユーザ認証
- 引数
  - IPの場合、サブネットマスク、及びCIDERを指定可能
  - methodを指定する場合
    - GET
    - POST
    - PUT
    - DELETE
    - HEAD
    - OPTIONS
    - CONNECT
    - 特にCONNECTはHTTPSで使用するためよく使う
- 挙動の原則
  - http_accessが存在しない場合、リクエストは拒否
  - https_accessに一致しない場合、最後のhttp_accessのallow,denyの反対を取る
### squidにおけるキャッシュ管理
- cache_mem...キャッシュサイズの最大値
- cache_dir...キャッシュに関する設定
  - 引数1...キャッシュ方式。ufsが一般
  - 引数2...キャッシュを保管するパス
  - 引数3...領域のサイズ(MB)
  - 引数4...直下のサブディレクトリの個数
  - 引数5...2階層目のサブディレクトリの個数
- maximum_object_size
  - キャッシュに格納されるオブジェクトの最大サイズ

#### CGI vs Redirect
- CGI(Common Gateway Interface)
  - Redirectの比較ではサーバ側で処理を実行する点で異なる
  - 定義としては、リクエストごとに処理を実行してレスポンスを返す
  - 通常のウェブページはファイルをそのまま返す
- Redirect
  - HTTPSコードを戻して、別のサイトにアクセスさせること
  - CGIで実装されているかどうかは関係がない