# DNS

### DNSの仕組み
- クライアントはまず、リゾルバに聞きに行く
- リゾルバは、DNSサーバに聞きに行く
- NSサーバは以下の順序で非再帰問い合わせする
  - ルートDNSサーバ
  - ファーストドメインサーバに問い合わせ
  - セカンドドメインサーバに問い合わせ
  - ...
- DNSサーバから結果を受け取る

### 再帰/非再帰
- クライアントからDNSサーバは、再帰的問い合わせ
  - 結果が戻ってくるまで全てを依頼する
- DNSサーバからのドメインサーバへの問い合わせは非再帰問い合わせ
  - 逐次問い合わせに行く

### DNSサーバ色々
- BIND
- dnsmasq...コンテンツサーバも持つ
- djbdns...IPv6に対応していない
- PowerDNS

### DNS主要なアクション
- 名前解決
  - 各種ゾーンレコードを出し入れ
- ゾーン管理/同期
  - マスターのレコードをスレーブに同期
- DNSSEC
  - 委任の連鎖のやつ
- 動的更新
  - DHCP連携に使う
  - RFC 2136
- フォワーディング
  - 問い合わせを上位DNSに中継する
  - 再帰問い合わせとは別の解決経路制御
- キャッシュ管理
  - TTLで管理される
- 委任・再委任
  - NSレコードによる管理権限の委譲
- 管理・制御
  - `rndc`コマンド


### BIND
- Berkeley Internet Name Domain
- 現在の最新バージョンは9
- BIND9とか呼ばれる
- namedデーモンを立ち上げる
  - /usr/sbin/namedに存在する
  - サービス名はnamed,domain
  - UDP 53番
### BINDの設定ファイル
- `/etc/named.conf`
- ステートメント
  - acl{}
    - アクセスコントロール
  - controls{}
  - options{}
    - named全体の基本動作を定義
    - 色々あるので後で記載
  - zone "." IN{}
    - ルートゾーン
    - ルートDNSサーバの一覧
    - `type hint;`と記載がある
  - zone "{domain}" IN{}
    - 正引きゾーン
    - このDNSが管理するドメインを指す
    - `type master;`と記載がある
    - `file "{zonefile}"`ゾーンファイル名を指定
  - zone "{IP}.in-addr.arpa" IN {}
    - 逆引きゾーン
    - これも`type master;`と記載
### optionsに書く主要なパラメータ
#### ネットワーク・待ち受け系
- `listen-on port PORT {IP,IP...}`
  - IPv4でDNSを待ち受けるIPアドレス
  - 公開DNSではanyを避ける
- `listen-on-v6 {IP}`
  - IPv6
#### 再帰・アクセス制限
- `recursion yes`
  - 再帰問い合わせを許可するか？
  - yesであれば，キャッシュDNSとして動作
  - noであれば，権威DNSとして動作する
- `allow-recursion`
  - allow-recursion {host, IP/prefix}
  - 再帰問い合わせを許可するクライアント
  - これが設定されてないと，open resolverになる
- `allow-query　{any;}`
  - 通常のDNS問い合わせを許可する範囲
  - 権威DNSでは通常any
  - 内部DNSでは制限
- `allow-query-cache {localhost;}`
  - キャッシュ結果への問い合わせ制限
#### ゾーン転送
- `allow-transfer {IP;}`
  - ゾーン転送を許可する相手
  - マスターからスレーブへ転送
- `notify yes`
  - ゾーン更新をスレーブに通知する
  - masterの場合は，yesにする
#### ファイル・ディレクトリ系
- `directory "var/named"`
  - ゾーンファイルの基準ディレクトリ
  - zoneステートメントはこのファイルを見る
- `pid-file "/run/named/named.pid"`
  - PIDファイルの出力先
- `dump-file "/var/named/data/cache_dump.db;"`
  - キャッシュダンプ用
- `statistics-file "/var/named/data/named_stats.txt;"`
  - rndc statsの出力先
#### dnssec関連
- `dnssec-validation yes`
  - DNSSEC署名の検証
  - キャッシュDNSでは必須
- `dns-enable`
  - DNSSEC機能を有効化
- 
#### 性能・動作制御
- `fowarders {8.8.8.8; 1.1.1.1;}`
  - 上位DNSへの転送
  - キャッシュサーバが取得元とする権威サーバ
  - 自分で再帰解決しなくなる
- `forward only| first`
  - only...必ずforwarderを使う
  - first...失敗時は通常の再帰を実施
- `max-cache-size 512M`
  - キャッシュの最大サイズ制限
- `minimal-response yes`
  - 必要最小限の応答。設定しないと長くなる

#### ログ・デバック補助
- `version "9.1"`
  - ダブルクォーテーションで括る
  - 適当な文字列にすると、公開されず、隠蔽ができる
- `querylog yes`
  - 問い合わせログを出力する。負荷が高い
#### セキュリティ関連
- `allow-update { none; }`
  - 動的更新(DDNS)
- `rate-limit{ response-per-second 10;}`
  - リクエストに対して制限を設ける
##### ゾーン転送ってなんや？
- ※ DNSでマスタースレーブする場合，両方とも動作している
  - スレーブは送受信する
  - キャッシュサーバ(キャッシュDNS、再帰リゾルバ)の構成を指しているわけではない
  - キャッシュとは全く別物
- ゾーン転送の手続き
  - 1. マスターのゾーンが更新
  - 2. SOAシリアルが増加
  - 3. マスター → スレーブへ NOTIFY
  - 3.5 スレーブはいくつかの条件をチェックする
  - 4. スレーブ → マスターへ IXFR / AXFR
- AXFR(全転送)，IXFR(差分転送)，NOTIFY(更新通知)がシグナル
- NOTIFY
  - マスタからの変更通知
- AXFR
  - フルゾーン転送とも
- IXFR
  - 変更された分だけを転送する
  - マスターは差分ログを管理している

#### SOAレコード、SOA serial
- SOA...Start of Authority
  - SOA serialはここに含まれる
  - SOA refrshなどの寿命を迎えるまでの世代番号
- マスターの役割を持つDNSは更新が入ると、SOA serialを増やす
  - bindが自動で更新してくれることもあるが、要確認
  - ゾーンファイルが静的であれば、ゾーンファイル中のSOAレコードは更新しない
  - ここでスレーブにNOTIFYを送信

#### スレーブがNOTIFYを受け取ったらすること
- 1. 受信。NOTIFYもUDP53番を使用する
- 2. 設定ファイル`/etc/named.conf`を見て、master{}項にそのDNSがあるか見る
- 3. スレーブがSOAを受信すると、受信したSOAと自身のSOAを比較。小さい場合、以下を実行
- 4. masterに問い合わせる。その時に現在の自分のSOAを送信する
- 5. masterはIXFR(差分のみ)を送信。
- 6. 差分不可の場合、masterはAXFR(全部)送信

- ※ NOTIFYは誰でも送れる。ただし、受信側はmaster{}、TSIGで判断が入る
- ※ 差分不可...マスターが差分を作成できない
  - serialが古すぎる。ログの管理が浅い。
  - IXFRできない状態
- ※ スレーブのゾーン破棄
  - ゾーン情報を無効化し、権威応答を停止する

#### ゾーンの権威DNSの問い合わせの分配
- キャッシュDNSから見る(問い合わせ元から見る)
  - NSレコードが複数書かれているのは、マスタとスレーブが書かれている。
    - どちらかは区別しないので、キャッシュDNSはどっちがどっちか知らない
  - ここに優先度は無いので、どちらかに問い合わせを実行する
  - `SERVFAIL`というステータスを送るため、問い合わせは失敗
  - ここで他のNSへ問い合わせ

#### Q. /etc/named.confのnotify とallow-transferの区分け
- ゾーン転送に関する設定なのになぜ分かれている？
- 基本は両方マスターの設定に入っているもの
  - notifyは、マスターからスレーブのnotify送信の可否
  - allow-transferはAXFR,IXFRの応答先IPの制限
    - 言い換えると、送られてきたAXFR,IXFR要求に応答する先の制限
    - この設定を失敗すると、ゾーン情報が流出する
    - `dig AXFR ~`などと送ってやればゾーンが返ってきてしまう。

#### forward only, foward firstってなんや？
- キャッシュDNSの挙動を定義
  - キャッシュでの解決に失敗した場合にどうするのかを定義する
- forward only...フォワーダに設定したDNSに問い合わせ
  - 自身でドメインの文字列から権威DNSに解決を実行しようとしない
- forward first...フォワーダに問い合わせを実行。
  - 失敗した場合は、自身で権威DNSに問い合わせを開始する

#### キャッシュのみからの応答に限定する
- master/slave双方を持たない
- type hint; のみ設定し、options{forward only}にする

## コマンド類

### DNS設定が上手くいっているか見る
- `named-checkconf`
  - `/etc/named.conf`の設定がうまくいっているかを見る


### nslookup
- dnsへの問い合わせ
  - dnsを指定しない場合、`/etc/nsswitch.conf`を参照
- `nslookup www.google.com`
- 応答例

```
Server:         192.168.1.1     # 問い合わせ先
Address:        192.168.1.1#53  

Non-authoritative answer:       # 権威DNSでない
Name:   www.example.com
Address: 93.184.216.34          # Aレコードの結果
```

- `nsloopkup 10.2.2.2`...逆引きも可能
- オプション
  - `-t`
    - `nslookup -type=SOA google.com`
    - 応答のレコードを指定する
  - `-recurse`
    - `nslookup -norecurse`
    - 再帰問い合わせをしない
      - キャッシュに結果がなければ落ちる  
### host
- dnsへの問い合わせ
- オプション
- `host -t MX`
  - レコードの指定
- `host -v google.com`
  - 詳細を表示する
- `host -d google.com`
  - digで実行する

### dig
- `dig [@dns] host/domain/IP [type]`
- オプション
  - `-x`...IPアドレスから逆引きする
  - `-p {port}`...(53以外の)問い合わせ先のポートを指定
  - `@サーバ名`...問い合わせするサーバを指定する
  - `-t {type}`...オプションでも指定できる
  - `+recurse`...問い合わせ先に再帰問い合わせさせる
  - `+short`...結果を簡素にする
- typeに使用できる文字
  - a...ホスト名に対応するIP
  - ptr...IPアドレスに対応する
  - ns...DNSサーバ
  - mx...メールサーバ
  - soa...SOAレコード情報
  - hinfo...ホスト情報
  - axfr...ゾーン転送
  - txt...任意の文字列
  - any...全ての情報


### digからのレスポンス
- レスポンスのセクション
  - Header...各種レスポンスの数と問い合わせのフラグを表示
  - Question Section...クライアントからの問い合わせの内容
  - Answer Section...サーバからの回答
  - Authority Section...問い合わせたゾーンについての権限を有するサーバの情報
  - Additional Section...非再帰問い合わせに対するサーバの回答など
#### Header sectionの読み方
- フラッグが設定されている
  - DNSメッセージの制御情報。12種ある
- フラッグ名称
  - qr...Query
  - aa...Authoriative Answer
  - tc...Truncated
  - rd...Recursion Desired
  - ra...Recursion Avalable
  - ad...Authentic Data
  - cd...Checking Disabled
- フラッグ詳細
  - qr...問い合わせ:0、応答は1。digの応答結果は普通1
  - aa...権威サーバからの応答
  - tc...UDPサイズオーバによるデータ切り詰めが発生
  - rd...digが再帰要求するか。digコマンドでは普通フラッグを立てる
    - +norecurseすると、立たない。
    - digの実行体が要求しているということ。応答サーバが要求しているわけではない
  - ra...再帰可能。このDNSは再帰問い合わせ可能。キャッシュDNSでON
  - ad...DNSSEC検証済み
  - cd...DNSSECを検証しないで返すことを要求

- ステータスも戻ってくる
 - RCODE(Reponse Code)の応答名
 - NOERROR...正常
 - NXDOMAIN...名称不存在
 - SERVFAIL...サーバ障害
 - REFUSED...拒否
 - FORMERR...形式エラー
 - NOTIMP...も実装


### hostname -d
- 現在のホストが所属しているDNSドメイン名
- /etc/resolv.confを参照する
  - 現在のFQDN
  - `/etc/hostname`
  - `/etc/hosts`を参照する

### 自身をFQDNに登録するとは?ホスト名との違い
- グローバル環境下でメールやwebを公開する場合にしよう
- `hostname`に使用される。`sethostname`で変更できる
- 以下のケースで必要になることがある
  - メールを受信する
  - TLS証明書を使用する
  - LDAPを使用する
  - ログ、監視、分散システム上必要
### ドメイン購入した後って何してる？
- NSレコードは購入先に書く（registorerと呼ぶ）
  - これはTLDのDNSに書きに行っている
  - ICANNがレジストラ登録機関を管理
    - お名前ドットコムなど
- 権威DNS(Route53)に正引レコードを書く

### 権威DNSって再帰問い合わせしてもいいんじゃない？
- 原則はしない。
- BINDでは設定すれば可能
- 非常に動作が重いため

## ゾーンファイルそのものの設定
#### ゾーンファイルの配置
- `/etc/named.conf`のzone{}中のfileステートメントで定義する
- 例：

```
zone "sample.com" IN{
  type master;
  file "zone.com.zone"
 };
```

- ディレクトリに関しては、/etc/named.confのoptionsで指定する
- 例：
```
options{
  directory "/var/named"
}
```

#### 主要なゾーンファイルの概要
- typeがhintの場合
  - 権威DNSサーバが問い合わせに使用するTDLサーバ
  - この場合、fileに指定する内容形式化されている
  - `named.ca`とよく命名されてデフォルトで配置されている
    - DNSルートサーバのNSレコード、A,AAAAレコードが書いてある
- typeがmasterの場合
  - 管理者が編集する正本ゾーン
  - レコードに関しては色々あるので後述
- typeがslaveの場合
  - masterによって更新されるファイルの場所を指定する


#### allow-updateについて
- DHCPの話。masterがDHCPによって更新されるかどうか

### ゾーンファイルの詳細
- 構成（ディレクトリと呼ばれる）
  - ORIGIN
  - TTL
  - SOA(必須)
  - NS(必須)
  - 各種リソースレコード
    - A/AAAA
    - MX
    - CNAME
    - TXT
    - PTR
- ※ セミコロン以降はコメントとして扱う
- 例：

```
$ORIGIN example.com.
$TTL 3600
@   IN SOA ns1.example.com. admin.example.com. (
        2025010101 ; serial
        3600       ; refresh
        900        ; retry
        604800     ; expire
        3600 )     ; minimum

    IN NS  ns1.example.com.
    IN NS  ns2.example.com.

ns1 IN A   192.0.2.10
ns2 IN A   192.0.2.11

www IN A   192.0.2.20
mail IN A  192.0.2.30

@   IN MX  10 mail.example.com.

@   IN TXT "v=spf1 ip4:192.0.2.30 -all"
```

- ORIGIN
  - ゾーンファイル内でのサフィックス
  - 各種リソースレコードに対するドメイン部を設定することが多い
  - 以降、`@`で示されているのは、ここのサフィックス全てを指す
- TTL
  - キャッシュ有効時間
- SOA(start of Authority)
  - 冒頭 1つめのドメイン...プライマリDNS
  - 2つめのドメイン...管理者のメール
  - serial...SOAシリアル。ゾーンのバージョン
  - refresh...slaveが更新確認する間隔
  - retry...失敗時の再試行間隔
  - expire...slaveがゾーンファイルを破棄するまでの時間
  - minimum...
    - ネガティブキャッシュTTL。
    - 何も設定されていない場合のリソースレコードのTTL
    - 失敗した問い合わせ（キャッシュ）の生存時間
- NS
  - このゾーンの権威DNSサーバ
  - マスタースレーブの区別は書かない
  - ゾーンファイルを編集する場合、ほとんどの場合で自身を指す。
    - そうしないと、NSから更新されて無意味
- MX
  - メールの配信先を指定。数字は優先度を示す
- TXT
  - DKIM,DMARCを記載する際に使用する
  - メールのSPFもここ

#### ORIGINの配置
- FQDNの保管に使用する
  - 各レコードの右側に追記する
  - ただし、レコードの結合のために使用する「.」
  - FQDNはドットで終わると覚える
- ORIGINレコードの途中でORIGINが変更になっても良い
  - ORIGINから次のORIGINが書かれるまでが有効範囲
- ORIGINを参照しない場合は、最後にドットを書く
  - `example.com. IN A 192.168.20.1`
- ゾーンファイル外からのORGIN設定
  - `/etc/named.conf`によって定義もできる
  - `zone "example.com" { }` ... このexample.comの部分
#### TTLの配置
- 1. ファイルの先頭からSOAが始まるまで
  - 全体の設定として扱われる
- 2. リソースレコードの第二引数に記載
  - `www 360 IN A 192.0.2.10`
- 3. 指定しない
  - minimumが全体の生存期間になる

###　DNS応答
- 0... NOERROR ... 正常
- 3... NXDOMAIN ... 名前が存在しない
- 2... SERVFAIL ... サーバ内部エラー
- 5... REUSED ... 拒否

### NXDOMAINに関して
- 自身が保有するゾーンファイルに存在しない
- なので、権威サーバがその情報がないことが確認できている
- 「保有していないという情報」をキャッシュ
  - この生存時間をminimumに依存

### MXレコード
- 基本は配送先を指定する
  - `example.com. IN MX 10 mail.example.com.`
  - example.com宛のメールはmail.example.comに配送する
  - 10は優先度
  - 普通はここにAレコードを追記して使う
  - `mail.example.com. IN A 192.145.1.1`
- メール配送はAレコードだけでも成立する
  - `mail.expamle.com IN A 192.23.3.3`
- じゃあなんでMXレコードがあるの？
  - webと同じドメインを設定しても、MXによって名前を変更できる
  - 優先度が存在するため、フェールオーバが可能
- CNAMEとどう違うの？
  - CNAMEは全ての用途のアクセスに対して別名を使用する
  - 変更したあとは、変更する前の名称は使用できない
  - MXした後はCNAMEしてはいけない

### ゾーンファイルの設定がうまくいっているかを見る
- `named-compilezone`
  - 高速化を考慮したゾーンファイルに書き換えてくれる
- `named-checkzone`


## DNSを管理するコマンド
### rndc
- remote name daemon control
- 構文
  - rndc status...namedステータス表示
  - rndc stop...named停止
  - rndc reload...設定ファイル/etc/named.confの再読み込み
  - rndc refresh...セカンダリに対してマスターに問い合わせさせる
  - rndc reload {zone_name}...指定ゾーンだけを再読み込みする
  - rndc dumpdb...キャッシュ内容をダンプする


### TSIG
- Transation Signature
- トランザクション署名
- DNS同士(マスタ、スレーブ)の通信を保護する
  - 「ゾーン変更したよー」に対する担保
- 時刻+送信内容+共通鍵のハッシュ(HAMC)を作成して同封する
- アルゴリズムと共通鍵自体は受信側で同じものを保有しているので合致する
- 担保
  - 正規のデータの改竄の防止(完全性)
  - 送信先の担保(正当性)
  - 時刻を同封するので、リプレイ耐性もある
- 暗号アルゴリズムにHMAC-MD5を使用する

### DNSSEC
- DNSゾーン情報が正常なゾーン情報であることを検証する
- 作成
  - ZSK(ZSK:Zone Signing Key)
    - 権威リゾルバはキーペア作成(ZSK)
      - 公開鍵をDNSKEYとしてレコード公開
    - 公開しているDNSKEYを含めたリソースセットに対して秘密鍵で署名
      - RRSIGとして公開
  - KSK(Keys Signing Key)
    - 権威リゾルバはキーペア作成(KSK)
      - 公開鍵をDNSKEYとしてレコード公開
    - DNSKEYの全レコードを秘密鍵で署名
      - RRSIGとして公開
    - 公開鍵をハッシュ化してDSを作成する
      - 親サーバに送り、公開してもらう。
- リゾルバによる検証
  - 1. 親サーバからDS,そのサーバからKSKを受信
  - 2. ハッシュ関数はわかっているので、検証可能
  - 3. DNSKEY署名のRRSIGと、KSK公開鍵から署名検証
  - 4. DNSKEY欄が正しいとわかる
  - 5. 各リソースセットの署名のRRSIGと、ZSK公開鍵から署名検証
  - 6. 全レコードの真正性が正しいとわかる

- 担保
  - データの真正性
  - 改ざん検出
  - なりすまし防止

#### ZSKは自己証明では？
- 大枠でKSKで署名されているため、正しいレコードと言える

#### 鍵生成コマンド
- TSIGも、DNSSECも同じコマンド
- `dns-keygen`
- オプション
  - -a...暗号化アルゴリズムを指定する
  - -b...生成する鍵のビット長を指定する
  - -n...キーのオーナタイプを指定
- 指定可能な暗号化アルゴリズム
  - 秘密鍵・公開鍵
    - RSASHA256,RSASHA512,DSAなどなど
    - 最大2048bitを生成可能
  - 共有秘密鍵（TSIGはこれを使用する）
    - HMAC-MD5(1-512bit)
      - ここで生成されるのはただの乱数文字列
- オーナータイプとは？
  - どこでしようするか
    - TSIGの場合は、host
    - DNSSECの場合は、Zone


### dnssec-signzone
- ZSKとKSKのそれぞれのキーペアを使用
- RRSIG, DNSKEY, NSE、DS(親に送付する用途)を生成