# DNS

### DNSの仕組み
- クライアントはまず、リゾルバに聞きに行く
- リゾルバは、DNSサーバに聞きに行く
- NSサーバは以下の順序で非再帰問い合わせする
  - ルートDNSサーバ
  - ファーストドメインサーバに問い合わせ
  - セカンドドメインサーバに問い合わせ
  - ...
- DNSサーバから結果を受け取る

### 再帰/非再帰
- クライアントからDNSサーバは、再帰的問い合わせ
  - 結果が戻ってくるまで全てを依頼する
- DNSサーバからのドメインサーバへの問い合わせは非再帰問い合わせ
  - 逐次問い合わせに行く

### DNSサーバ色々
- BIND
- dnsmasq...コンテンツサーバも持つ
- djbdns...IPv6に対応していない
- PowerDNS

### DNS主要なアクション
- 名前解決
  - 各種ゾーンレコードを出し入れ
- ゾーン管理/同期
  - マスターのレコードをスレーブに同期
- DNSSEC
  - 委任の連鎖のやつ
- 動的更新
  - DHCP連携に使う
  - RFC 2136
- フォワーディング
  - 問い合わせを上位DNSに中継する
  - 再帰問い合わせとは別の解決経路制御
- キャッシュ管理
  - TTLで管理される
- 委任・再委任
  - NSレコードによる管理権限の委譲
- 管理・制御


### BIND
- berkeley Internet Name Domain
- 現在の最新バージョンは9
- BIND9とか呼ばれる
- namedデーモンを立ち上げる
  - /usr/sbin/namedに存在する
  - サービス名はnamed,domain
  - UDP 53番
### BINDの設定ファイル
- `/etc/named.conf`
- ステートメント
  - acl{}
    - アクセスコントロール
  - controls{}
  - options{}
    - named全体の基本動作を定義
    - 色々あるので後で記載
  - zone "." IN{}
    - ルートゾーン
    - ルートDNSサーバの一覧
    - `type hint;`と記載がある
  - zone "{domain}" IN{}
    - 正引きゾーン
    - このDNSが管理するドメインを指す
    - `type master;`と記載がある
    - `file "{zonefile}"`ゾーンファイル名を指定
  - zone "{IP}.in-addr.arpa" IN {}
    - 逆引きゾーン
    - これも`type master;`と記載
### optionに書く主要なパラメータ
#### ネットワーク・待ち受け系
- `listen-on port PORT {IP,IP...}`
  - IPv4でDNSを待ち受けるIPアドレス
  - 公開DNSではanyを避ける
- `listen-on-v6 {IP}`
  - IPv6
#### 再帰・アクセス制限
- `recursion yes`
  - 再帰問い合わせを許可するか？
  - yesであれば，キャッシュDNSとして動作
  - noであれば，権威DNSとして動作する
- `allow-recursion`
  - allow-recursion {host, IP/prefix}
  - 再帰問い合わせを許可するクライアント
  - これが設定されてないと，open resolverになる
- `allow-query　{any;}`
  - 通常のDNS問い合わせを許可する範囲
  - 権威DNSでは通常any
  - 内部DNSでは制限
- `allow-query-cache {localhost;}`
  - キャッシュ結果への問い合わせ制限
#### ゾーン転送
- `allow-transfer {IP;}`
  - ゾーン転送を許可する相手
  - マスターからスレーブへ転送
- `notify yes`
  - ゾーン更新をスレーブに通知する
  - masterの場合は，yesにする
#### ファイル・ディレクトリ系
- `directory "var/named"`
  - ゾーンファイルの基準ディレクトリ
- `pid-file "/run/named/named.pid"`
  - PIDファイルの出力先
- `dump-file "/var/named/data/cache_dump.db;"`
  - キャッシュダンプ用
- `statistics-file "/var/named/data/named_stats.txt;"`
  - rndc statsの出力先
#### dnssec関連
- `dnssec-validation yes`
  - DNSSEC署名の検証
  - キャッシュDNSでは必須
- `dns-enable`
  - DNSSEC機能を有効化
- 
#### 性能・動作制御
- `fowarders {8.8.8.8; 1.1.1.1;}`
  - 上位DNSへの転送
- `forward only| first`
  - only...必ずforwarderを使う
  - first...失敗時は通常の再帰を実施
##### ゾーン転送ってなんや？
- ※DNSのマスタースレーブは，両方とも動作している
  - 1. マスターのゾーンが更新
  - 2. SOAシリアルが増加
  - 3. マスター → スレーブへ NOTIFY
  - 4. スレーブ → マスターへ IXFR / AXFR
- AXFR(全転送)，IXFR(差分転送)，NOTIFY(更新通知)がシグナル


### DNS設定が上手くいっているか見る
- `named-checkconf`



### ドメイン購入した後って何してる？
- NSレコードは購入先に書く（registorerと呼ぶ）
  - これはTLDのDNSに書きに行っている
  - ICANNがレジストラ登録機関を管理
    - お名前ドットコムなど
- 権威DNS(Route53)に正引レコードを書く