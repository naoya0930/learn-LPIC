# デバイスとファイルシステム
### VFS?LFB?
#### VFS
  - Virtual File System
  - ファイルシステム抽象レイヤ
  - Systemcall(Open,read)を関数した場合にフォーマットに依存しないために存在するシステム
  - ファイルシステムの操作を実施
#### LFB
- Linux Filesystem Base
- これは階層の例
#### ファイルシステムの情報
- `/etc/fstab`ファイル例
- これは設定ファイル
  - 1. デバイスファイル/ラベル/UUID/
  - 2. マウントポイント
    - そのディスクをどこにマウントするか
  - 3. ファイルシステムの種類
    - ディスクのフォーマット`ext`等
  - 4. マウントオプション
    - roとかのオプション
  - 5. dumpの対象
    - 0を指定すると、dumpによるバックアップの対象外
  - 6. ブート時にfsckがチェックする順序
    - 0はチェックなし、1,2,3..の順でチェック
- moount -a とか fsck -A で参照される

#### UUIDを取得する
- 以下から取得できる
- `blkid`
- `ls -l /dev/disk/by-uuid/`
#### UUIDを設定する
- `tune2fs -U "uuidgen" /dev/sda1`


#### 【備忘】マウントオプション
- async/sync...アクセスを同期/非同期で実行
- atime...ファイルへのアクセスごとにinodeのアクセス時間を更新
- relatime...atimeが他のアクセス時刻より古ければ更新
- noatime..atimeを更新しない
- auto/noauto...mount -aでマウントするかどうか
- default...デフォルトの設定でマウント
- dev/nodev...ファイルシステムへのアクセスを禁止する
- group...デバイスファイルのグループ権を参照してマウントを許可する
- exe/noexe...バイナリ実行の可否
- suid/nosuid...SUID、SGIDビットを無効化する
- ro/rw...読み出し、書き出し専用でマウント
- uid=/gid=...内容を指定したUID、GIDにする(対応formatのみ)
- user...一般ユーザのマウントを許可。マウント者のみ取り外し
- users...一般ユーザのマウント許可。誰でも取り外し可能
- nouser...一般ユーザのマウント禁止
- owner...デバイスファイルの所有者によるマウントを許可

#### 備忘の備忘
- mtime....modify time。内容を更新したときに更新
- ctime...change time。権限などのメタデータを更新
- atime...accesstime。読み取った時刻で更新

#### 現在のmount状態を取得する
- mount...現在マウントしているファイルシステムの一覧
- /etc/mtab
  - 以下の順で表示
  - `デバイス名、マウントポイント、ファイルシステム、オプション、dump, fsck`
- /proc/mount でもほとんど同じ
- /etc/fstab...これはデフォルトのマウント情報を扱う
#### mountコマンド
- -a.../etc/fstabの設定の通りマウント。
- -f....etc/mtabの情報だけを書き換える。実際にはマウントしない
- -o {option} {dev}...マウントオプションの指定
  - -o remount...再マウント
  - -o noexec...バイナリの実行を許可しない
  - -o nosuid...SUID/SGIDを無効
  - -o loop...ループバックマウント(イメージファイルのマウント)
  - -o ro ....読み取り専用
- -n... /etc/mtabにマウント情報を書き込まない
- -r/-w... 読み取り専用/書き込み専用マウント
- -t {type} ファイルシステムを指定する
#### アンマウント
- umaunt -a.../etc/mtabで指定されているファイルシステムをアンマウント
- umaunt -t...指定した種類のファイルシステムのみアンマウント
### syncコマンド
- 書き込み指示をバッファメモリディスクに反映する
### スワップ
- 使用していないデバイスに対して実行する
- マウントしていないデバイスをスワップ領域とする
- スワップ用にデバイスが構成される
- `mkswap {dev}`
  - `-c`...作成と同時に不良ブロックを検出
  - `-L {lavel}`...ラベルを作成
### スワップをマウント/スワップをアンマウント
- マウント
  - `swapon`
    - -a.../etc/fstabのスワップを全て有効にする
    - -s...スワップ流域を表示
- スワップを表示
  - `cat /proc/swaps`
- スワップを解除
- `swapoff`
  - -s .../etc/fstabに記載のスワップをすべて無効化
- 厳密にはVFSに使用されるわけではないので、「マウント」という言葉ではない

## ファイルシステムの作成
### ext2/ext3/ext4の作成
- 静的iノード番号が存在する
- mke2fs {dev}
  - -b...ブロックサイズをバイト単位で指定する
  - -c...ファイルシステム作成前に不良ブロックの検知を実施
  - -i...ext3ファイルシステムを作成する
  - -m {領域%}...rootユーザ用の予約領域を%単位で指定する
  - -n...実際には何もしない(パラメータ確認)
  - -t {type}...ファイルシステムの種類を指定(ext2, ext3, ext4)
    - 実際はmkfs.exrXを呼び出している
  - -j ...ext3で作成する
- mk2fsデフォルトファイル
  - `/etc/mke2fs.conf`
  - 
### ext4
- mkfs.ext4でも構築可能
- `mkfs.ext4 {dev}`
### extフォーマットとは？
- Extended Filesystemの略
- ext2...ジャーナリングシステムなし．フラッシュメモリ，USBで使用される
- ext3...ジャーナルシステムがある．ファイルシステムの変更をログに吐く
- ext4...チェックサム，大容量対応．ブロック最適化
#### ext4のすごい所
- 最大ファイルサイズが16TB
- 最大ファイルシステムサイズが1EB
- iノード管理がエクステント方式に変更
  - 開始ノードから，何個のノードがそのデータなのか記載する方式
- オンラインデフラグ
  - ファイル断面化の解消
- たいむすたんぷ詳細化
  - ナノ時間をメモ可能
- マルチブロック割り当て
  - 一度に複数のブロックの割り当てが可能になった
- ジャーネルチェックサム
  - ジャーナリングの信頼性の向上
- fsck高速化
  - 未使用iノードのチェックをスキップする
### XFSファイルシステムの作成
- 今はRedHat管理に移譲されている
- ファイルシステムとしては，8EBまで対応
  - 最大ボリュームサイズ，最大ファイルサイズが8EB
- `mkfs.xfs {dev}`で実行可能
- 即時拡張可能
### Btrfsファイルシステムの作成
- 今はopenSUSに移譲されている
- ファイルシステムにRAIDが内蔵されている．
  - 0,1,10,5,6
- 拡張とリサイズがオンラインでできる

### `mkfs`コマンドによるファイルシステム作成
- mkfs dev
- mke2fsよりもたくさんのファイルシステムに対応している
- オプション
  - -t {type}...ファイルシステムの種類を指定
  - -c...不良ブロックチェック
  - -V...詳細情報を表示
- type
  - ext2/3/4
  - XFS
  - Btrfs
  - FAT/VFAT
  - MINIX FS
### `mkisofs`CD/DVDの作成
- ISO9660の仕様
  - ファイル名は大文字8文字，拡張子3文字とアンダーバーだけ
  - これに対応しているのが，RockBridge拡張
- `mkisofs {dev}`
  - -b...bootableCDにする．(EI torio形式)
  - -o...ISO9660/UDF イメージファイルを指定する
  - -J...Jolietフォーマット(Micorosoft系OS)
  - -R,-r RockBridgeフォーマット(ロングファイルネーム対応)
  - -T...RockBridgeフォーマットが使えない状況で使用するTRANS.TBL
  - -udf...UDFイメージを作成する
### 暗号化ファイルシステムの作成
- デバイスに対して暗号化を実施する
- 1. 物理ディスクをパーティションを切る
- 2. パーティションに対してcryptsetup暗号化を実施
  - 移行，デバイスではなくマッパー(/dev/mapper/{name})でアクセス
- 3. パスフレーズの設定
- 4. mkfsでファイルシステムを作成．
- 5. mountを実施
- `cryptsetup create {name} {dev}`
  - 暗号化する．マウント前に実行する．
  - 具体的には，ヘッダに共通鍵を配置し，パスフレーズで保護する
- `cryptsetup remove {name or name}`
  - カーネル上に存在する共通鍵を破棄する
  - 再度アクセスするためには，ディスクから共通鍵を読み取る
    - このアクセスにはパスフレーズが必要
## ファイルシステムの保守
### ext2/ext3ファイルシステムの構造
- ブロック単位で管理している
  - 1ブロックあたりの構成は，1024,2048,4096バイトから決定
- ディスクの構造
  - MBRがディスク先頭にあり,100個以上の複数のブロックループが続く
- ブロックループの構造
  - スーパーブロック，iノードブロック，データブロックで構成
  - スーパーブロック...データブロックサイズ，マウント回数，iノード，データブロックの数．冗長性の担保のため，全てのブロックループに同じ情報が引っ付いている
  - iノードブロック...128バイトのデータブロック説明
  - データブロック...内容
#### スーパーブロックの内容
- 最近のブロックループは全てのブロックにスーパーブロックはおかない．
  - Sparse Superblockと呼ぶ
- mke2fsのドライ実行で，どこにスーパブロックが置かれるのか計算できる
  - `mk2fs -b 4096 -cj -n {dev}`...これでドライ実行できる
- dump2fsでもいける
  - dumpe2fs {device}
- 閲覧可能な内容
  - Filesystem volume name ... ファイルシステムのボリュームラベル
  - filesystem UUID...UUID
  - Inode count... Iノード数
  - Block count...ブロック数
  - Reserved Block count...予約ブロック数
  - Free blocks...空きブロック数
  - First Block...デバイス上の最初のブロック番号(ほとんどの場合0)
  - Block size...1つあたりのブロックサイズ（バイト）
### ファイルシステムのチェック
#### fsck
- fsck {device}
- アンマウントされている，もしくは読み取り専用のディスクの修復を実施
- オプション
  - -r...対話的に修復を実施
  - -t {タイプ}...ファイルシステムの種類を指定
  - -A.../etc/fstabの設定の通りに実行する
  - -N...ドライ実行

#### e2fsck
- e2fsck {dev}
  - extシステムのチェック
- オプション
  - -b {block}...指定したスーパブロックのバックアップを使って復元
  - -c...不良ブロック検出
  - -f...ファイルシステムの状態がcleanでもチェック
  - -p...すべての不良ブロックを自動的に修復
  - -y/-n...問い合わせに対し自動的にyes,no
#### e2fsckディスクステータス
- clean...安全にアンマウントされた
- dirty...安全にアンマウントされなかった
  - 強制的な抜き差しなど
- 



### ext2/ext3/ext4ファイルシステムの管理
- tune2fs {dev}
- オプション
  - -c {cnt}...チェックが行われるまでのマウントのカウント数(0ならチェックナシ)
  - -C {cnt}...現在のマウント回数を設定する
  - -i {interval}...ファイルシステムチェックの間隔を指定する(0なら指定なし)
  - -j...ext2から3編の変更
  - -m {領域%}...rootユーザ用の予約領域サイズの変更
  - -l...スーパーブロックの内容を表示
  - -L {ラベル}...ファイルシステムのボリュームラベルを設定
  - -U {UUID}...設定したUUIDに変更
#### badblocks
- デバイスの不良ブロック検出
- badblocks {devicefile}
  - -b {size}...ブロックサイズを指定する（バイト）
  - -o {filename}...指定したファイルに結果を出力
  - -w...書き込みモードテスト

#### debugfs
- ファイルシステムの対話的な解消
- 低レイヤーでありながら、ファイルシステムを認識できる
  - ext系のフォーマットのみに対応している
- 用途
  - ファイルの破損調査
  - 内部構造の理解
  - 削除ファイルの復旧
  - e2fsckが完了しない場合のリカバリ
  - iノードの手動修復
  - ディレクトリのエントリの修正
- オプション
  - -w...ファイルシステムを読み書き可能なモードで開く(デフォルトは読み取り専用)
  - -s {ブロック番号}...指定したブロックをスーパーブロックとして利用する
- サブコマンド
  - cat {filename}...ファイルの内容を表示
  - cd {dir}...別のディレクトリへ移動
  - chroot {dir}...ルートディレクトリへ移動
  - close...ファイルシステムを閉じる
  - dump {A} {B}...ファイルAの内容をBとして保存する
  - freei {ファイル}...ファイルのiノードを削除
  - ls..ファイルの一覧を表示
  - mkdir {name}...ディレクトリ作成
  - open {dev}...ファイルシステムを開く
  - pwd...カレントを出力
  - rm {file}...ファイルを削除
  - rmdir {dir}...ディレクトリを削除
  - stat {filename}...iノードの内容を表示
  - quit...終了
### S.M.A.R.T.
- Self-Monitoring, Analysus and Reporting Technology System
- ハードウェアに組み込まれている自己診断機能の総称
- いろんな情報をハードディスクのファームウェア領域に保持、更新する
  - Power-On Hours...通電時間
  - Power Cycle Count...電源 ON/OFF
  - Reallocated Sector Count...代替セクタ数
  - Current Pending Sector Count...要再配置セクタ
  - UDMA CRC Error Count...ケーブル不要回数
  - Temperature
#### smartctl
- S.M.A.R.T情報をディスクから読み出す
- smartdデーモンがハードディスクのSMARTを読み出す
- `smartctl {/dev}`
- オプション
  - -a...S.M.A.R.T情報を取得
  - -t [short/long]...セルフテストを実施
    - short,longでテストを実行させることができる
  - -l [error|selftest|sataphy]... logタイプを指定
    - エラーログ、自己診断結果、SATA PHYエラーを出力
  - -H...状態を表示
    - Health(全体健康状態を表示)
### XFSファイルシステムの管理
#### xfs_admin
- `xfs_admin {dev}`
- xfsファイルシステムに対してパラメータ設定が可能
- ただし、マウント中にラベルやUUDIの変更は弾かれる
- オプション
  - -u ...UUODを表示する
  - -l ...ラベルを表示する
  - -L {lavel}...ラベルを設定する
  - -U {UUID}...UUIDを設定する
- ※ tune2fsはマウント中に実行できる
#### xfs_info
- `xfs_info {dev}`
- デバイスの情報を表示
#### xfs バックアップの考え方
- xfsdumpが実行されると、セッション（セッションIDとセッションラベル）を作成
  - 複数のdumpファイルがある場合、リストア対象のセッションを明示しないとリストア不可
- 1セッションに対して1つのdumpファイルというわけではない
  - 1ファイルに対して複数のセッションを書き込む
  - 1セッションでも複数のdumpファイルに分けることもできる
- バックアップはセッションIDとセッションラベルでユニーク
#### xfsdump
- `xfsdump {filesystem_name}`
- xfsファイルシステムをダンプする
- バックアップとして使用可能
- オプション
  - -f...出力先の指定
  - -l...ダンプレベルの指定(0で全量、1~9でマイナス1レベルから差分バックアップ)
    - これは、dumpの範囲なので、sessionIDとは別の概念
  - -J...ダンプ情報DBを更新しない(差分バックする場合のフラグ)
  - -L セッションラベルを指定
  - ※ sessionIDはxdumpが自動的に見てくれる

### xfsresore
- ジャーナルの整合性を考慮してバックアップイメージから復元を実施
- `xfsrestore {fixing_filename}`
- -f {file}...バックアップファイルの指定。デバイスも指定できる
- -S {sessionID}...リストアするセッションIDを設定
- -L {session_lavel}...リストアするセッションラベルを指定
- -r...最新のセッションIDの増分バックアップを使用
- -i...対話的にリストア
- -I {dumpfile}...全てのダンプのセッションIDとセッションラベルを表示
### Btrfsファイルシステムの管理
- B-tree File System
- 概要
  - コピー操作を優先して空きスペースに置き、スナップショットを作成しやすくする
    - コピーオンライト(COW)と呼ぶ
  - サブボリューム
  - チェックサムを実行
  - RAIDをファイルシステムでサポート
- btrfsコマンドで管理できる
- コマンド
- `btrfs filesystem {command}`
  - show...ファイルシステムの情報を表示
  - df...ファイルシステムの使用状況を表示
  - lebel...ファイルシステムにラベルを設定
  - resize...ファイルシステムのサイズを変更
- `btrfs subvolume {command}`
  - create...サブボリュームを作成
  - delete...サブボリュームを削除
  - list...サブボリュームを一覧表示
  - snapshot...スナップショット作成
  - show...サブボリュームの情報を表示
#### ZFS
- ZFS on Linuxというカーネルモジュールがあれば利用可能
- 最大ファイルサイズは16EiB
- COW
- RAID
- ストレージプール対応
- スナップショット機能
- チェックサムによる完全性の保証
- ホットスペア対応
### オートマウント
- ユーザがアクセスした際に初めてマウントを実行する
- 非アクティブ時に自動的にアンマウントもできる
- カーネルのモジュール経由ではなく、VFS上で動作している
- `udev`は物理的なイベント(USBソケットへの挿入)などで検知

- ネットワーク上のストレージ、巨大ストレージに対してリソースの効率化を実行できる
  - ネットワークストレージへのアクセスを最小限にできる
  - メモリ上のマウントテーブル、VFSキャッシュなどを解放できる
#### オートマウントする autofs
- デーモンを起動することで設定ファイルの内容に沿ってオートマウント
  - mountコマンドでマウントしないで実行すること
- `systemctl start autofs`
#### autofsの設定ファイル `/etc/auto.master`

- `/mnt/auto /etc/auto.dvrom --timeout=60`
  - マウントベース、マップファイル、オプションの順
  - マウントベース...どこにマウントポイントを置くか？
  - マップファイル...マウントベースごとの設定ファイル
  - オプション...タイムアウト時間を指定
- 変更後は、`sustectl restart autofs`...サービス更新
#### autofsの設定ファイル、マップファイル
- `/etc/auto.master`によって指定するため、名前は自由
- だいたい`/etc/auto.~~~`という名前にする
- 書式
  - `dvdrom -fstype=udf,ro :dev/sr0`
  - 直下ディレクトリ名、マウントオプション、デバイスファイル名
  - 直下ディレクトリ名...マウントベース直下に作られるディレクトリ。ここからアクセスする
  - マウントオプション...マウントに使用するオプション
  - デバイスファイル名...実際にマウントするデバイス名
- ※ こちらは変更後の更新は必要ない

