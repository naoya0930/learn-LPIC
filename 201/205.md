# 高度なストレージ管理
### RAID
- Redundant Arrays of Inexpensice Disks
- ソフトウェアRAID
  - mdadm(Multi deviceドライバ)で設定・監視・再構築
  - モジュールによって管理されている
- ハードウェアRAID
  - RAID専用のチップを組み込む
  - PCIeチップをPCに差し込んで，そこにディスク接続
  - マザーボードにチップが入っていることもある
- `/dev/md0`とか名前が付けられる．
  - UUIDは割り当てられない
#### RAIDの種類
- LVMは一段後の工程．RAID+LVMという構成になる．
  - 実際の所，併用する可能性は低い
- RAID0...ストライピング
  - 複数のディスクに分散してデータ書き込み
  - 1台のディスクのように扱う
  - 冗長性を担保しない
- RAID1...ミラーリング
  - 同じデータを複数保存する
  - 2台から構築可能
- RAID4...ストライピング+パリティ
  - 3台以上の構成に対して実現可能
  - 1台をパリティ情報を保存する専用ディスクにする
- RAID5...ストライピング+パリティ
  - 3台以上の構成に対して実現可能
  - 自身以外のディスクのパリティ情報を保存する領域を自身のディスクに設ける
  - 効率はRAID4と同じ
- RAID6...ダブルパリティ
  - 4台以上の構成に対して実現可能
  - 2台の同時故障に対応できるようにパリティ領域を構成する
- RAID10..ミラーのストライピング(1+0)
  - ミラー構成にした後に，ストライピングするように構成
#### パリティ・チェックサム
- 2台のデータのXORをパリティディスクに書き込むイメージ
- RAID4であれば，N/(N-1) の容量が必要になる
- RAID6の場合は，N/(N-2)の容量が必要になる．
- チェックサム機能は無いので，ビット単位で復元できるわけではない．

#### RAIDにおけるスペアデバイス
- それぞれのRAIDにおいて、構成時にスペアデバイスという概念も同時に入れる
- RAID1など構成要素全てがマスタで、完全同期して書き込んでいく
  - ここからオプションとして待機ストレージ(spareと呼ぶ)を設定することができ、障害発生時に自動昇格する
- ☆ リードレプリカと異なり、障害発生時に初めて同期を開始する
- 
#### 【復讐】パーティションID
- そのパーティションを何に使用するか識別するID
- MBRの場合
  - `fdisk -l` で表示
  - HEX Codeとか読んだりする
- GPTの場合
  - `gdisk -l`で表示
  - GUID(Globally Unique Identifier)とか呼ぶ
    - 32桁16進数
### RAIDの運用
- RAID IDが割り当てられている
- MBRのヘックスコード
  - ★ `FD`...Linux RAID Autodetect
    - ほとんどの場合，RAIDであることはこちら
  - `DE`...Dell Utility
    - Dell製のPCで使用することがある
- GPTのGUID
  - Linux RAID
    - A19D880F-05FC-4D3B-A006-743F0EE14D02
  - Apple RAID
    - 52414944-4F43-11AA-AA11-00306543ECAC
  - LVM
    - E6D6D379-F507-44C2-A23C-238F2A3AD000

#### RAIDの作成・管理
- mdadmを使用する（multi device administかな？）
  - 生ディスク(sda)、パーティション(sdaX)、RAIDデバイス(mdX)を対象に扱う
  - フォーマットする前に実行すること。
- モードが3つある
  - 作成（クリエイトモード）`--create`,`-C`
  - 操作（マネージモード）`--manage`
  - そのほか(miscモード)`--misc`
- モード別オプション
  - 作成 `mdadm -C [careate md0 file] {オプション} {devfiles}`
    - オプション
      - -a...必要であればデバイスファイルを自動的に作成
      - -c {size}...チャンクサイズを指定する(KB)
      - -l,--level {level}...RAIDレベルを指定する
      - -n,--raid-devices {num}...アクティブな構成のデバイス数を指定する
      - -x,--spare-devices {num}...スペアデバイスの数を指定する
  - 操作 `mdadm --manage {option} {md_device}`
    - オプション
      - -a,--add...構成デバイスを追加する
      - -r,--remove...構成デバイスを削除する
      - -f,--fall {md_dev} {mdの構成dev}...構成デイバスに不良タグをつける
  - そのほか `mdadm --misc {option} [md_device]`
    - miscはつけなくてもよい
    - オプション
      - -Q,--query...RAIDの状態を確認する
      - -D,--detail...RAIDの詳細な状態を表示
      - -E,--examine...構成デバイスの状態を表示
      - --readonly...mdデバイスを読み取り専用にする
      - --readwrite...mdデバイスを読み画期可能にする
      - --stop... RAIDアレイを停止する
      - --stop --scan...全てのRAIDを停止する
#### mdadmコマンド補足
- チャンクサイズ...分散する対象のデータサイズ


#### `/proc/mdstat`
- RAID構成状態の確認

#### RAIDの起動と専門用語
- アセンブル(assenble)
  - ブート時と手動コマンド`madam -assemble`実行時のステップ
  - `/etc/mdadm/mdadm.conf`やsuperblockを参照してRAIDデバイスを作成する
  - ブート時に関しては`initramfs`が実行してくれる
- チェック(check,resync,rebuild)
  - RAID起動時と、手動コマンド実行時、以上発生時のステップ
  - RAIDメンバ間のデータの整合性を確認、修復
    - check...RAIDの整合性の確認を実施
    - resync...RAID 1/10でミラー同期を実行
    - rebuild...RAID 5/6で欠落ブロックを修復
- superblock
  - RAID要素の先頭もしくは末尾に対して書き込まれる
  - UUID...RAIDアレイのユニークID
  - RAIDレベル
  - メンバ番号...このディスクがそのRAIDで何番目か？
  - デバイス状態...active/spare/failed など
  - データオフセット...RAID内でのデータ配置位置
  - メタデータバージョン...mdadm.confで参照されるバージョン
#### 構成の保存`/etc/mdadm/mdadm.conf`
- 起動の自動管理ができる
  - ARRAY {md_dev} {mdadm_metadata} {構成要素のUUID...}
- ☆ RAIDの構成を変更できるわけではない
  - ディスクのsuperblockに基づいて
- mdamdに参照されるものの、mdamdのバックアップぐらいにかんがえれば良い
  - `mdadm --detail --scan >> /etc/mdadm/mdamd.conf`
### LVM
- Logical Volume Manager
- 論理ボリューム管理
- 特徴
  - 一度作成作成するとサイズ変更できない
  - 別のディスクにパーティションを移動させることはできない
  - ディスクサイズを超えるパーティションは作成できない
- LVMにおける語句 
  - 物理ボリューム(PV:Physical Volume)...LVMで扱うパーティションとして扱う
  - 物理エクステント(PE:Physical Extent)...LVMでの管理最小単位(4MB程度)の物理領域。
  - 論理エクステント(LE:Logical Extent)...LVMでの管理最小単位。物理エクステントと同じ
  - ボリュームグループ(VO:Volume Group)...LVMでディスクとして扱う全パーティションの集合
  - 論理ボリューム...ボリュームグループをユーザが切り分けたもの
### LVM作成
- MBRでのパーティションタイプヘックスコードは「8e」
- GPTの場合は「E6D6D379-F507-44C2-A23C-238F2A3DF928」
### ボリュームを作成する `pvcreate`
- ブロックデバイスを物理ボリューム(PV)として初期化する
  - LVM用になり、中身を破棄する
- `pvcreate {phisical volume}`
- 対象はブロックデバイスであればなんでもいい
  - 生ディスク`/dev/sda`
  - パーティション`/dev/sdb2`
- パーティションを物理ボリュームとして扱うメリットってあるの？
  - MBRで2TBを扱う場合や、ブートディスクはLVMにしない方が良い。
    - LVMはGRUBで読めない
#### ボリュームグループを作成する`vgcreate`
- `vgcreate {vg_name} [dev1 dev2...]`
- オプション
  - -s {size}...物理エクステントの名前のサイズを指定する
#### 論理グループを区切る`lvcreate`
- `lvcreate -L {size} -n {name} {vg_name}`
- L,nは必須オプション
  - -L {size}...論理ボリュームサイズを指定
  - -n {lv_name}...論理ボリューム名を指定する
- 論理ボリュームをちょうど使い切ることはできないの？
  - 全然できる。ただし、エクステントで割り切れる値にしようね
  - `lvcreate -l 100%FREE -n lv_data vg0`
- ファイルシステムはこの上に作成する。
  - `mke2fs /dev/{lg_name}/{lv_name}` など
#### 論理グループを確認する
- `lvscan`
### LVMの管理
#### 物理ボリュームの状態を表示する
- `pvdisplay {used_lv_phisical_dev}`
- phisical volumeの略なので、LVM用途に使用されていなければならない
- 表示ステータス
  - PV NAME...物理パーティション/ディスク名
  - VG NAME...所属しているVolume Group名
  - PV Size...ストレージの総合サイズと、利用量
  - Allocatable...LVMに割り当てされているか？
    - --allocatableというオプションがあり、これに対して、YES/NOを指定することができる
  - PE Size...物理エクステントサイズ数
  - Total PE...そのストレージで何個のPEが作られるか
  - Free PE...未使用PE
  - Allocated PE...使用済みPE
  - PVUUID...物理ボリュームのUUID
    - 物理ディスクと物理ボリュームで異なるUUIDが設定されている

### LVM関連コマンド
#### ボリュームグループの拡張
- `vgextend {vg_name} {adding_pv_name}`
#### 物理ボリュームを移動する
- ディスクの交換などで物理ボリュームを別のpvに移動させる
- `pvmove {pv_name1} {pv_name2}`
- 当然同じVG上で実行するコマンド
#### ボリュームグループの縮小
- `vgreduce {vg_name} {pv_name}`
- vgに所属しているpvを削除
- 削除前に空にしておく(pvmoveしておく必要がある)
#### 物理ボリュームの削除
- `pvremove {pv_name}`
  - LVGメタデータを初期化する
    - PVに割り当てられていたUUID
    - 所属しているVG情報
  - ファイルシステムのフォーマットは残る
#### ボリュームグループの情報表示
- `vgdisplay {vg_name}`
- 主な表示内容
  - VG Name...ボリュームグループ名
  - SystemID
  - Format...LVMのバージョン現行はLVM2
  - Cur LV...ボリュームグループ内の論理ボリュームの数
  - Cur PV...物理ボリュームの数
  - VG Size... ボリュームグループのサイズ
  - PE Size...物理エクステントのサイズ
  - Total PE...論理ボリュームのエクステント総量
  - Alloc PE /Size...割当済みエクステント個数/MB
  - Free PE/ Size 空きエクステント個数/MB
  - VG UUID
#### 論理ボリュームの状態表示
- 論理ボリュームは/dev/論理ボリュームグループ/論路ボリューム名となる
- `lvdisplay {/dev/{lg_name}/{lv_name}`
- 主な表示内容
  - LV Path...論理ボリュームのパス
  - LV Name...論理ボリュームの名前
  - VG Name...所属しているボリュームグループ名
  - LV UUID
  - LV Size...論理ボリュームのサイズ(MB)
  - Current LE...論理エクステントの数
#### 論理ボリュームの拡張
- ボリュームグループの空き容量を既存の論理ボリューム(lv)に割り当てる
- `lvextend -L {size[MB/GB/etc]} {lv}`
- 再起動は必要ない。
- 伸縮性がないファイルシステムでは、認識できない場合がある
  - 伸縮性なし...FAT16,FAT32などなど
  - 伸縮性あり...ext4,XFS
#### resize2fs
- `resize2fs {lvname}`
- オプションを指定する必要はない
- ext系のファイルシステムの認識領域を広げる
- ファイルシステムの整合性は`e2fsck-f {lv_name}`を使用してチェックしておくこと
#### xfs_growfs

## 記憶装置へのアクセス
### デバイス
### ハードディスクの管理
### SSDの管理
### iSCSI
