# Linuxカーネル
## カーネルの構成要素

#### カーネルのバージョン
- 基本はこの記法
  - `メジャー.マイナー.リビジョン-サフィックス-`
#### 安定版カーネル
- 2.6.40以降
  - `rc`がついているのは安定版では無い
- 2.6.40まで
  - マイナーバージョンが偶数なら安定
    - 0,2,4,6
  - マイナーバージョンが奇数なら開発版
    - 1,3,5
#### umane
- 現在稼働しているカーネルを知る
- オプション
  - -a...すべての情報を表示
  - -r...カーネルバージョンを表示
  - -m...ハードウェアアーキテクチャを表示
### cat /prpc/version
- これも現在のカーネルのバージョンを戻す
### head /usr/src/kernels/3.10-XXX.XXX.X.XXX.x86_64/Makefile
- これも現在のカーネルのバージョンを戻す。
- 存在しない場合もある。

## カーネルイメージ
### カーネルのビルド
- `make`でソースがビルドされる
  - `vmlinux`が主に生成される
    - カーネル本体のこと。数十MB
  - これ以外もある
- `vmlinux`を圧縮したものが、`zImage`や`bzImage`
- `zImage`や`bzImage`を展開したものが、`vmlinuz-{version}`
  - `sudo make install`の実行によって生成される
- 以降、ブートのたびに`vmlinuz-{version}`をカーネルとしてロード

### zImage vs bzImage
- zImageには限界がある
  - 1MB程度しか確保できない
  - BIOS時代の制限に対応している
- bzImage
  - 大きなカーネルに対応
- 本質的には、makeの内容が違うだけ。
- BIOSにはカーネル「呼び出しのメモリの制約があった。
### 圧縮済みカーネルの配置
- Debian,CentOs系で共通の場所に保存
  - `/boot/vmlinuz-{version}`のファイルを指すことが多い
  - このバージョンは`uname -r`と同じ
- `/boot/zImange`,`/boot/bzImage`
  - vmlinuzの生成元

### カーネル、カーネルバイナリ、カーネルイメージ
- カーネルバイナリ...`vmlinux`のこと
  - これを直接呼ぶわけでは無い
- カーネルイメージ
  - `bzImage`,`/boot/vmlinuz-*`
#### カーネルモジュール
- カーネルは最小限の機能のみ搭載している
- ここからモジュールによって色々載せてる
  - IPv6, NFS, Samba
  - USB,PCI
  - グラフィックドライバ
  - オーディオ、bluetooth,wifi
- `/lib/modules/$(umame -r)/`にモジュールは配置される
  - `*.ko`ファイルとして存在
- 別途、カーネルでデフォルトでインストールすることもできる
  - `CONFIG_EXT4_FS`など
  - この場合、`.ko`ファイルは存在しない
  - これを静的インストールと呼ぶ
#### lsmod
- 現在ロードされているモジュール
- 表示項目
  - モジュール名
  - サイズ
  - 参照回数
  - そのモジュールを利用しているモジュール
- `proc/module`でも現在のモジュールを発見可能

#### modinfo
- モジュールの情報を表示
  - ディスクに存在していれば良く、現在ロードされているかは無関係
- オプション
  - -a...author(作者を表示)
  - -d...説明を表示
  - -l...ライセンスを表示
  - -n...モジュールのファイル名を表示
    - ファイルは`/lib/modules/{version}/`配下
- `modinfo ext4`
#### insmod
- `insmod [option] モジュールのパス`
- モジュールをインストールする
  - 依存関係は見ないので注意
- オプション
  - `-s`...実行結果を表示んではなく。syslogに出す
  - `-v`...しょうさいな　情報を表示

#### rmmod
- `rmmod [option] モジュール名`
  - パスではなく、モジュール名で指定
- モジュールのアンロード
- 使用中だったり、配下に依存関係があれば、エラーを戻す
- オプション
  - -a...未使用のモジュールをすべてアンロード
  - -s...動作結果を標準出力ではなく、syslogに吐く
#### modprobe
- `modprobe [option] モジュール名`
- これもモジュール名でよい！！！
- 依存関係のあるモジュールを見てロード、アンロードする
- オプション
  - (何も指定しないとインストール)
  - -a...すべてのモジュールをロード
  - -c...現在使われている設定を表示
  - -n...実際には行わない
  - -r...モジュールをアンロード
  - -C {file}...設定ファイルを指定する
  - --show-depends...そのモジュールの依存関係を表示

#### モジュールの依存性が書いてある場所`modules.dep`
- `/lib/modules/modules.dep`に配置
- 書式
  - `モジュール名: [依存先モジュール名...]`
#### depmod
- 依存関係を更新する
- 具体的には、`modules.dep`を再生成する

### 依存性以外の前処理、後処理を定義する
- `/etc/modprobe.conf`
- 現在は、`/etc/moprobe.d/`配下に存在する
  - `/lib/`じゃないよ！！！気をつけて
- 書式
  - alias {A} {a}...Aモジュールにaの別名をつける
  - options {A} {o}...Aモジュールのoオプションを指定
  - install{A} {B}...Aモジュールインストール時にBもロード
  - remove...`modprove -r`,`rmmod` が実行された後に実行するshellスクリプト
    - これが成功しないとアンロードしない
  - blacklist...　常にロードしない



## カーネルコンパイル
1. カーネルソースを用意する
2. カーネルconfigの内容を変更する
3. カーネルのコンパイルを実施
4. カーネルモジュールのコンパイル
5. カーネルとカーネルモジュールの配置
6. ブートローダの設定を変更
#### 1. カーネルソース
- `kernel.org`によって管理されている
  - ディストリビュータの手が入っていないものをVanilla Kernelと呼ぶ
  - tar.xz形式でダウンロード可能
- `/usr.src/linux`に配置する
- デバック用に残置することも多い
- `/usr/src/linux/`配下のディレクトリ
  - arch...各種アーキテクチャに依存したコード
  - configs...目的別の.configファイル
  - crypto...暗号処理関数
  - drivers...各種デバイスドライバ関連
  - fs...仮想ファイルシステムの構築、ファイルシステム
  - include...C言語のinclude
  - init...初期化
  - ipc...SystemV互換のプロセス間通信(共有メモリ、セマフォ)
  - ketnel...主要なカーネル処理
  - lib...各種モジュール
  - mm...メモリ関連
  - net...ネットワークプロトコル(IPV4のみ、v6は別モジュール)
  - script...カーネル作成支援スクリプト
  - Documentation...各種ドキュメント
- `/usr/src/linux/`配下のファイル
  - `.config`...カーネルの設定ファイル
  - `Makefile`...カーネルのMakefile



#### apt upgradeとの違い
- これはビルド済みのバイナリを持ってくるだけ
- カーネルの設定はバイナリに従う
#### 2. カーネルの設定を変更する
- .configに沿ってビルドされる
- 対話的にカーネルの設定が可能
  - `make config`
    - コンソール上でQAで作成
  - `make menuscript`
    - メニュー形式のオプションを選択
    - `/boot/grub/menu.lst`や`/boot/grub/grub.cfg`とは全く関係ないので注意
  - `make xconfig`
    - X(KDE)を呼び出して設定
  - `make gconfig`
    - X(Gnome)を呼び出して設定。
- `make oldconfig`
  - `/boot/config-$(uname -r)`のコピーを併用する
  - 古いカーネル設定を現在の.configに持ってきてからこれを実行する
    - 新バージョンのカーネル機能の部分だけ設定すれば良くなる
####　3.カーネルのコンパイル
- `make`...カーネルとカーネルモジュールをビルド
  - vmlinuxやbzImage、.koファイルまでの一連を出力
- `make bzImage`,`make zImage`
  - 圧縮されたイメージまでを出力
- `make modules`
  - モジュール部分のみを出力
    - .koファイルを`/lib/modules/`においていく
    - `depmod`ファイルも置かれる
- `make install`
  - カーネルとモジュールのインストールを実施
  - 1. `/usr/src/linux`から`/boot`に配置
  - 2. `initram`の設定
  - 3. `/lib/modules`の配置
  - カーネルの変更は実施しない
    - grub側のブートローダ側に教えてあげる必要あり。
#### grubへの登録
- `make install`はgrubへの登録を実施しない
  - ディストリビューションによっては自動でやってくれたりする
- `ls /boot`を見ればインストールしたものは存在
- `/boot/grub/grub.conf`のメニューにないので検出できない
- `grubupdate`や`sbin/installkernel`で更新が必要

#### カーネルを変更する
- grubにビルドしたカーネルを確認しにいく
- `grep "menuentry" /boot/grub2/grub.cfg | cut -d "'" -f 2`
- `grub2-set-default 0`0番目にあれば、これを実行
- 設定の反映
- `grub2-mkcinfig -o /boot/grub2/grub.cfg`
- 再起動を実行すると新しいカーネルで動く。

### DKMS(Dynamic Kernel Module Support)
- カーネルソースツリー外のカーネルモジュールを生成する
- カーネルのバージョンがアップデートされると、いままでのカーネルが使えなくなる
- これを防ぐために自動的にモジュールを再コンパイルする
  - 互換性を担保するわけではない
  - ソースコードを自動で更新したりもしない
- `dkms`コマンドによって更新の状態を管理できる

### kernelのmakeターゲット
- clean... .config以外の不要なファイルを削除する
- mrproper ... .configやバックアップも含めて不要なファイルを削除する
- disclearn ... .config、バックアップ、patchが作成したファイルを削除
- defconfig ... デフォルト値を設定した.configを作成
- all ... カーネル、モジュールを含めた全てをビルドする
- modules　... 動的なモジュールをビルド(.koファイルを作成)
- rpm ... カーネルをビルド後にrpmを作成する
- rpm-pkg ... ソースrpmパッケージを作成する
- binrpm-pkg ... ビルド済みのカーネルとモジュールを作成する(rpm形式)
- deb-pkg ... ビルド済みのカーネルとモジュールを作成する(Debian形式)

### ビルド済みのカーネルは何に依存しますか？
- ビルドはKbuildというプロセスで実行される。makeの拡張
- vmlinux時点では、オブジェクトファイル(.o)、.config、Makefileに依存
  - ソースファイル、.config、Makeファイルに変更が入った場合には再ビルドが必要になる

## カーネルパラメータ
- カーネルの機能の変更
- `/proc/sys/`配下の設定を変更すると現在の設定を変更
- sysctlでも管理できる
- `/proc/sys/kernel/`配下
  - `ctrl-alt-del`...ctrl+alt+delの挙動を変える
  - `domainname`...NISドメイン名
  - `hostname`...ホスト名
  - `modprobe`...modprobeのパス
  - `hotplug`...ホットプラグ用のプログラムパス
  - `osrelese`...カーネルバージョン
  - `ostype`...OSの種類
  - `sem`...セマフォ数
  - `shmall`...共有メモリの合計(バイト単位)
  - `shmmax`...共有メモリセグメントの最大値（バイト）
  - `sysrq`...システム要求キー(magic sysRq key)の有効/無効
    - カーネルが異常動作を起こしても操作可能なキー
  - `threads-max`...スレッド（プロセス）の最大数
  - `version`...カーネル構成の情報
- `/proc/sys/fs/`配下
  - `file-max`...ファイルハンドルの最大数
  - `file-nr`...開かれているファイル数、使用されたファイルハンドル数、ファイルハンドル数
- `proc/sys/net/core`配下
  - `rmem_default`...受信ソケットのデフォルトサイズ
  - `rmem_max`...受信ソケットバッファの最大サイズ
  - `wmem_default`...送信ソケットバッファのデフォルトサイズ
  - `wmem_max`...送信ソケットバッファの最大サイズ
- `proc/sys/net/ipv4`
  - `ip_forward`...ネットワークインタフェース間でのパケット転送の有効化
  - `icmp_echo_ignore_broadacsts`...ブロードキャストICMP Echo Requestを無視するかどうか
  - `icmp_echo_ignore_all`...すべてのICMP Echo Requestを無視するかどうか
#### NIS vs ホストネーム
- NIS(Network Information Service)
  - エンティティではない
  - UNIX分離管理のためのネットワークサービス
  - NISサーバからNISマップを読み出せる
  - NISサーバで作成したユーザにログインできる
  - NISサーバ内で管理ドメインを識別する名前
  - 複数のホストに対して与えられる
  - LAN内での物理サーバグループ
  - `ybind`デーモンでサーバ参照ができる
  - NISマップと呼ばれる共通データをNISサーバから参照できる
    - `/etc/passwd`...ユーザアカウント情報（ログイン名、UID、ホームディレクトリ）
    - `/etc/group`...グループ情報
    - `/etc/hosts`...ホスト名とIPアドレス
    - `/etc/netgroup`...マシン、ユーザのグループ定義
    - `/etc/services`...サービス名とポート名
    - `/etc/protocols`...プロトコル番号
    - `/etc/aliases`...メールエイリアス情報
  - `/etc/nsswitch.conf`に`nis`パラメータを与えることでNISサーバに探索しにいく
- ホストネーム
  - こちらは１代のマシンを管理するOSやDNSから識別される
#### hotplug
- デバイス、NIC、USBデバイスが抜き差しされた
  - この時に通知を送る仕組みがhotplug
- 現在は`udev`が代替しており、あんまり使われてない

### コマンドでカーネル設定を扱う
- `sysctl`が使える
  - `systemctl`別のコマンド
- オプション
  - `sysctl -a`...現在利用できるすべてのパラメータを表示
  - `sysctl -p`...指定したファイルから設定を読み込む(/etc/sysctl.conf)
  - `sysctl -w {PARM}={VALUR}`...パラメータを更新する
- `/etc/sysctl.conf`
  - {PARAM}={VALUE}で記述している
#### .config vs /proc/kernel
- 設定内容はほとんど同じ
  - CONFIG_SMP=y
  - CONFIG_NETFILTER=y
  - CONFIG_USB_STORAGE=m
  - CONFIG_EXT4_FS=y  などなど
- .configはビルド前、ビルド後は、/proc/config.gzになる（設定がいる）

## 初期RAMディスク
- GRUBは、`/boot/vmlnuz`と`/boot/initramfs.img`を読み込んでRAMにコピー
- カーネル(vmlinuz)はinitramfsを展開
- initramfsに含まれる/sbin、/bin、/libなどを読み出し
  - 我々が見えている/sbinは、カーネルによって読み出されたinitramsの展開後
#### ループバックマウント
- 通常のファイルをディスクデバイスのように扱う
- 例：`disk.img`を`/dev/loop0`としてアクセスする
- 低レイヤで扱う。
- 以下の要素で使用したりする
  - ISO
  - 仮想ディスク
  - テスト環境
#### RAMディスク
- メインメモリをディスクのように扱う
- `/dev/ram0`、`/dev/ram1`としてマウントされる

#### 初期RAMディスク
- Initial RAM DISK
- initrdとも呼ばれる
- boot配下に`/boot/initramfs-...img`とかで格納される
  - 中身の/sbinや/bin、/libをファイルシステムに展開する。
  - /bin等は、マウントはしない。RAM上に配置するだけでコピーに近い
  - 起動の度にboot配下を読み出しているので、/binに書き込んだ内容は消える
- ディスク領域として割り当てている(当然実態はメモリ上にある)
- ブロックデバイス形式として割り当て(ext2など)
- `mkinitrd {RAMDiskImageFile} {kernel version}`コマンドで作成できる
  - gzとか、img.gzファイルが出力される
  - 
#### initramfs
- initial RAM Filesystem
- 圧縮済み`cpio`アーカイブファイル
- grubによって読み込まれ、カーネルがRAMに展開する。
- `rootfs`とはこいつのこと
- 通常のルートファイルシステムがマウントされると、そっちに切り替える
- ファイルシステムだが、すべてRAM上にあるので注意
- `mkinitramfs -o {RAMDiskImageFile} {KernelVersion}`コマンドで作成できる
    - cpio.gz、cpio.xzが作成される

#### `lsinitrd`,`lsinitramfs`
- 各圧縮ファイルの内容を見ることができる
#### initrd/initramfsに該当するディレクトリ
- こいつらが展開される領域は`tmpfs`とか命名される
- /init
- /bin
- /sbin
- /lib
- /lib64
- /etc ...一部のみ
- /dev ...仮想
- /proc ...仮想
- /sys ... 仮想
- /tmp

#### 起動順序を再整理
- 1. EFIファームウェア
  - これはマザーボードのROM領域。
  - ディスクを探索してGRUBを見つけて、RAMに出す
- 2. GRUB
  - （二段階目の）ブートローダ
  - カーネルとinitramfsをRAMに読み出し。
  - カーネルがメモリ管理を開始
- 3. カーネル vmlinuz
  - initramfsを展開して初期RAMに配置
  - 特殊な参照システム上(tmpfs)に展開する
- 4. initramfs
  - 専用RAM(初期RAM)上で/bin,/sbin,/etcなどを展開。
  - ディスクのパーティションマウント
  - モジュールロード
  - デバイス準備
- 5. ルートファイルシステム
  - `switch_root`で切り替え。tmpfsは破棄される
  - /usr、/varなどをマウント
#### Dracut
- 初期RAMディスクの作成の際にudevに対応するユーティリティ
- `dracut`コマンドで初期RAMを作成できる
- 実ディスクを参照できる
## カーネルの管理と問題解決(proc仮想ファイル)
#### 主要な/proc仮想ファル
- `/proc/{number}/`...PIDごとのプロセス情報
- `/proc/bus/pci`...PCIバスごとの情報
- `/proc/bus/usb`...USBデバイス関連
- `/proc/ide/`...IDEデバイス情報
- `/proc/net/`...NIC情報
- `/proc/scsi/`...SCSIデバイス
- `/proc/sys/`... システムに関する情報
- `/proc/cmdline`...起動時にカーネルに渡された引数
- `/proc/cpuinfo`...CPUとシステムアーキテクチャに関する情報
- `/proc/devices`...メジャーデバイス番号とデバイス名
- `/proc/dma`...DMAチャネル
- `/proc/filesystems`....カーネルが読み取り可能なファイルシステム
  - nodevと書いてあるものは、組み込み
  - 表示されないものは読み込めない
- `/proc/interrupts`...IRQごとの割り込み回数
- `/proc/ioports`...I/Oアドレス領域
- `/proc/kcore`...システム物理メモリ
- `/proc/kmsg`...カーネルログ
- `/proc/meminfo`...物理メモリとスワップ領域
- `/proc/modules`...ロードされているモジュール一覧
- `/proc/mounts`...マウントされているファイルシステム
- `/proc/partitions`...カーネルが認識しているパーティション
- `/proc/stat`...カーネル、システムの統計情報
- `/proc/swaps`...使用中スワップ
- `/proc/uptime`...起動してからの時間
- `/proc/version`...カーネルバージョン
#### IDEデバイス
- Integrated Drice Electronics
- ハードディスクや工学ドライブインタフェース
- ATA(Advanced Technology Attachment)規格に基づく

#### DMAデバイス
- Direct Memory Access
- CPUを解さずにデバイスとメモリ間で直接データ転送を実施する
  - データのコピーなどをCPUを経由しない
- ハードディスク、サウンドカード、ネットワークカードで使用
- SATAやATAなど、接続方式のことではない。DMAに対応しているか否かの話。
#### SCSIデバイス
- HDD、SSD、テープ、CD-ROMなど様々なデバイスに対応
- DVIよりプラグが多いアレで接続する(50pin、68pin)
- ネットワークで接続する場合は、iSCSIプロトコルで繋ぐ

## /procの情報を効率的に表示する
#### lsdev
- DMA、IRQ、I/Oアドレスを表示
### lspci
- PCIパスと接続されているPCIデバイスを表示
- オプション
  - -v...
  - -vv...詳細に表示
  - -t...ツリーとして表示
  - -b...カーネルではなく、PCIバスで認識している情報を表示
  - -s [bus]:[throt].[function]...指定したバス、スロット、機能のデバイスのみ表示
  - -d [venderID]:[deviceID]...指定したベンダID、デバイスIDをもつデバイスのみ表示 
#### lsusb
- `/proc/bus/usb/`、`/sys/bus/usb/`配下の情報を確認
- オプション
  - -t...ツリー状に表示
  - -v...詳細な情報も表示
## デバイスファイル
- `/proc/devices`でアクセス可能
- 以下の2種類がある
- ブロックデバイス...ストレージ。RAIDボリューム、RAMディスクもこれに該当
  - `/dev/sda`などがこれに該当
  - ls -lで詳細を見ると、`b`と表示される。
  - メジャー番号、マイナー番号が割り当てられる
    - メジャー番号253は、マルチドライブ、SCSIディスク系に割り当てられる
- キャラクタデバイス...キーボード、マウス、端末、プリンタ
  - バイト単位で読み書きを実行。
  - `/dev/tty`がこれに該当
  - ls -lで詳細を見ると、`c`と表示される
#### udev
- 接続されたデバイスに対して、`/dev`配下に仮想ファイルを用意する
  - sysfsと連携している
    - `/sys/bus/usb/devices`,`/sys/bus/pci/device`などを見ている
  - カーネルではなく、ユーザ空間で起動している
- 必要なモジュールがあれば呼び出す

### udev設定ファイル `/etc/udev`配下
- デバイスが検知された時の自動処理を入れる
- システム標準に`/lib/udev.rules.d`が存在する
- 管理者が`/etc/udev/rules.d/`にルールを追加、上書きする
- ファイル：`{NN}-{name}.rules`
  - NNが小さいほど優先して実行する。
- ファイル内のパラメータ例
  - `SYSTEM==usb` (どんなデバイスが入ってきたか？)
  - `ATTR{PARAM}==id`(どのバス属性に接続されたか？)
  - `SYMLINK="webcam"`(リンクを作成する)
  - などなど結構いろんなパラメータが設定されてる

#### udevadm
- `udevadm control --reload`で現在読み取っているルールを更新する
- `udevadm info {option}`
  - `-a`... 指定したデバイスの上位デバイスを表示
  - `-p {device}`... sysfs上のデバイスを指定する
  - `-n {device}`.../dev以下のデバイスファイルを指定する
  - `-q {kind}`...表示する情報の種類を指定する(name, symlink,pat,env,all)
- `udevadm monitor`...udevの接続情報を共有する
- 