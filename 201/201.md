# キャパシティプランニング
## キャパシティプランニング主要なコマンド
#### topの使い方
- オプション
  - -b...対話モードではなくバッチモードで実行
    - fを押してもモード変更しない
  - -d {sec}...表示を更新する秒間隔を指定
  - -n {count}...指定した回数だけ更新すると終了する
  - -u {user}...指定したユーザを監視
  - -p {PID}...指定したPIDのみを監視
    - コンマ区切りで複数指定ができる
#### top表示項目
- PID
- PPID...親のPID
- USER
- RUSER...実ユーザ名
- UID
- GROUP
- PR...実行優先度
- NI...nice値
- VIRT...使用中の仮想メモリ(KB)
  - Virtual Memory
- RES...使用中の実メモリ(KB)
  - Resident Set Size
- SHR...共有メモリサイズ(KB)
  - Shared Memory Size
- S...プロセスの状態
- TTY...制御端末名
- CPU
- MEM
- TIME+...プロセスが開始していから使用したCPU時間の総計
- COMMAND
#### top表示項目の補足
- ※ 実行優先度(PR)とnice値の違い
-  nice値
   -  -20(優先度高い) ~ ~+19(優先度が低い)
-  実行優先度(PR)
   -  20 + {nice値}
- ※ VIRT,RES,SHRの違い
- VIRT...Mallocなどで確保したメモリサイズ
- RES...RAM上に読み込まれているサイズ
- SHR...他のプロセスと共有している
  - libc,libpathreadなどが該当する
- これらから専有メモリサイズという考え方がある
  - 専有メモリ = RES - SHR
- ※ VIRTについてもう少し詳しく
  - 以下を含む領域の合算
    - 1. 使用中の物理メモリ
    - 2. 共有ライブラリ
    - 3. スタック領域
    - 4. ヒープ（Malloc）で確保した領域
  - `オーバコミット`という仕組みで物理メモリ以上の空間をヒープとして確保可能
    - 実際に使用されるタイミングで確保する
    - Javaやpythonはメモリ要求が膨大に設定されているため、これがデフォルト
#### top中の操作
- スペース、エンター
- 上側のコンピュータステータスの表示の変更
  - f...表示する項目の変更
  - o...表示項目の順番の変更
  - l...平均負荷の非表示
  - m...メモリスワップ量の値表示・ゲージ表示・非表示を切り替え
  - u...ユーザを指定する
  - t...プロセスとCPU状態を表示・ゲージ表示・非表示を切り替え
- 下側のコンピュータステータスの表示の変更（SHIFT操作が多いと覚える）
  - A...表示モード切り替え
  - P...プロセスを使用CPU順にソート
  - M...プロセスを使用メモリ順にソート
  - N...プロセスをPID順にソート
  - T...現在の設定を保存する
  - W...現在の設定を保存
  - < or >...ソートする項目を変更
- その他
  - k...プロセスにシグナルを送信（お前そんなんできんのか）
  - h or ?...ヘルプ
  - q...終了
  - d or s...更新時間の指定

## sysstatパッケージ
- sar
- sadc
- iostat
- mpstat
- pidstat
- 等を含むLinuxパッケージ

#### vmstat
- メモリ，及び仮想メモリの詳細を監視する
- オプションを何もしていしなければ，その瞬間の計測量を１行で表示する
- `vmstat [表示間隔] [回数]`
- 表示項目
  - proc
    - r...実行待ちプロセス数(runnable)
    - b...割り込み不可能なスリープ状態のプロセス数(blocked)，uninterrupt sleepともいう
  - memory
    - swpd...スワップサイズ
    - free...空きメモリサイズ
    - buff...バッファに割り当てられているメモリ(KB)
    - cache...キャッシュに割り当てられているメモリサイズ(KB)
  - swap
    - si...ディスクからスワップインされているメモリサイズ(KB/s)
    - so...ディスクへスワップアウトされているメモリサイズ(KB/s)
  - io
    - bi...ブロックデバイスから受け取った前ブロック数．（ブロック数/s）
    - bo...ブロックデバイスに送られたブロック数．（ブロック数/s）
  - system
    - in...1s当たりの割り込み回数．クロック割り込みも含む
    - cs...1s当たりのコンテキストスイッチの回数
  - cpu
    - us...ユーザプロセスがCPUを利用している時間の割合
    - sy...カーネルがCPUを使用している時間の割合
    - id...CPUがアイドル状態の時間の割合
    - wa...ディスクがI/O待ちの時間の割合
    - st...ゲストOSがCPUを割り当てられなかった時間の割合

### vmstat補足
- memoryにおけbuffとcache
  - buff...HDD,SSDなどからの書き込み，読み込み用の一時領域
  - cache...ページキャッシュ，こちらは，ファイルの実データを保存する
- systemにおけるinとcs
  - in(interrupt)...ハードウェア割り込みとソフト割り込み
    - ハードウェア割り込み...キーボード入力やネットワークパケットなど
    - ソフトウェア割り込み...ネットワークスタック処理，タイマ割り込み
  - cs(context switches)...CPUのスレッドの切り替え数のこと
    - 自発的スイッチ(voltary)...I/O待ち，sleepなどで待機すること
    - 非自発的スイッチ(involtary)...タイムアウトした
- コンテクストスイッチってなんやねん
  - コンテクスト...プロセスの実行に必要な情報
    - レジスタの内容，ページテーブル，CPUフラグなどなど
    - タイムスライスで制御される
- じゃあ，sleep()のタイマって誰が管理してるの？
  - カーネル(PID=0)のスケジューラ関数によって管理
  - スケジューラは割り込みハンドラの一部，カーネル関数として存在する
  - スケジューラは物理PCのCPUに対して一つ存在する
#### iostat
- CPUの使用状況とディスクI/Oを調べる
- プロセスによって読み出されるディスクの疎通
  - 当然キャッシュが当たって入れば，読み出しは発生しない
- `iostat [option] [表示間隔] [回数]`
- オプション
  - -c...CPU情報のみ表示
  - -d...ディスクI/O情報のみを表示
  - -k...ブロック単位ではなくKB単位で表示
  - -t...時間を表示
#### iostat何が見える？
- `avg-cpu`上段の項
  - user...
  - nice...
  - system...
  - iowait...
  - steal...
  - idle...
- 下段（各種ブロックデバイスごとに情報を表示`/proc/diskstats`を参照している）
  - tps..i/o転送リクエスト数
  - kb_read/s...デバイスからの読み出し量（kb/s）
  - kb_wrtn/s...デバイスへの書き込み量
  - kb_dscd/s...デバイスが破棄したデータ量
  - kb_read...デバイスからの読み出し量（kb）
  - kb_wrtn...デバイスへの書き込み量(kb)
  - kb_dscd
- `cifsiostat`というコマンドもある
#### iostatとlsblkで見える情報が違う
- lsblk...実際の物理ディスク，パーティション，LVM，RAIDが見える
- iostat...カーネルがi/o監視しているブロックデバイス
  - 物理デバイス，LVM等，レイヤーのi/oかは判別しない．（名称から推測する必要あり）
#### iotop
- topコマンドのようにi/o情報を見せる
#### sar
- System Activity Reporter
- `sadc(system Activity Data Collector)`コマンドで収集したログを閲覧できる
- または様々なシステム統計情報のレポートを得ることが可能
- `sar option [-s 開始時刻] [-e 終了時刻] [-f ログファイル] [取得間隔秒] [回数]`
- オプション
  - -A...全ての項目を表示する
  - -b...ディスクの入出力と転送レート情報を表示する
  - -c...プロセスの生成回数を表示する
  - -f {file}...ログファイルを指定する．`sadc`で集められたログの表示
  - -n {DEV}...ネットワーク関連の情報を表示
  - -n {EDEV}...ネットワーク関連のエラー情報を表示
  - -n {TCP}
  - -r...メモリとスワップ関連の情報を表示
  - -u...CPU関r年の情報（iostat同じ）情報を表示
  - -P {id}..CPUごとの情報を表示
  - -All...全てのCPUの情報を表示
  - -R...メモリの統計情報を表示
  - -W...スワップの情報を表示

#### sadc
- system activity data collector
- `sadc [option] [取得間隔秒] [回数] 出力ファイル`
- システムやデバイスの動作をファイルとして保存するコマンド
- 裏で自動で集計している
- `/var/log/sa/sa{日付}`に保存している
#### sar -b
- バウンドのことかな、、、？
- 表示項目
  - tps...i/o転送リクエスト数 /s
  - rtps...ディスク読み込みリクエスト数 /s
  - wtps...ディスク書き込みリクエスト数 /s
  - bread/s...ディスク読み込みブロック数 /s
  - bwrtn/s...ディスク書き込みブロック数 /s
#### sar -n DEV/EDEV
- -n...ネットワークオプションのこと
- 表示項目
  - IFACE...ネットワークインタフェース名
  - rxpck/s...受信パケット数 /s
  - txpck/s...送信パケット数 /s
  - rxkB/s...受信キロバイト数 /s
  - txkB/s...送信キロバイト数 /s
  - rxcmp/s...圧縮パケットの受信バイト数 /s
  - txcmp/s...圧縮パケットの送信バイト数 /s
  - rxmcst/s...マルチキャストパケットの受信パケット数 /s
#### sar -r
- `/proc/meminfo`でも見れる
- 表示項目
  - kbmemfree...空きメモリ
  - kbmemused...使用中メモリ量
  - memused...メモリ使用率
  - kbbuffers...バッファ使用量
  - kbcached...キャッシュ使用量
  - kbcommit...現在必要としているメモリ送料sa
  - commit...スワップを含む総メモリに対する必要メモリ
  - kbactive...activeなメモリ
  - kbinact...inactiveなメモリ
  - kbdirty...dirtyなメモリ

#### Linuxメモリの基本構造
- ページ領域の利用
  - 匿名ページ(anonymous page)...mallocなどで確保される領域
  - ファイルページ(file-backed page)...ページキャッシュのこと。ファイルをキャッシュする
  - スワップページ...一時的にディスクに待避されたページ
  - ※ キャッシュとは違い、書き込みも発生する
- ファイルページの管理状態
  - Active...最近アクセスされ、参照可能な状態
  - Inactive...しばらくアクセスされていない.
- ファイルページの状態管理
  - Dirty...ページに対して書き込みが発生し、その変更をディスク側に書き込んでいない状態
  - writeback...ディスクに同期中はこの状態

#### sadf
- `sadf [option] -- [sarコマンドに渡すオプション]`
  - `sadf /var/log/sa/sa31 -t -- -r`など
- sadcログをタブ区切りテキスト(tsv)やxmlで出力する
- オプション
  - -j...json形式で出力
  - -x...xmlで出力
  - -t...UTFではなく、ローカル日時で出力
- コツ
  - csvで出力する
  - `sadf /var/log/sa/sa02 -- -r | tr '¥t' ','`
  - trコマンドでタブを書き換えている
#### uptime
- topコマンドの1行目とほとんど同じ
  - 現在時刻、システムの連続稼働時間、現在ログインしているセッション数、システム負荷
  - システム負荷は、1min,5min,15minの平均を表す
#### w
- topコマンドの１行目と、現在ログインしているユーザのプロセス情報を表示
- セッションごと（tty/pts）に１行表示
- オプション
  - -h...ヘッダを表示しない
  - -s...ログイン時刻、JCPU、PCPUを表示しない
- 表示項目
  - USER
  - TTY
  - FROM...接続元。ローカルの場合は`:0`
  - LOGIN@...そのセッションの起動時刻
  - IDLE...最後に操作してからどれくらい経っているか？
  - JCPU...そのセッションで実行されたプロセスのCPU経過時間
  - PCPU...WAHTで表示されるコマンドがどれくらいCPU経過時間したか？
  - WHAT...実行されているコマンド
## CPU使用率の測定
#### ps
#### pstree

## メモリ及びスワップの使用量の測定
#### free
## ディスク使用量の測定
#### df
## ネットワークトラフィックの測定
#### netstat
#### ss
#### Netperf
- netserver(サーバ)、
  - このコマンドでポートでリッスンする
  - 12865ポートをデフォルトで使用する
- netperf(クライアント)を使用する

# リソース需要の分析と予想
### りソース監視ツール
#### collectd
#### Nagios
#### MGTR
#### Cacti
#### Icinga2

