# ネットワーク
## ネットワークの設定
### ネットワークデバイス
- 主なネットワークインタフェース名
  - eth0...イーサネットインタフェース
  - eth1
  - ppp0...PPPインタフェース
  - lo...ループバックインタフェース
- 最近のディストリビューションで使用される命名規則
  - Predicatavle Network Interface Nameとも呼ばれる
  - ネットワークに関する項
    - en...イーサネット
    - wl...無線LAN
    - ww...無線WAN
  - デバイスに関する項
    - o...オンボードデバイス
    - s...ホットプラグデバイス
    - p--s--...PCIデバイス
#### 設定の確認 `ifconfig`
- ifconfig
- ifconfig {NIC} {paramter}
- 状態の確認以外にも設定の変更もできる
  - ipアドレス...IPアドレスを設定する
  - netmask ネットマスク...ネットマスクを設定する（サブネットの範囲のこと）
  - up...ネットワークインタフェースを活動状態にする
  - down...ネットワークインタフェースを休止にする
- 他にもifup、ifdownでもよい

#### 論理的なネットワークの作成
- ネットワークインタフェース名：仮想ネットワークインタフェース
- 複数のIPアドレスを同じNICに割り当てることができる
- 仮想NICを作詞絵しているわけではない
- MACは共通
- 何が良いの？
  - 追加したIP宛のパケットを受信できる
  - 追加したIPのsrcアドレスとして送信できるようになる
  - アプリケーション用にIPをバインドできる
  - ARP/NDPに対して応答する
- 昔
  - `iconfig eth0:0 192.168.1.11 up`
    - それぞれにIPが設定される
      - ipconfig eth0
      - ipconfig eth0:0
      - ipconfig eth0:1
  - こちらはカーネルで定義されているアドレスを追加するわけではない
  - なので、ARPに対する応答も曖昧
- 今
  - `ip addr add 192.168.1.11/24 dev enp0s3`
  - ARPに対する応答もファイルによって制御できる
  - IPを拡張できるが、端末だけの解釈ということ

### ARP
- Address Resolution Protocol
- MACアドレスと、IPアドレスを変換する
- `arp {option}`
- オプション
  - -a {host}...指定したホストもしくは全てのエントリを表示
  - -f...ホスト名とMACアドレスの対応をファイルから読む。デフォルトは/etc/ethers
  - -n...ホスト名をIPアドレスで表示。これを指定しないとDNSに聞きに行ってしまう。
  - -d {host}...指定したホストのエントリを削除
  - -i {interface}...ネットワークインタフェースを指定する
  - -s {host or IP} {MAC}。..ホスト名/IPとMACアドレスの対応を追加
#### ネットワークの監視
- `arpwathch`
  - ARP監視用のツール
  - /vat/log/messageに接続ログを落としてくれる
### ネットワーク管理コマンド
#### ping
- ホスト、IPアドレスに対してICMPを送信する
- オプション
  - -n...ホスト名を解決せずにIPで出力
  - -c {cnt}...指定した回数だけICMPを送信
  - -i {interval}...指定した間隔でICMPを送信
#### traceroute
- 指定した経路に対するIPの証跡を追いかける
- ICMPを使用する
- traceroute {hostname or IPaddr}
- オプション
  - -i {NIC}....指定したNICから通信を開始する
  - -n ホスト名をIPアドレスで表示する
#### trancetoute6
- IPv6ようのtraceroute
#### tcpdump
- 指定したネットワークインタフェースを監視する
- 自分宛でなくても開封するようになる(NICプロミスキャスモード)
- `tcpdump {option} [port XX|protocol_name]`
  - ポートを指定することもできる
- オプション
  - -i {interface}...監視するインタフェースを指定
  - -s {byte}... パケットから取り出すバイト数を指定
  - -X...16進数とASCIIで表示
  - -n...アドレスを名前解決せずに表示
  - -N...ホストのドメイン名を表示しない
  - -l...標準出力をバッファリング
  - -t...時刻を表示しない
  - -v...詳細に表示

#### Wireshark
- ネットワーク可視化ツール
#### netstat
- 引数なしで実行するとアクティブな接続とUNIXドメインソケット情報を出力
  - アクティブな接続...確立中のネットワークの接続を表示
  - UNIXドメインソケット...ローカルホスト内のプロセス間の通信（Unix 3とか）
    - 仮想ファイル名でやり取りすることが多い。i-nodeで結びついていることも多いので、ここから特定可能
    - RefCntで参照数を表している。以下で増える。「プロセスの待ち」の数ではない
      - ソケットが作成される
      - listen()で呼び出された
      - accept()で接続を生成した
      - 他プロセスがソケットを開いた
- 名前なしソケット
  - ファイルシステム上にパスがなければファイルは表示されない
  - メモリ上のデータを指すことが多い。
  - カーネルの認識上、inodeが割り当てられる
#### ss
- netstatにほとんど同じ
#### nc
- TCP/UDPのサンプルパケットを送信する
- `nc {host/ip} {port}`
- ポートスキャンもできる
  - tcp
    - `nc -vzt {host/ip} {XXX}-{XXX}`
  - udp
    - `nc -vzu {host/ip {xxx}-{xxx}`
#### ip
- `ip link {command} {dev}`...デーリンク系
- `ip addr {command} {dev}`...ipアドレス系
- `ip route {command} {dev}`...ルーティングテーブル
- `ip neigh {command} {dev}`...ARPキャッシュ操作
- コマンド
  - show
  - add
#### ルートテーブル vs ARPテーブル
- ルートテーブル...次にどこにパケットを出せば良いかをIPで定義
  - OSのルートテーブル
    - 自身から出るパケットを制御する
  - ルータのルートテーブル
    - 他のネットワークに出ていくときに、どこに出すかの設定
- ARPテーブル
  - 各OSで定義されるL2連結されたIPとMACの対応表
  - 各末端のOSと、L3ルータが保持するテーブル
  - L2スイッチはMACアドレスの一覧を持っているが、ARPテーブルは保有しない
  - ARPブロードキャストして、接続されている端末を知る
#### ルーティングの設定
- ルーティングテーブル
  - /proc/net/route
  - /proc/net/ipv6_route
  - netstat -r などで参照できる
- 以下はARP
  - /proc/net/arp
  - ip neigh
  - arp -n
#### `route` コマンド
- 何もしてしないと、現在のルーティングテーブルを表示(netstat -rに同じ)
- オプション
  - -n...ホスト名の名前解決をしない
  - -F...カーネルのルーティングテーブルを表示
  - -C...カーネルのルーティングキャッシュを表示する
- 表示項目
  - Destination...宛先アドレス、宛先ホスト
    - Default...デフォルトゲートウェイに設定している宛先
    - linklocal...169.254.x.xの範囲のIPのこと。ルータはこれを処理しない.RFCで定義
  - Gateway...宛先に送るための中継
  - Genmask...ネットワークマスク
  - Flags...経路の状態
    - U...経路は有効
    - H...宛先がホスト
    - G...ゲートウェイに送信する
    - I...経路が無効
  - Metric...宛先までの距離
  - Ref...ルートの参照数
  - Use...経路の参照回数
  - Iface...この経路を使うネットワークインタフェース
#### routeを手動て追加する
- route add / route del
## 無線ネットワークの設定
#### 無線ネットワーク色々
- IEEE802.11a
  - 5.2GHz
  - 伝送速度 54Mbps
- IEEE802.11b
  - 2.4GHz
  - 伝送速度 11Mbps
- IEEE802.11g
  - 2.4GHz
  - 伝送速度 54MBps
- IEEE802.11n
  - 2.4GHz/5.2GHz
  - 伝送速度 600Mbps
- IEEE802.11ac
  - 5GHz
  - 伝送速度 最大7GHz
#### 無線ネットワークセキュリティ
- WEP...Wired Equivalent Privacy
  - 固定共通鍵で通信する（WEP key）
- WPA...Wi-Fi Protected Access
  - TKIPを使用
  - WPA2,WPA3に加えて、Personal,Enterpriseと色々ある
#### 無線ネットワークアクセスポイント
- SSID...Service Set Identifier
- ESSID...Extentded Service Set Identifier
  - 一つのSSIDを複数のステーションで使用する
  - シームレスに接続できる
  - 設定はクライアント側でも必要
    - クライアント側で設定したESSIDとAP側のESSID(SSID)が同じなら接続
#### 無線ネットワークサプリカントインタフェース
- `wlan{X}`とか`wlp{X}n{Y}`とか表示される
#### iwconfigコマンド
- 状態の確認、設定の変更を実行する
- `iwconfig {wlan_interface}`
  - 状態の表示
- `iwconfig {wlan_interface} essid "{ssid_name}"`
  - essidを設定する。この名前のSSIDに接続しにいく
- `iwconfig {wlan_interface} key s:{wep_key}`
  - wepキーを設定
#### WPA設定ファイル
- `wpa_supplicant`でファイルを指定して接続可能
- `wpa_passphrase > file`でファイルを出力可能
- 設定項目
  - ssid...SSID
  - proto...暗号化接続、WPAなど
  - key_mgmt...暗号保水機、WPA-PSK、WPA-AESなど
  - pairwise...通信中の暗号化プロトコル TKIP CCMPなど

#### 無線インターフェイスの情報を参照 `iw`
- `iw dev`
  - 無線インタフェースの一覧を表示
- `iw dev [dev] [command]`
- コマンド
  - info
  - link
    - などなど
#### 無線インタフェースの一覧`iwlist`
- `iwlist {wlwan_NIC} {param}`
- オプション
  - scanning [essid]...接続可能なアクセスポイントの一覧と情報を表示
  - channel...設定可能なチャネルを表示
  - rate...伝送速度の表示
## 高度なネットワークの設定と問題解決
### ネットワーク関連ファイル
- ifconfigやrouteコマンドは再起動で消える
#### `/etc/hostname`
- 自身のホストの名前をここに記述する
#### `/etc/hosts`
- ホスト名とIPアドレスとの対応を記述
#### `/etc/networks`
- ネットワーク名とネットワークアドレスの対応
#### `/etc/nsswitch.conf`
- エンティティの解決をどこで実行するか？
- getentで参照できる範囲を定義
#### `/etc/resolv.conf`
- 問い合わせ関連
- domain...そのホストが属するドメイン名
- search...ドメイン名が書略された際の保管ドメイン名
- nameserver(複数指定可能)...DNSサーバのIPアドレスを記述
#### `/etc/syscinfig/network`
- nmcli,nmutilで管理されるコマンド
#### `/etc/sysconfig/network-scripts/`
- ネットワークデバイスの設定ファイル
- それぞれのNICの設定を変更可能
#### `/etc/network/interfaces`
- Debian系のネットワークデバイス設定ファイル
- DHCPを使用する場合にもここに記述
### ネットワークの問題解決
- 1. まずはpingしてみる
- 2. インターネットに出れない場合は、routeを見る
- 3. tracerouteで追跡してみる
  - Defaultが設定されているか？ゲートウェイが存在するか？
- 4. mtrコマンドも使える
  - traceroute,pingを使用した経路診断ツール
  - TCP/UDP、ICMPによる通信
#### Linuxをホストとするルータ
- パケット転送を実行する場合には明示的に許可しなければならない
- `/proc/sys/net/ipv4/ip_forward`に1を追記

