# システムメンテナンス
## ソースからのソフトウェアインストール
### ソースの展開
- gzip..gzipに関する圧縮、解凍
- tar...tarに関する圧縮、解凍
- bizp2...bzip2形式の圧縮、解凍
- xz...xz形式の圧縮、解凍
#### 基本のtar
  - `-c`,`-x`,`-t`
    - 作成,解凍,中身確認
  - `-v`
    - 詳細表示.verbose
  - `-f`
    - アーカイブファイル名を命名
  - `-z`,`-j`,`-J`
    - gzip, bzip2, xzを対象にする
  - z,j,Jを指定しないと`.tar`ファイルになる
  - tar + 圧縮形式のファイルをtarボールと呼ぶ
#### gzip,bzip2,xz
- `-d`
  - 解凍、指定しないと圧縮
- `-c`
  - 標準出力に出す
- `-k`
  - 圧縮、解凍前のファイルを保持する
- `-r`
  - ディレクトリ全てのファイルをそれぞれ圧縮
- `-l`
  - 圧縮ファイルの詳細を表示

####　アーカイブにおける差分ファイル
- 差分(`diff`)からパッチファイルを作成する
- 出力形式の違い
  - diff -u...unified diff(人が読みやすい)
  - diff -c...context diff
  - diff ...normal diff
- オプション
  - -r...再帰的にディレクトリを比較
  - -N...新規ファイル追加を検出する
- 単一ファイルから作成
  - `diff -u old.txt new.txt > change.patch`
- ディレクトリから作成
  - `diff -urN old_dir/ new_dir/ > update.patch`
- gitから作成
  - `git diff > fix.patch`
#### 差分ファイルの適応`patch`
- `patch [option] < X.patch`
- オプション
  - -d {dir}...指定したディレクトリに移動してから処理
  - -p0...パッチファイル内に書かれたパス名を修正しない(tmp/src/patch)
  - -p1...パッチファイルに書かれた階層を一つ下げてパスを適応する(src/patch)
  - -p2...パッチファイルに書かれた階層を２つ下げてパスを適応する(patch)
  - -C...どういう処理が行われているかテスト
  - -R...パッチの適応を取り消して元に戻す
- `-p`はdiffが生成されたデバイスと適応対象のデバイスの差分を消すために使用する
  - gitであればgitが実行されたディレクトリに沿って作成される
  - diffコマンドの場合は、ルートからパッチファイルに記載する
- パッチファイルの適応に失敗した場合は、rejectファイル（.rej）が生成される

### Makefileの作成
- configureスクリプトによって生成される
- ほとんどはshellで構成されている
  - ビルド環境の確認
  - Makefileの生成
  - 環境に合わせたオプションの設定
- よく設定されているオプション
  - --help...説明の表示
  - --prefix={dir}...インストール先のトップディレクトリ
- このコマンドを通して`Makefile`が生成される
### コンパイルとインストール　`make`
- `make {option} {target}`
- ターゲット
  - all...コンパイル実行
  - install...ソフトウェアインストール
  - uninstall...アンインストール
  - clean...一時ファイルを削除する
- 配置は`/usr/local/bin`,`/usr/local/sbin`に配置
## バックアップ
### バックアップの種類
- 完全バックアップ
  - 全てのディスク、ファイル
- 差分バックアップ
  - フルバックアップから、それ以降に作成、変更されたファイル
  - 必ず、フルバックアップからの差分をみる
- 増分バックアップ
  - 一つ前の差分から作成された差分
### バックアップデバイス
- CD-W
- DVD-R
- BD-R
- 磁気テープ
- ネットワーク
  - ツール色々
    - AMANDA
    - Bacula
    - backupPC
    - Bareos
### ローカルでのバックアップ
#### `cpio　{flag} [option]`
- 複数ファイルをまとめてアーカイブする
- 標準、標準出力を使用する。
- パイプを使用して接続する
- initramfsはこの形式
- フラグ
  - `-i [option] [pattern]`...アーカイブからファイルを抽出
  - `-o [option]`...アーカイブを作成する
  - `-p [option] {dir}`...ファイルを別のディレクトリにコピーする
- オプション
  - -A...既存のアーカイブにファイルを追加
  - -d...必要ならディレクトリを作成
  - -r...ファイル名を対話的に変更
  - -t...コピーはせず、入力された内容を一覧表示
  - -v...ファイル名の一覧を表示
#### 低レイヤコピーコマンド `dd`
- dd [option]
- オプション
  - if=...入力側のファイル、何も指定しないと標準入力
  - of=...出力側のファイル、何も指定しないと標準出力
  - bs=...入出力のブロックサイズを指定
  - count=...回数分の入力ブロックをコピー。指定しないと入力の全て
#### ファイルシステム単位でバックアップ`dump`
- inode番号、ディレクトリブロックを直接読み込んでバックアップにする
  - ジャーナリングシステムが存在する場合は、使用できない
  - 現代においては、ほとんどext2でしか使用できない
- 保存先はデバイス
- `dump {option} {バックアップ先デバイス}`
- オプション
  - `0-9`...dumpレベルを指定する
    - 0...完全バックアップ
    - 1以降、差分で0からのバックアップを取得
  - `u`...バックアップ実施時に/etc/dumpdatesファイルを更新
    - これを指定すると、レベルに対して増分バックアップになる
  - `f {dev}`...バックアップ装置のデバイスを指定
#### テープデバイスへの書き込み
- /dev/st0...これを指定すると、自動的に先頭に巻き戻しを実行する
- /dev/nst0...これを指定すると、先頭に巻き戻ししない
- dumpする場合にnst0を選択すると、続きからバックアップできる
#### dumpバックアップからファイルを取り出す`restore`
- ファイルシステムのように取り出す
- `restore [option] [file/dev]`
  - オプション
    - -r...全てのファイルを取り出す
    - -i...対話モードで操作する
    - -f {dev}...バックアップ装置のデバイスを指定する
#### テープドライブの操作`mt`
- mt [-f dev] {command}
- command
  - status...テープの状態を表示する
  - tell...テープの現在位置を表示する
  - rewind...テープを先頭に巻き戻す
  - fsf {N}...テープをN個先のデータの戦先頭位置に移動する
  - compression 1...ハードウェア圧縮を使用
  - compression 2...ハードウェア圧縮を使用しない
### ネットワーク経由でのバックアップ`rsync`
- `rsync [option] [hostname:]コピー元ディレクトリ [hostname:]バックアップ先ディレクトリ`
  - リモート対応のコピーコマンド
  - sshでも可能
  - 差分のみのコピーに優れている
- オプション
  - -v...途中経過を表示する
  - -a...アーカイブモード(ファイル、ディレクトリの属性をそのままコピー)
  - -r...ディレクトリ内を再帰的にコピー
  - -u...変更、追加された分のみをコピー
    - mtimeやサイズを見て最新かどうか判断する
  - -l...シンボリックリンクをリンクのままコピー
    - sshでもssh先のユーザを指定してリンクを作成する。
  - -H...ハードリンクをリンクのままコピー
    - ディレクトリコピーで複数から参照されている場合は、実態は1つでハードリンクを作成する。
  - -o...所有者属性を維持
  - -g...所有グループ属性を維持
  - -t...タイムスタンプを維持
  - -n...テストのみ実行
  - -z...ファイルを圧縮する
  - --delete....コピー元ファイル削除はコピー先でも削除する
- よく使うオプション
  - -auv...ディレクトリに対して差分を追加する
## ユーザへのシステム管理情報の通知
### ログイン前後のメッセージ
- ログイン前にメッセージ
  - /etc/issue
- ログイン後にメッセージ
  - /etc/motd
- メッセージの書式
  - ¥d...日付
  - ¥t...時刻
  - ¥n...ホスト名
  - ¥s...OS名
  - ¥r...カーネルバージョン
  - ¥m...マシンアーキテクチャ
  - ¥l...tty名
- ※ こいつらはgettyというプログラムで呼ばれる。
  - 標準出力には無い機能
### ログイン中ユーザへの表示
- `wall`
  - 一斉にログイン中のユーザに送信
- `shutdown -k {message}`
  - 一斉にログイン中のユーザに送信
  - 