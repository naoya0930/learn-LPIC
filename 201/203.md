# システムの起動
### システム起動プロセス
#### ブートからカーネルの起動まで
- BIOS + MBR(マスターブートレコード)
  - BIOSはマザーボード上、MBRはディスクの最初の512byte
  - メモリのチェック
  - ハードウェアの設定の読み込み
  - 起動デバイスのチェック
  - 起動デバイスのマスターブートレコード内のブートローダを実行
  - MBR内にパーティション情報がある
- UEFI + ESP
  - UEFIはマザーボード上。ESPはディスク上にある
  - ESPは100MBを超えることもある。
  - CSM(Compatibillity Support Module)
    - UEFIでBIOSのような挙動を実現する
  - ESP(EFI system partition)
    - EFI(Estensible Firmware Interface)が存在するパーティションのこと
      - .efiファイル
    - ブートローダ、ファームウェア、設定ファイル、ドライバ
    - ESPにはEFI以外は含めないことが多い
- GPT
  - GUID Partition Table
  - UEFI環境のパーティション定義フォーマット
    - なのでboot用途以外のディスクにもGPT情報は記述される
  - 2TBを超えるディスクをマウントする場合はこちらを採用
  - それぞれの物理ディスクの最初と最後に入っている
  - 初回起動時は、「EFI System partition」のGUIDをUEFIが見つける
### ブートローダ(MBR)
- 第一段階のブートローダはMBR内にある
- 第二段階として、GRUB、GRUB2が起動する
### ブートローダ(UEFI+ESP)
- 第一段階のブートローダはEFI
- 第二段階として、GRUBやGRUB2がある
- 第一段階はファームウェア、第二段階はOSに依存する
### カーネル
- GURBに呼ばれるやつ
- linux/windowsなど
- OSの基礎処理、ドライバの初期化
- ルートファイルシステムもこれより後段で認識する
### 初期プロセス
- Upstart,systemd,SysVinit,runinit,OpenRCなど
- カーネルパラメータのinitによって指定されるプロセス
- ☆ IoT機器とかは、これの初期プロセスが別に指定されている

#### MBRがカーネルの無いディスクを初期起動ディスクとして指定するとどうなる？
- カーネルが見つからず、エラーになる。
- MBRにおいて必須なディレクトリ
  - /bin,/sbin...カーネルなどが使用するプログラム
  - /etc...各種設定
  - /lib...ライブラリ
  - /dev...デバイスファイル
  - もちろんカーネル(/boot)も同じディスク

#### dmseg
- カーネルがブートしてからのログを出す
- 揮発性を持つ
- いつから？
  - grubがRAMにカーネルをロードしてから
- いつまで？
  - ルートディレクトリを切り替えるまで
  - これ以降もカーネルが発するメッセージはdmesgに記述される
- dmesgに記述される0.000sはカーネルが配置されて、CPUで初めて処理された時間が起点

### SysVinit
- init(PID=1)が/etc/inittabの設定に従い、サービスを起動
- ランレベルに沿った処理を実行(/etc/rc.d/rc.sysinitスクリプト)
  - 1. initが/etc/inittabを読み込み(systemdはここから違う)
  - 2. initが/etc/rc/sysinitを読み込み
  - 3. initが/etc/rcを実行
  - 4. /etc/rcがランレベルに沿ったスクリプト(/etc/rc{runlevel}.d/)を実行
#### /etc/inittabの書式
- デフォルトターゲットが書いてある
  - `id:{num}:initdefault:`
  - この記法は特殊
- 他には、コンソールの起動
  - `1:123:respawn:/sbin/mingetty tty1`
  - `{id}:{ランレベル}:{アクション識別子}:{処理}`の記法で書かれる
    - id...エントリを識別する。重複禁止
    - 適応するランレベル ...1,2,3の場合に起動
    - アクション識別子...処理のタイミングを定義する
    - 処理...プロセスを指定する
#### Actionの基本的な考え方
- initプロセスがアクションをforkすることによってinittabを実行していく
- inittabのコマンドを上から順番に実行していく
  - インタプリタではなくコンパイル的な思想
  - はじめにsysinitを実行する
#### アクション識別子
  - boot...システム起動時に実行され、プロセスの終了を待たない
  - bootwait... システム起動時に実行され、終了を待つ
  - ctrlaltdel...SIGHT(ctrl+alt+del)がinitに送られると実行
  - initdefault...デフォルトのランレベルを指定するときに使う
  - once...指定したランレベルになったときに一度実行
  - respawn...指定したプロセスが終了すれば再起動する
  - sysinit...システム起動時にbootやbootwaitよりも先に実行される
  - wait...指定したランレベルになったときに一度実行され、プロセスが終了するまで処理を行なわれない
### 起動スクリプトとランレベル
#### ランレベル
- Red Hat系
  - 0 停止
  - 1 シングルユーザモード
  - 2,3,5 マルチユーザモード
    - 5はGUI
  - 4 未使用
  - 6 再起動
  - S,s シングルユーザモード
- Debian系
  - 0 停止
  - 1 シングルユーザモード
  - 2.3.4.5マルチユーザ
  - 6 再起動
  - s,S シングルユーザ
#### ランレベルに沿った起動スクリプト
- `/etc/rc{runlevel}.d/`配下のスクリプトを実行する
- 具体的な内容に関しては`[S,K]{scriptname}`で記述されている
  - S...ランレベル指定時に起動するサービス。小さいものから順に起動。`start`パラメータが渡される
  - K...他のランレベル移動/終了時に起動するサービス。`Kill`パラメータが渡される
  - ほとんどは、`/ect/init.d/`以下のスクリプトのシンボリックリンク
    - 一部ディストリビューションでは`/etc/rc.d/init.d`に配置
- `/etc/rc{num}.d/`はSとKしか判断しないが、本来のスクリプトにはいろいろ渡せるように実装
- これらは、initではなく、service(systemctlの前進みたいなやつ)によって実行されることが多い
#### 起動スクリプトのコマンド(S,K以外は手動でしか叩かない)
  - start...サービスの開始
  - stop...サービスの終了
  - restart...サービスの再起動
  - condrestart...サービスが起動している場合のみ再起動
  - status...状態を出力する

#### LSB
- linux Standard Base
- Linux標準
  - コマンド、標準ライブラリ、ファイルシステム、印刷サブシステム、X windowなどが規定
- `lsb_release -a`で対応しているLSBバージョンが指定可能
### サービスの自動起動
- スタートアップで起動させる場合、それぞれの`/etc/rc[level].d/`配下にリンクを配置すれば良い
  - `ln -s /etc/init.d/sample /etc/rc5.d/S90sample` など
#### chkconfig
- 上記の手続きを簡易化するコマンド
- `chkconfig [option] [serviceName] [on|off]`
- オプション
  - --list...ランレベルごとのサービスの自動設定の状態を表示
  - --leve {num}...ランレベルを指定する
  - --add...chkconfigで管理する
  - --del...chkconfigで管理しなくする。現在のランレベルに対するリンクは削除する
- on/off...Sリンクを入れる/リンクを削除する設定
  - S/Kに関しては、ランレベルに対応して自動的に入れてくれる
- 例：`chkonfig --level 3 httpd off`
#### じゃあchkconfigの優先度ってどうやって決めるの？
- `/etc/init.d/{script}`に描かれていることがある
- `# chkconfig: 2345 85 15`
  - レベル2,3,4,5で設定する
  - Sは85で、Kは15で設定する
### update-rc.dコマンド
- Debiban系のランレベル起動時設定スクリプト
- `update-rc.d [option] {serviceName} [remove]`
- `update-rc.d [option] {serviceName} [defaults] [NN | sMM kNN]`
- `update-rc.d [option] {serviceName} [start | stop] NN {num}`
- オプション/引数
  - -n...表示するだけで何もしない
  - -f...強制的にシンボリックリンクを削除する
  - remove...起動スクリプトのシンボリックリンクを削除(SもKも消える)
  - enable...自動起動を有効化。Sを作成する
  - disable...自動起動を無効化。Sを削除する
  - defaults...`/etc/init.d/`配下のスクリプト設定に従って作成する
    - `# Default-Start: 2,3,4,5`
    - `# Default-Stop: 0 1 6`など
  - start...Sスクリプトを作成
    - `update-rc.d {sc} start 20 2 3 4 5 . stop 80 0 1 6 .`
    - 優先度S20、K80で作成する
      - ランレベルを指定する場合は、末尾にドットが必要
  - stop...Kスクリプトを作成
## systemd
- 主要なプロセス
  - systemd...systemdメインプロセス
  - systemd-journal...ジャーナル管理プロセス
  - systemd-logind...ログイン処理プロセス
  - systemd-udevd...デバイス検知

#### udevd vs systemd-udev
- udev...`/etc/udev/rules.d/{NN-sc.rules}`に従う。
  - ここに書いてある処理に従って、リンクを生成したり、モジュールをロードする
- systemd-udev...基本はudevと同じ。加えて`.deviceユニット`も生成する
  - systemdがソケットUnitに対して、起動するサービス
  - systemd内に組み込まれていることもある
#### Unit
- ユニットファイル
  - service
  - devuce
  - mount
  - swap
  - target
- 依存関係の記述例
  - Requires=...強い依存関係
  - Wants=...弱い依存関係
  - After=...起動順序のみ制御
  - Before=...起動順序のみ制御
  - BindsTo=...Requires + 自動停止。
  - PartOd=...同時起動、停止グループ
  - Conflicts=...競合している場合、相方を停止
- 有効巡回グラフを組んでいるのでループしない
#### ユニットファイルの配置
- `/etc/systemd/system/`...管理者が投入するUnitファイル。一番先に参照される
- `/run/systemd/system`...一時的に使用する
- `/usr/lib/systemd/system/`...デフォルトのUnitファイル。
  - /usr/libはディストリビューションが配置する領域
- `/lib/systemd/system`...一部のディストリビューション
### systemctl
- start
- stop
- restart
- reload
- status
- is-active
- enable
- disable
- list-unit...起動しているunitを表示する
- list-unit-files...全てのunitを表示する
- list-dependencies

### Unit設定ファイル
セクション + パラメータで定義されている
#### セクション
- [Unit]...ユニット共通
- [Install]...どのターゲットで起動するか定義
- *.seriveのみ存在
  - [Service]
- *.socketのみ存在
  - [Socket]
- *.mountのみ存在
  - [Mount]
- *.automountのみ存在
  - [Automount]
- *.deviceのみ存在
  - [Device]
- *.targetのみ存在
  - [Target]
- *.pathのみ存在
  - [Path]
- *.timerのみ存在
  - [Timer]

#### パラメータ（Unitに記述）
- Description=...サービスの説明
- Documentation=...マニュアルへのパス
- Requiers=...強い依存。このユニットが存在しない場合/起動しない場合、処理を失敗させる。
- Wants=...弱い依存。このユニットが存在しない場合/起動しない場合でも自身の処理は継続
- Before=/After=
- Conflicts=
#### パラメータ(Service)
- Type=...サービス起動タイプ(simple,forking,notify,oneshot)
- ExecStart=...startで実行するコマンド
- ExecStop...stopで実行するコマンド
- ExecReload=...relaodで実行するコマンド
- Restart=......異常終了時の再起動ポリシー(always,on-failure)
- User=/Group=...実行ユーザ、実行グループ
- Environment=...環境変数設定
- WorkingDirectory=...実行ディレクトリ
- PIDFile=...PIDファイルのパス

#### ServiceTypeサービス起動タイプ
- いつサービスが終了したと判定するか？
- 依存関係の解除、連携に対して影響がある。
- simple...プロセス起動直後
- forking...親プロセスが終了し、子プロセスが常駐を開始した時点
- oneshot...こアンドが終了した時点
- notify...サービスがREADY=1を通知した
- dbus...指定したD-BUSを取得した瞬間
- idle...システムがアイドル状態になった瞬間

#### PIDファイルって何？
- あるデーモンが自分のプロセスファイルを記録しておくためのファイル
- `httpd`,`sshd,`,`mysql`が該当する
- `/run/`,`/var/run/` に配置する
- 
#### パラメータ(socket)
#### パラメータ(Timer)
#### パラメータ(Install)
- WantedBy=...systemctl enable時に`{file}.wants/`にシンボリックリンクを作成する
- RequiredBy=...systemctl enable時に、`{file}.required/`にシンボリックリンクを作成する
- Also=...追加で有効化/無効化するユニット
- Alias=...別名を定義する

### RequiresとRequiredByは何が違うのか
- unitにおけるRequiresは、必要とするファイル
  - 起動時に参照する
- installにおけるRequiredbyは必要とされるファイル
  - enableしたときに`{対向ファイル}/{自身}.required`unitファイル(シンボリックリンク)を置きにいく
  - リンクの先は`{自身}.target`になる
  - /runや/etc/systemd/...の優先度に沿ってリンクは更新される
### systemd ログ
#### jornalctl
- ログは、varlog/journal、もしくは/var/run/log/journal/に保存
  - この設定は`.etc.systed.journal.conf`のStorageやSystemMaxuseを確認
  - 変更後は`systemctl restart systemd-jornald`を実行
- オプション
  - -f...ログの末尾を表示し続けれる
  - -n {num}...指定した行数だけログの末尾を表示
  - -p {priority}...指定した重要度以上のものだけ表示
  - -r...ログを新しい順に表示（指定しなければ古いものから）
  - -u {initname}...指定したユニットのログを表示
  - -full...エスケープ文字を除いてプレーンテキストで出力
  - --no-pager...1ページごとの表示をしない.全てのログを出力

# ブートローダ
- GRUB、LILOなどがある。
- 目的はカーネルにCPUの制御を渡すこと
### ブートローダのインストール
- grub-install /dev/sda
- grub2-install /dev/sda
### GRUB
- GRUB Legacyとも呼ばれる。
- カーネルのロードに３段階踏んでいる
  - ステージ1...MBR内に配置され、各ステージを呼び出す(446バイト部分)
    - これはGRUBとLILOを選んだ場合でコードが異なる
  - ステージ1.5...ファイルシステムを使ってステージ2を見つけてロードする。
  - ステージ2...GRUBのメニューはここに書いてる
### GRUB Legacy設定ファイル
- `/boot/gtub/menu.lst`
- ファイルの中身
- 共通設定
  - timeout...メニューを表示する時間
  - default...デフォルトで起動するエントリ番号
  - splashimage...メニュー表示の背景画像
  - hiddenmenu...
- 各メニューエントリの詳細
  - title...エントリ名
  - root...カーネルイメージもしくはOSが格納されているパーティション
  - kernel...カーネルイメージとオプションの設定
  - initrd...処理RAMディスクファイルの指定
  - makeactive...ルートパーティションをアクティブ化
    - 
  - chainloader...指定されたセクタの読み出しと実行
    - 別のルートローダを呼び出すための設定
    - +1と書けば、そのパーティションの最初のセクタを実行できる


### GRUB2
### 起動オプションの設定
### システムの回復

## その他のブートローダ
### SYSLINUX
### PXEブート
###
