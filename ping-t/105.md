# デバイスとLinuxファイルシステム
### ハードディスク
- SATA
- SAS
  - Serial Attached SCSI
- SCSI
  - Small computer system interface
  - ANSIで規格された
  - iSCSIと似た概念
  - 本来はこちらが先
  - VDIよりピンが多いコードを使う
- ※ iSCSI
  - internet Small Conputer Interface
  - CSCI over TCP/IPという言い方の方が正しい
  - ストレージとのやり取りで使うやつ
  - これはEathernet上で扱うことができる
### デバイスファイル
- `/dev`配下のファイル
  - `/dev/sda`...1番目のハードディスク
  - `/dev/sdb`...2番目のハードディスク
  - `/dev/sdc`...3番目のハードディスク
  - `/dev/sdd`...4番目のハードディスク
  - `/dev/sr0`...1番目のCD・DVDドライブ
  - `/dev/st0`...1番目のテープドライブ
- ブロックデバイス
  - ハードディスク、SSD
- キャラクタデバイス
  - キーボード、シリアルポート

### lsblk ブロックデバイスの一覧
- NAME...デバイス名
- MAJ:MIN...メジャー、マイナー番号。カーネルが使う
- RM...リムーバブルかどうか（1 or 0）
- SIZE...容量
- RO...読み取り専用
- TYPE...デバイスの種類（disk,part,rom/lvm）
- MOUNTPOINT(マウントされているパス)
- オプション
  - `-f` ... ファイルシステムの種類,UUIDも表示する
  - `-o` ...必要なものだけを選択
    - NAME,UUID,SIZEなどを指定できる
  - `-p` ... フルパスを表示する
  - `-d` ... ディスクだけを表示
  - `-J` ...json形式で表示
  - `-a` ... loopデバイスを含めてすべて表示
- ※ ループデバイス
  - `mount -o loop {領域/ファイル} /mnt`
  - ROMのように扱える領域として扱う
### パーティションの種類
- 基本パーティション
  - MBTでは、基本と拡張を合わせて最大4つ作成可能
  - 直接OSを安全にインストールできる領域(古いGRUB用)
  - /dev/sda1,dev/sda2,sda3,sda4と命名される
- 拡張パーティション
  - 基本パーティションの設定の一つ
  - 基本パーティションを拡張パーティションとして扱う
  - その内部に論理パーティションを作成することができる
  - 拡張パーティションにしても名命名は変わらない
- 論理パーティション
  - 基本パーティションとして同じように扱うことができる領域
  - /dev/sda5,dev/sda6...と続いて命名される

### ルートフファイルシステム
- MBRにおいて必須なディレクトリ
  - /bin,/sbin...カーネルなどが使用するプログラム
  - /etc...各種設定
  - /lib...ライブラリ
  - /dev...デバイスファイル
### MBR環境でパーティションを管理する fdisk
- MBRでのパーティションの作成、削除、変更、情報表示
- 内容の確認
  - `fdisk -l dev/{v-diskfile}`
- 編集に入ると対話的なモードに入る
  - `dfisk dev/{v-diskfile}`
  - `l`...パーティションタイプを一覧表示
    - 作成可能な一覧を見せるだけ。
    - オプションと印象が違うので注意
  - `n`...パーティションを新規で作成する
  - `d`...パーティションを削除
  - `p`...パーティションテーブルを表示
  - `t`...パーティションタイプの変更
  - `a`...ブートフラグのオン・オフ
  - `w`...パーティションテーブルの変更を保存して終了
  - `q`...パーティションテーブルの変更を保存せずに終了
  - `m`...ヘルプ
### gdisk
- GPT方式でパーティションを作成する
- 各種コマンドはfdiskと同じ
### parted
- MBT,GPTのどちらでも実行可能なパーティション管理コマンド
- 対話モードとコマンドモードの両方を持つ
- `parted /dev{v-diskfile} -s {Command}`
  - ※ 普通のコマンドと順番が違うので注意
  - コマンドを指定しないと対話モードに入る
- 主なサブコマンドまとめ
  - `parted {dir} -s check {num}`
    - 簡単なチェックを実施（現在は廃止）
  - `parted {dir} -s mklabel [gpt|msdos]`
    - 新しいパーティションテーブルを作成
    - MBR方式を作成する場合は、msdosで作成
  - `parted {dir} mkpart [type] [filesystem] start end`
    - type...primary,logical,extended
    - filesystem...ext4,xfs,fat32
    - start...ディスクの始点からパーティションの開始位置
    - end...ディスクの始点からのパーティションの終了位置
  - `part rm {num}`
    - 指定したパーティションの削除
  - `print``p`
    - パーティションテーブルの表示
    - 開始位置と終了位置がわかる
- partedで新しくファイルシステムを作る
  - 1. `mklabel msdos`
  - 2. `mkpart primary ext4 1 1000MB`
    - ※慣例的に0MB目は指定できないようになっている。
  - 3. `print`
  - 4. `q`


### パーティションにファイルシステムを作成する
- 物理ボリューム、もしくは論理ボリュームに対してこれを実行する
- LVM(logical volume manager)などで分割する場合
  - 物理論理ボリュームに対して割り当てを実施する
### ファイルシステムが定義しているもの
- メタデータ
  - 所有者、パーミッション、タイムスタンプ
- 名前と構造
  - ファイル名、ディレクトリの構造の管理
- スペースと管理
  - 空き容量・使用済み領域の管理
- 整合性維持
  - ジャーナル、チェックサム、トランザクション
- アクセス制御
  - 権限、属性管理（標準ACL、拡張属性）
- 最適化
  - 割り当て、遅延割り当て、圧縮など
### ファイルシステムの構成例（ext4）
- スーパーブロック
  - 全体の設定情報
- グループディスクリプタ
- iノードビットマップ
  - 各ファイルのメタデータ
  - 所有者、アクセス権など
- ブロックビットマップ
  - ブロックが使用中か、空きかどうかを記録
- iノードテーブル
  - 各iノードが使用中かどうかを記録。
- データブロック
  - データそのもの
### ファイルシステムの種類
- ext2
  - Linuxの標準だった
- ext3
  - ext2にジャーナリング機能が実装された機能
- ext4
  - ext3の機能拡張
- XFS
  - SGI社製のファイルシステム
  - シリコングラフィクス社が作成
  - 動的inode
- JFS
  - IBM社製のファイルシステム
  - IBM
  - 動的inode
- Btrfs
  - 最新版ファイルシステム
- iso9660
  - CD-ROMの規格
- msdos
  - MS-DOS
- FAT32
  - 4GiB以上は扱えない
- vfat
  - SDカードや古いWindowsで使われるファイルシステム
- exfat
  - FATの後継のフラッシュメモリ
  - 4GiB以上のファイルはこれにする必要がある
- NTFS
  - Windows ファイルシステム用
### mkfs,ファイルシステムを構築する
- `mkfs {partition_name}`
  - デフォルトではext2で作成される
- オプション
  - `-t {format}`
    - フォーマットを指定してファイルシステムを作成する
    - 内部的には、`/sbin/mkfs.{fomatname}`が実行されている
  - `-c`...不良ブロックを検査する
### mke2fs,特定のファイルシステムを作成するコマンド
- ext2,ext3,ext4を作成できる
- `mk2fs -t ext2 /dev/sdb1`など
- オプション
  - `-t`...ファイルシステムを指定して作成する
  - `-j`...ext3を作成する
  - `-c`...実行前に不良ブロックを検査
  - `-m` ...root専用領域を指定する（デフォルトは5%）
    - いっぱいになった時にrootで利用できるようにするため
    - どこかのディレクトリにroot専用領域がある、という話では無い
### Btrfs(B-tree file system)について
- 新しいファイルシステム
- LVM(Logical Volume Manage)を使用せずにRAIDを組む
- ディスクの追加ができるのが強い
- 仕組み
  - 物理ディスク、パーティションをストレージプールとして扱う
  - 複数の物理ボリュームに跨ってファイルシステムを作成する
    - マルチデバイスファイルシステム
  - スナップショットを作成できる
    - スナップショットの範囲を作成できる
    - サブボリュームと呼ぶ
### mkswap スワップ領域を作成する
- `mkswap /dev/sdaX`
- これだけでは有効化はされない
### swapon, スワップ領域を有効化する
- スワップ有効化
### swapoff, スワップ領域を無効化する
- スワップ領域の無効化

# ファイルシステムの管理
- 空き容量の不足、使用できるiノードに対して対応する
### df ファイルシステムの容量を確認する
- sda/vda単位で表示する
- オプション
- `-h`...MiB単位 (1048576を1とする)で表示
- `-H`...MB単位(1000000を1とする)で表示
- `-k`...容量をkb単位で表示する
- `-i`...iノードの使用状況を表示する
- 表示例
  - オプションなし
    - FileSystem...仮想ファイルシステム名
    - 1k-blocks
    - Used
    - available
    - Use
    - mount on...ファイルシステム上のディレクトリ
  - `-i`
    - FileSystem
    - Inodes
    - Iuses
    - Ifree...空いているi-node数
    - Iuse %
    - Mounted on
### du ディレクトリが占める使用
- KB単位で使用しているブロック数を戻す
- デフォルトでは引数に指定された全てのディレクトリを走査する
- ディスク上ではブロックで管理するため`ls -l`よりデカくなる
- オプション
  - `-a`ディレクトリ以外にファイルについても表示する
  - `-s`指定したファイルやディレクトリのみ合計を表示
    - サブディレクトリを表示しない
  - `-l`リンクも含めて集計する
  - `-c`,`--total`すべての容量の合計を最後に表示
  - `-k`容量をKBで表示
  - `-m`容量をMBで表示
  - `-S`サブディレクトリを含めずにブロック計算する
    - ディレクトリはその直下のファイルだけを合算する
  - `-h`読みやすい単位で表示
    - 標準だと単位は付かない
  - `-Ss`サブディレクトリを表示せずに、さらにサブディレクトリの容量を加算しない
### fsck ファイルシステムの診断
- 読み取りモード、もしくはアンマウントした状態で実行する必要あり
- オプション
  - `-t {filesystem}`...ファイルシステムの種類の指定
  - `-a`...自動的に修復を実行
  - `-r`...対話モード
  - `-A`...`/etc/fstab`から読み取る
  - `-N`...何が実行されるのか確認する
### e2fsck 特定のフォーマットのファイルシステムを診断
- ext2,ext3,ext4に対して実行可能
  - `-p`自動的に修復
    - ☆ aじゃないんかーい
  - `-y`問い合わせに常にyesと回答
  - `-n`問い合わせに常にNOと回答
### tune2fs 特定フォーマットのの設定を変更する
- ジャーナルファイルシステムもここで確認可能
- あくまでパラメータを変更するだけで、チェックはできない
- `tune2fs -= /dev/sda5`
- オプション
  - `-c {count}`チェックなしでマウントできる最大回数を指定
  - `-i {num|d|m|w}`ファイルシステムのチェックする最大の時間間隔
    - day,month,weekから決定
    - デフォルトでdayで換算する
    - intervalに由来
  - `-j`...ext2ファイルシステムをext3に変換
  - `-L`...ボリュームラベルのラベル名を設定する
    - ファイルシステムにつける名前のこと
    - ファイルシステム内に書き込まれるので、他環境からも読み取れる
    - 　`/etc/fstab/`も変更しなければならない

### XFS
- 一部のOSのデフォルトのファイルシステム
  - Red Hat Enterprise Linux7
  - CentOS
- 8エクサバイトに対応している
- ジャーナリングファイルシステムを搭載
  - ファイル操作のログを追う機能
  - `ext2`以外はだいたい搭載している
  - `ext3`,`ext4`,`XFS`,`JFS`などなど
- 関連する主なコマンド
  - `mkfs.xfs` ファイルシステムの作成
  - `xfs_info` 情報の表示
  - `xfs_db` デバック
  - `xfs_check` システムチェック
  - `xfs_admin` パラメータを変更する
  - `xfs_fsr` デフラグを実行
    - ディスクに対するブロックの再配置のこと
  - `xfs_repair` システムの修復
### ファイルシステムのマウント
- ディレクトリ上のどこかにディレクトリを連結すること
- `/etc/fstab`にファイルシステムの情報は記載される
  - 記載例
  - 1. /dev/sda1...デバイスファイル名、ラベル、UUIDのいづれかが表示
  - 2. /boot..マウントポイント
  - 3. ext3...ファイルシステム
  - 4. defaults...マウントオプション
    - 読み書きに関する設定事項
  - 5. 1...dumpフラグ
    - dumpコマンドでバックアップ対象になるかどうか管理
  - 6. 2...boot時にfsckがチェックする順序
    - 1,2,3...の順番でfsckがチェックする
    - 0番を指定するとチェックしない
### マウントオプション
- `mount -o {operation}`で実行可能
- パフォーマンスに関する設定
  - sync,async...ファイルシステムでの同期入出力の可否
    - syncの方が安全
  - noatime,realtime
    - ファイルにアクセスした際にaccesstimeを更新するか
    - noatimeにすると一切更新されなくなる
- 自動マウントに関する制御
  - auto,noauto...自動でマウントするか？
  - user
    - 一般ユーザでもマウントを可能にする。
    - アンマウントは本人のみ。
  - users
    - 一般ユーザでマウント可
    - 誰でもアンマウントできる
  - nouser...一般ユーザでの、マウントを禁止
  - defaults..デフォルトに指定する
    - async,auto,dev,exec,nouser,rw,suid
- アクセス制御に関する設定
  - ro,rw...読み込みのみ、双方を許可
  - umask={maskbit}...ユーザマスクを指定
  - exec,noexec...バイナリ実行の許可
  - suid/nosuid...SUID,SGIDを許可する
  - dev/nodev...デバイスファイルを許可
- ファイルごとの権限を持たないディレクトリに権限を与える
  - uid={num}...マウントするディレクトリ
  - gid={num}
  - ※ファイルごとに権限設定できるext2,3などでは無視する

### mount マウントする
- `mount [filesystem] [moountpoint]`
  - マウントポイントやファイルシステムだけでも実行可能
    - その場合は`/etc/fstab`を参照する
- オプション
  - `{オプションなし}`
    - mount状態を表示する
  - `-a`
    - `/etc/fstab`に記載されているファイルシステムをマウント
      - このオプションではnoautoはマウントしない
  - `-t {ファイルシステム}`
    - ファイルシステムの種類を指定
  - `-o` 
    - マウントオプションを指定する
- ※ 一部のマウントオプションは-oなしでも可能
  - `--bind`...2つ目のマウントポイントを作成
  - `--rbind`...サブマウントも再起的にバインド
  - `--move {dir1} {dir2}`
    - dir1からdir2にマウントポイントを変更
    - デバイスを指定する必要はない
- ※ バインドとは
  - 一時的に別のバスにマウントポイントを作成する
  - 再起動すると消える（/etc/fstabに書けば消えない）
  - マウントオプションを変えて読み取り専用とすることも可能
  - ただしアクセス権は元のマウントポイントと変わらないのでセキュリティ的には変わらない
### umount アンマウントする
- `umount [filesystem] [moountpoint]`
- オプション
  - `-a`
    - `/etx/mtab`に記述されているファイルシステムをアンマウント
    - 今マウントされているすべてのファイルシステムが記載
    - ただし、システムに必須な部分はアンマウントしない
  - `-t {filesystem}`
    - 指定したファイルシステムを採用するすべてを選択する
- ☆ unmountではなくてumountなので超注意！！！
# ファイルの配置
### Filesystem Hierachy Standard(FHS)
- ファイルシステム階層標標準。今は3.0
- 必須のディレクトリ
  - /
  - /bin
  - /sbin
  - /etc
  - /dev
  - /lib
### /binに含まれるファイル
- 一般ユーザが使う可能性のあるコマンド
- cat,chgrp,chmod,chown,cp,date,dd,df,dmesg,echo
- hostname,kill,ln,login,ls,mkdir,more,mount
- mv,ps,pwd,rm,rmdir,sed,sh,su,sync,umount,uname
### /sbinに含まれるファイル
- システム管理者だけが実行するコマンド
  - shutdown,fdisk,fsck,ifcinfig,init,mkds,mkswap,reboot
- ※ cd など、bildinコマンドもあるので、すべてがどちらかにあるというわけでない。
### /lib
- 共有ライブラリ、カーネルモジュールが配置
- binやsbinが必要とするライブラリも含まれることに注意
### /var
- `/var/cache`
  - 一時的なキャッシュファイル
- `/var/lock`
  - アプリケーションが排他制御を実行するためのロックファイル
- `/var/log`
  - ログファイルの書き出し
- `/var/run`
  - システムの状態
  - pidやなどもここに保管している場合もある
- `/var/spool`
  - 印刷待ちデータ、予約されたジョブのデータを配置
### /usr
- `/usr/bin`
  - 必須で無いコマンドが配置
- `/usr/sbin`
  - 必須で無いsudo コマンドが配置
- `/usr/lib`
  - プログラムに必要な共有ライブラリを配置
- `/usr/local`
  - ローカルシステムで必要なファイルを配置
    - 独自で作成したコマンド
    - `usr/bin/`をカスタムしたバイナリコマンド
    - ライブラリ
    - ドキュメント
    - `usr/local/bin`,`usr/local/sbin`など
- `/usr/share`
  - システムアーキテクチャに依存しないファイルを配置
    - `/usr/share/man`など
- `/usr/src`
  - カーネルのソースコードなどをここに配置

### その他
- `/etc`
  - システムなどの設定、実ファイル
- `/dev`
  - デバイスにアクセスする仮想ファイル
- `/media`
  - DVD-ROM,リムーバブルメディアのマウントポイント
- `/mnt`
  - 一時的にマウントするファイルシステムのマウントポイント
  - USB,外付けHDDなど
- `/opt`
  - パッケージ管理によるプログラムはここに配置される
- `/proc`
  - カーネル内部にアクセスする仮想ファイル
- `/root`
  - super userのホームディレクトリ
    - FHSでは必須では無い
- `/boot`
  - カーネルイメージ。ファイルシステムの起動前にこいつらが実行されている
- `/home`
  - ユーザごとに作成。必須ではない
- `/tmp`
  - 一時ファイル


### ファイルを検索する
- `find {dir}`
  - 権限のない範囲は検索しない
  - オプション
    - `-name {name}`
      - ファイル名検索

    - `-atime {day-time}`
      - 最終アクセス時刻で検索
    - `-mtime {day-time}`
      - 最終更新時刻で検索
    - `-perm {authority}`
      - アクセス権で検索
      - permissionの略
    - `-size {blocknum}`
      - ファイルサイズで検索
    - `-type {filetype}`
      - ファイルの種類で検索
      - f...ファイル
      - l...シンボリックリンク
      - d...ディレクトリ
    - `-user {username}`
      - ファイルの所有者で表示する
      - ユーザIDでも検索できる
    - `-uid {id}`
      - ファイルの所有者uidで検索する
    - `-print`
      - マッチしたファイルを表示
      - 改行コード`/n`と空白を区分けとして認識する
    - `maxdepth {階層数}`
      - 指定した階層まで検索
    - `mindepth {階層数}`
      - 指定した階層から下を検索
      - 1を指定するとき
        - その配下のディレクトリの中を参照する
        - 該当のディレクトリ上は参照しない
    - `-print0`
      - マッチしたファイルを表示
      - NULL文字`\0`を区分け文字として認識する
      - `xargs -0` と相性がいい
    - `-exec {command} {}\;`
      - マッチしたファイルに対してコマンドを実行
    - `-ok {command} {}\;`
      - マッチしたファイルに対してコマンドを実行
      - 確認が入る

### locate,updatedb,データベースから検索
- データベースを作成してファイルを検索する
- 部分一致で検索する
  - `updatedb`
    - `-e`... データベースに取り込まないパスを指定する
  - だいたいはcrobで更新されるように設定されている
    - `/etc/updatedb.cronf` など
- 検索
  - `locate {filename}`
- 設定ファイル
  - `/etc/updatedb.conf`
### which コマンドの実態の場所を表示
- `which {command}`
- PATHの中から探す
### whereis バイナリ、ソースコード、マニュアルを検索
- /bin,/sbin,/usr/,などが対象範囲
- 環境変数のPATHは見ない
- /homeなどのユーザ利用用途のファイルは見ない
- `whereis {command}`
  - `-b`...バイナリファイルのみを検索
  - `-m`...マニュアルファイルのみを検索
  - `-s`...ソースファイルのみを検索
### type,コマンドがなんなのか調べる 
- 以下を識別可能
  - 組み込み関数
  - エイリアス
  - 予約語
  - ハッシュ（パス）が通っている

### ジャーナリングファイルシステムの搭載
- ファイル操作のログを追う機能
  - `ext2`以外はだいたい搭載している
  - `ext3`,`ext4`,`XFS`,`JFS`などなど

### GPT方式のパーティション
- 128個の基本パーティションを作成可能
- MBRと比較してどうやって見分けてるの？
  - セクタ0の冒頭に`OxEE`が存在
  - セクタ1に"EFI PART"という識別子があるかみる

### デバイスファイルを命名割り当て
- sda,sdb,sdc,sdd...これはディスクのn番目の割り当て
  - 26個を超えると、sdaa,sdab...となる
- dsa1,sda2,sda3...これはパーティションの割り当て
  - 10個を超えると、sda10,sda11...と割り当てが入る
- 冒頭の1文字について
  - sd系
    - これはSCSI,SATA,USBなどによって接続された物理デバイス
  - vd系
    - これはKVMやQEMUなどで割り当てられた仮想ディスクデバイス
  - hd系
    - これはPATA接続のHDDに割り当てられる
  - nvmeXnY系
    - コントローラXの空間番号Y
    - M.2などの規格があるやつ
  
### スワップ領域の見分け方
- MBRの場合
  - パーティションタイプのIDに`0x82`が割り当てられる(MBR)
  - このIDは`fdisl -l /dev/{device}`からIDの一覧は見ることができる
- GPT方式の場合
  - 128バイトのGUIDが割り当てられる
    - `0657fd6d-a4ab-43c4-84e5-0933c84b4f4f`
### 覚えていた方がよいパーティションタイプのID
- MBR
  - 00...未使用領域
  - 01...FAT12
  - 04...FAT16
  - 06...FAT16
  - 07...NTFS,exFAT,HPFS
  - 0b...FAT32
  - 0c...FAT16
  - 0e...FAT16
  - ☆ 0f...拡張パーティション
  - ☆ 82...スワップ
  - ☆ 83...ext2,3,4
  - ☆ 8e...LVM
  - a5...FreeBSD
  - a6...OpenBSD
  - bf...Solaris
  - ee...EFI 保護パーティション
    - GPTディスクにMBRを載せるとバックアップとして担保する
  - ef...EFI System Partition
    - UEFIのfatで使用する領域

###　`etc/fstab`を再確認
- 何が書かれていればいいんだっけ？
- 1. デバイス指定(以下のいずれか1つ)　
  - UUID(これが推奨されている)
  - LABEL
  - /dev/{device名}(名前がかわるかもしれないので非推奨)
- 2. マウントポイント
- 3. ファイルシステムの種類
- 4. mount option
- 5. dump設定
- 6. fsck順序
- マウントを認識させるには`sudo mount -a`


### UUIDの思想
- 世界的に重複しないことを前提に設計されている
- ランダム値(v3)やハッシュ(v4)が主流
- コマンドから手動で変更も可能
  - `tune2fs -U <UUID> {dev}`
  - 普通は手動で決めるならラベルで調整する
  - ディスククローンとかやると使う

### UUIDの確認
- `blkid`
  - block indentifierの略らしい
  - ファイルシステムから情報を読み出す
- ☆ UUIDが無いファイルシステムもある
  - ISO9660(CD/DVD)
  - NFS(Network File System)
    - マウント側（クライアント側で定義する）
  - FAT(FAT12,16,32)
    - Volume Lavelで管理する
- `lsblk` 
  - 本来はディスクの物理/論理を階層構造で表してくれるもの
  - `lblk -u NAME,UUID`などで持って来れる
### マウントまでの手続き
- 0. カーネルによるデバイスの認識
- 1. デバイスノードの作成
  - mknod(手動でdev配下にマウント)
  - udev(自動認識してファイルシステムに書き込むやつ)
  - udevの仕組み
    - 1. デバイス接続時に、カーネルが`/sys/`にデバイス情報を展開
    - 2. `udevd`デーモンが変更を検知
    - 3. `/etc/udev/ruled.d`の設定ファイルを参照
      - デバイスのクラスに対する挙動を定義
      - 所有権の設定や、パーミッション
    - 4. `/dev/XXX`のような名前を定義する
- 2. (option)パーティションの作成
  - fdisk,gdisk,parted
  - こいつらは、ファイルシステムも同時に定義可能
- 3. (option)ファイルシステムの作成
  - mkfs,mk2fs
  - このタイミングでディスク/パーティションにUUIDが割り当て
- 4. マウント
  - mount -aや/etc/fstabで管理

### /proc/mounts,現在マウントされているfsを管理
- catすと以下を戻す
  - ソース
  - マウントポイント
  - ファイルシステムタイプ
  - マウントオプション
  - ダンプフラグ
  - fsck順序
- `/etc/fstab`と違いこちらはリアルタイムの情報
- `/proc/self/mounts`にも同様の情報が掲載
    - self...PIDに依存した参照権限をもつ仮想ファイル群
      - UIDじゃないよー！

### initramsfs と`/etc/fstab`
- systemd...udevの管理もやる
  - つまり、udevが起動するのはカーネル起動後
- BIOSなどが管理するinitramsは別物
  - /etc/fstabとかは見ない
  - 以下はinitramsfsでは管理しない
    - `/home`
    - `/var`など
### systemdによるファイルシステムに関するユニット
- `systemd-fstab-genetator`
  - `/etc/fstab`から`.mount`,`*swap`ユニットを生成
- `*.mount`ユニット
  - マウントに対して`{entry}.mount`ユニットが作成
    - /home  ... home.mount
    - /var/log ... var-log.mount
- `*swap`ユニット
  - スワップ領域
- `-.mount`
  - ルートシステムのマウント定義のこと

### (復習)`unit`ってなんだっけ？
- 設定ファイルによって定義されている
  - タイプによってその内容は異なる
- スクリプトをいつ実行するのか？を定義
- 基本構成。いくつかのセクションを所有する
- `service`の場合
  - Unit...ユニットの説明、依存関係
  - service..実行コマンドや動作オプション
  - install...enableになった時のターゲットの結びつけ
- `mount`の場合
  - Unit
  - Mount
    - 仮想ファイル、マウント先、マウントオプションを定義
  - Install
- `Swap`の場合
  - Unit
  - Swap
    - どの仮想ファイルか？
  - Install
### (復習)systemdのタイプ
- `service`
  - サービスの起動、管理
  - プロセスとはこのこと
- `mount`
  - ファイルシステムのマウント
- `swap`
  - スワップ領域
- `socket`
  - ソケットの管理
- `device`
  - デバイスの検出、依存関係設定
- `target`
  - 複数ユニットのグルーピング
- `automount`
  - 自動マウントの制御
- `timer`
  - 時間イベント
- `path`
  - ファイル変更トリガー
- `slice`
  - cgroupによるリソース制御単位


### なんで`mount`が存在するのにユニットタイプにmountがあるのか
- systemdで並列処理できるようになった関係
  - マウントの順序を明示的にする必要がある
- マウント失敗時の動作を定義できる

### mount,swapユニット、etc/fstabの関係
- 【起動時】
- 1. systemd起動
- 2. systemdが`/etc/fstab`の内容をユニット定義ファイルを生成する
  - `systemd-fstab-generator`がこれを実行
  - mountユニット`.mountファイル`
  - sawpユニット`.swapファイル`
- 【動的に/fstab/etcに追記した場合】or【ユニットファイルを書いた場合】
  - 1. 追記した直後にはマウントポイントは認識されない
  - 2. systemdに認識させる
    - `systemctl deamon-reload`
    - `systemctl start {mountpoint}.mount`
  - 3. mountコマンドを実行
    - `mount -a`


### ディレクトリに付与する権限
- 読み取りのみ`--r`
  - `ls`コマンドは可能
  - `cd`できない
- 実行のみ`--x`
  - `cd`は可能
  - `ls`で中身が見えない
- 読み取り＋実行`r-x`
  - 一般的なディレクトリのパーミッション
  - `cd`,`ls`の双方が可能
  - ファイルの編集はできない
- 簡単に
  - 読み取り権限があればlsできて、
  - 実行権限があればcdできる



### FHS(Filesystem Hierachy Standard)
- Linuxの標準的なディレクトリ構成の規格
- ルートディレクトリの構成を記載したもの
- 全てがこれに従わなければならないわけではない
  - 例：alpineには`usr/local`はない
  - Android系も`/data`や`/system`等、独自
  - windows FAT系も`/etc`,`usr`が無い
- 具体的な例
  - `/usr`は読み取り専用でもシステムが起動すること
  - `/usr/local`はパッケージの管理対象外
  - `/tmp`は再起動で削除、
  - `/var/tmp`は再起動でも保持する
  - `/etc`配下はバイナリを入れず、読解可能