# TCP/IP基礎

### TCP(Transmission Control Protocol)
- コネクション型
  - 損失したパケットを再送する
  - FTP,Telnet,POP,SMTPが上位で動作する
### UDP(User Datagram Protocol)
- コネクションレス型

### ICMP(Internet Control Message Protocol)
- ping,tracerouteはこれを使用する

# IPv4
### ネットワーク部とホスト部で分割
- サブネットマスクで分断されている
- ホスト部を全て1にするとブロードキャストアドレスになる

### クラス
- IP全体を分けた概念(1970~1980にNATがない頃に使用されていた)
  - A 0.0.0.0  ~ 127.255.255.255
  - B 128.0.0.0 ~ 191.255.255.255
  - C 192.0.0.0 ~ 223.255.255.255
  - D 224.0.0.0 ~ 239.255.255.255
  - E 240.0.0.0 ~ 255.255.255.255
### プライベートアドレスのクラス
- A 10.0.0.0 ~ 10.255.255.255 /8 
- B 172.16.0.0 ~ 172.31.255.255 /12
- C 192.168.0.0 ~ 192.168.255.255 /16

### CIDER(Classless Inter-Domain Routinig)
- 慣例的に上記のプライベートIPアドレスのクラスに沿うことが多い

# IPv6
- 128bit アドレス
- 記法に関する制約
  - ブロックの先頭の0は省略できる
  - 0が連続する場合は何も書かなくても良い。ただし1IPあたり1箇所だけ
- ローカルループバックアドレス
  - 自身を指すアドレス
  - 全て0で最後だけ1
  - `::1/128`
- グローバルユニキャストアドレス
  - グローバルでしよされるIPV6
  - `2000::/3`
- ローカルユニキャストアドレス
  - プライベートでIPなどの末端で使用できるプライベートIP
  - `fe80::/10`
- マルチキャストアドレス
  - ブロードキャストアドレスとも呼ばれる
  - `ff00::/8`
- リンクローカルユニット
  - `fe80::/8`
  - とりあえずローカルに限り端末に割り当てるIP
  - 仕様としてネットワークに出れない
  - Ipv6の仕様
  - MACアドレスをベースとし、重複検知もするのでローカルで被らない
  - ルータから先には行けない
### IPv6特有の命名
- IPv4のネットワーク部...プレフィックス(64bit固定)
- IPv4のホスト部...インタフェースID(64bit固定)
- つまり、サブネットに対して固定のプレフィクスを使用する


### IPv6のポート指定
- IP側を[]で囲む習慣がある
-`[ff00::22ad]:80`
# ポート
- 20 TCP
  - FTP転送用
- 21 TCP/UDP
  - FTP制御
- 22 TCP
  - SSH
- 23
  - Telnet
- 25
  - SMTP
- 53
  - DNS
- 80
  - HTTP
- 110
  - POP3
- 123
  - NTP
- 139
  - NetBIOS(Microsoftネットワーク)
- 143
  - IMAP
- 161
  - SNMP
  - Simple Network Mangement Protocol
- 162
  - SNOP Trap
- 389
  - LDAP
- 443
  - HTTTPS
- 465
  - SMTP over SSL/TLS
  - メール用
- 514
  - Syslog
- 636
  - LDAP over SSL/TLS
- 993
  - IMAPS
- 995
  - POP3s
 ### well known port
 - IANA(Internet Assigned Numbers Authority)によって管理
 - 1024~ 49151

### ポートサービスの対応表
- `/etc/services`


# ネットワークの設定
### ホストネーム
- `/etc/hostname`
  - 永続的なホストネームを保存する
- `$HOSTNAME`...これはシェル変数で環境変数ではない
- これを編集しても反映されない
  - `hostnamectl set-hostname {new hostname}`
  - `systemctl restart systed-logind`
  - が有効

### ホスト名を編集する、hostnamectl
- オプション
  - オプションなし...ホスト名と関連情報を表示
  - `hostnamectl status`ホスト名と関連情報を表示
  - `hostnamectl set-hostname {hostname}`

### /etc/hostsファイル
- ホスト名とIPアドレスの対応を記述
- ローカル版DNSのようなイメージ
- どちらを優先するのか、実際は`/etc/nsswitch.conf`で指定

## NIFの設定を確認する
- Debian系`/etc/network/interfaces`
  - ループバックの設定
    - `auto lo`
    - `iface lo inet loopbacklo`
  - 個別のethの設定
    - `iface eth0 inet static`
      - ここがinret dhcpならdhcpで設定する
        - この場合、ブロードキャストするので、dhcpのアドレスは知らなくて良い
    - `adress XXX.XXX.XXX`
    - `netmask 255.255.XXX.XXX`
    - `broadcast XXX.XXX.XXX.255`
    - `gateway XXX.XXX.XXX.XXX`
      - デフォルトゲートウェイ
    - `dns-domain sample.com`
    - `dns-nameserver XXX.XXX.XXX.XXX`
  - 語句
    - lo...loopバックの略。自分自身を指す 
    - inet...ipv4のこと。ipv6はinet6と書く
  - 注釈
    - ループバックはethを割り当てない（はえー）
- RedHat系`etc/sysconf/netwoek-scripts/*`
  - インタフェースごとにファイルを持つ
    - 例：`/etc/sysconf/network-scripts/ifcfg-eth0`
  - 内容
    - `TYPE=Eathernet`
    - `BOOTPROTO=static`
    - `NAME=eth0`
    - `ONBOOT=yes`
    - `HWADDR=XX:XX:XX:XX:XX:XX`
      - MACアドレス
    - `DNSI=XXX.XXX.XXX.XXX`
      - DNS参照先
    - `DOMAIN=user.com`
      - 自身のドメイン名
    - `IPADDR=XXX.XXX.XXX.XXX`
      - 自身のIP
    - `NETMASK=255.255.XXX.XXX`
      - サブネットマスク
    - `GATEWAY=XXX.XXX.XXX.XXX`
      - デフォルトゲートウェイ

### NETWORK MANAGERによる設定
- CENTOS系ではファイル編集ではなくnmuiやnmcliで設定したりする
- これらはNetworkMangerという名前でユニットが作られる
- `systemctl status NetworkManger`で確認可能

### NetworkManagerの状態を確認する：nmcli
- `nmcli {object} [command]`
- オブジェクト
  - general(g)...自身の設定
  - network(n)...ネットワークのON/OFFや現在の状態
  - radio(r)...wifi,ブロードバンドのON、OFF
  - connection(c)...接続ごとの有効化、その設定。一度接続すると記憶される接続先の管理
  - device(d)...デバイスの接続、状態表示、削除やwifiの検索
    - マネージャの管理対象に含めるか？という話
    - カーネルには残ってる
- コマンド
  - `nmcli general status`
    - マネージャの状態を表示
  - `nmcli general hostname`
  - `necli general hostname {hostname}`
    - ホストネームを表示/変更
  - `nmcli network on`
    - これがoffだと全てのネットワークに接続できない
  - `nmcli network connectivity`
  - `nmcli network connectivity check`
    - checkでネットワークの状態を再確認
  - `nmcli radio wifi`
    - wifiの状態を表示
  - `nmcli radio wifi on`
  - `nmcli radio wwan on`
    - wwan...モバイルブロードバンドのこと
    - テザリングではなく、
  - `nmcli radio all on`
  - `nmcli connection show`
  - `nmcli connection show --active`
    - 接続の状態を表示する
  - `mncli connection modify {interface} {param}`
  - `nmcli connection up {ID}`
  - `nmcli connection down {ID}`
    - 接続開始/停止
  - `nmcli device status`
  - `nmcli device show {interface}`
  - `nmcli device connect {interface}`
  - `nmcli device monitor {nterface}`
  - `nmcli device wifi list`
  - `nmcli device wifi connect {SSID}`
  - `nmcli device wifi hospot`
  - `nmcli device wifi rescan`

# トラブルシューティング
### よく使うコマンド
- `ping [option] {hostname | ipaddr}`
  - オプション
    - `-c {num}`...指定した回数だけICMPパケットを送信
    - `-i {span}`...指定した秒数ごとにICMP
      - デフォルトは1s
  - ※ ipv6は`ping6`というコマンドがある
- `traceroute {hostname | ip}`
  - 到達までの経路を示す
  - ※ ipv6は`traceroute6`がある
- `tracepath {hostname | ip}[/{port}]`
  - tracerouteと同様に経路を示す
  - Linux限定の仕様
  - rootでなくてもユーザレベルでも使用できる
  - ipv6はtracepath6が使用可能

- `hostname`コマンド
  - オプションなし...現在のホストネームを戻す
  - `hostname {hostname}`ホストネームの変更

### ネットワークに関する情報の表示、netstat
- `netstat [option]`
  - `-a`...全てのソケットを表示
  - `-c`...状況を1sごとにおいかける
  - `-i`...インタフェースの状態を表示
  - `-n`...アドレスやポートを数値で表示
  - `-p`...PIDとプロセス名を表示
  - `-r`...ルーティングテーブルを表示
  - `-t`...TCPポートを表示
  - `-u`...UDPポートを表示
- ※ ホストはDNSによって解決するため、DNSが停止していると戻らない
  - -nを使用すれば、DNSを使用しない

### ncコマンド
- `nc [option] [host] [port_num]`
  - 指定したhostに接続の要求を実施(TCP3handshake等)
  - FINはしないため、接続はスタックする
- バイト列で表示する
- オプションs
  - `-l`...指定したポートをリッスン
    - ポートに入ってきた最初の内容を待つ
    - TCPのタイムアウトも無効化する
  - `-p {port}`...ポート番号を指定
  - `-u`...UDPを利用
  - `-o {outfile}`...結果をファイルに出力
- リダイレクトでそのポートに対してバイト列を送信することもできる
  - `nc {host.com} < byte.t.txt`
  - `echo hello > nc {hostname}`など
- TCP/UDPのツールなので、FINを送信しない

### routeコマンド
- ルーティングテーブルの表示、操作
- `route [option]`
- `route add [param]`...ルーティングテーブルの追加
- `route del [param]`...ルーティングテーブルの削除
- オプション
  - `-F`...カーネルのルーティングテーブルを表示
  - `-C`...カーネルのルーティングキャッシュを表示
- 出力
  - `Destination`...この宛のシグナルがきたら
  - `Gateway`...（ゲートウェイに送るなら）ゲートウェイのIP
    - Destinationに直接送るなら0.0.0.0
  - `Genmask`
    - Destinationにかかるサブネットマスク
  - `Flags`
    - 経路の状態
      - U:経路が有効
      - H:宛先はホスト
      - G:ゲートウェイを使用
      - !:経路は無効
  - `Metric`
    - 宛先までの距離
  - `Ref`
    - ルートの参照数
  - `Use`
    - 経路の参照回数
  - `iface`
    - この経路を使うNIF(loやEth0など)
- 規則
  - 最長一致経路を優先する
  - サブネットが狭いものが優先
  - 全く同じ場合はロードバランシング的な作用もする
- 手動による設定
  - route add -net 192.168.0.0 netmask 255.255.0.0 gw 172.30.0.254

### Linuxをルータとして使用する
- 通常は許可していない
- 設定`/proc/sys/net/ipv4/ip_foward`が許可されているか？
  - 0:許可しない
  - 1:許可
- ※ 自身から出るパケットは`route`の結果を参照している
### ipコマンド
- Red hat,CentOSはipコマンドで設定しがち
- arpテーブル、NIF、ルートテーブルの制御
- ip {what} {command}
- what 
  - `link`...データリンク層
  - `addr`...IPアドレス
  - `route`...ルーティングテーブル
- command
  - `show`...参照
  - `add`...設定
- 例：
  - `ip link show`...データリンク層の情報が見える
    - ethのMACアドレスなど
  - `ip route show`...ルートテーブルが見える
  - `ip addr show eth0`...ソケットの情報が見える
    - inet XXX~XXX/RR
    - XXX~が自身のIP
    - RRは接続しているサブネットの広さ
  - `ip addr add 192.168.11.12/24 dev eht0`
    - サブネットマスクも必須。
    - L3の情報なのでL2を取得するARPではダメ
    - DHCPが設定されていれば自動取得される
  - `ip route add default via 192.168.11.1`
    - DHCPがあればここも自動で設定されるはず
  
### iconfigコマンド
- 確認のほかに、IPアドレスの設定もできる
- こちらは一時的な変更のため、再起動すると消える
- こちらの方が、IPコマンドより古い
- `iconfig [NIF] {pram}`
- parameter
  - paramなしでethの設定を一覧表示
  - `iconfig eth0 123.123.123.123`
    - IPアドレスを設定
  - `iconfig eth0 netmask 255.255.255.0`
    - サブネットマスクを定義
  - `iconfig eth0 up`
    - NIFを有効化
  - `iconfig eth1 down`
    - NIFを無効化


# DNS
- ホスト名とIPアドレスを変換する。名前解決を実行する
- ホスト → IP 順引き
- IP → ホスト 逆引き
- `etc/hosts`ファイルが基本は処理する
### FQDN (Fully Qualified Domain Name:完全修飾ドメイン)
- {host名}.{ドメイン}で構成される
- ドメイン名
  - `.`
    - ルートドメイン
  - `com`
    - トップレベルドメイン
  - `google`
    - セカンドレベルドメイン

### 名前解決のための設定ファイル。
- DNSの場所を記載する設定ファイルをクライアントに規定
- `/etc/resolv.conf`
  - domain XXX.com...ホストが所属するドメイン
  - search XXX.xom...ドメイン名が省略された際の検索ドメイン
  - nameserver XXX.XXX.XXX.XXX...参照先DNS
  - nameserver 8.8.8.8...参照先DNS(外部)
    - 上から問い合わせる
    - 再帰な問い合わせをするかどうかはDNS次第
### エンティティの処理 `/etc/nsswitch.conf`
- 様々な作業でどの順序で名前解決を実行するか
- `getent {entity}`コマンドはここの記載を参照する
- `/etc/nsswitch.conf`に問い合わせる作業
  - passwd...ユーザ名参照
  - group...グループ参照
  - shadow...パスワード参照
  - host...名前解決
- 問い合わせ先位に指定可能な宛先
  - files...ローカルの適したファイルによって解決する
  - ldap...ldapサーバによって解決する
  - dns...dnsサーバによって解決する
  - 先に書かれている順で解決する
- 例
  - `passwd: files ldap`
  - `hosts: files dns ldap`

### systemd-resolved
- systemdによる名前解決
- systemd-resolvedサービスを使用する
- `/etc/systemd/resolved.conf`を参照する
- 記載
  - [Reslove]
  - DNS=X.X.X.X X.X.X.X ~IPv6
  - Domains= example.com
  - DNSSEC=no
## DNS管理コマンド
### `host {hostname | IP} [query dns server]`
  - そのIPやホストが誰が管理している/どのIPを持っているのかを検索
  - `host hostname`...これは逆引き
  - `host IP`...これは順引き
- オプション
  - `-v`...詳細に検索する
  - 後ろにDNSサーバをつけると、そのサーバでの設定を見てくれる
### digコマンド
`dig [option] [@{dns}] {host|domain} [q_type]`
- 詳細な結果を戻す
  - HEADER(クエリの種類、フラグ)
  - QUESTION(質問内容)
  - ANSWER(応答)
  - AUTHORITY(権威DNS情報)
  - ADDITIONAL(追加情報)
- オプション
  - `-x`...IPアドレスからホスト名を検索
- 検索タイプ(q_type)
  - `a`...ipアドレス
  - `aaaa`...ipv6
  - `any`...全ての情報
  - `mx`...メールサーバの情報
  - `ns`...ネームサーバの情報
- 例：
  - `dig -v @8.8.8.8 gmail.com MX`
    - googleのdnsサーバにgmailの場所知ってるか聞いてみた
  - @を指定しないとデフォルトのdnsに聞きに行く