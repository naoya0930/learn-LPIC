# LDIP 
## Linuxのインストールとパッケージ管理


### Linux パーティション
- ルートファイルシステムパーティション
- スワップパーティション
  - ※ ルートファイルからスワップファイルとして割り当てることもできるがこれはこことは別の仕組み
- EFIシステムパーティション
  - 100MB程度
  - UEFIに認識してもらう仕組み
  - ブートローダもここに入っている

### RAID,LVM
- Lofical Volume Manager
- 物理volmeの見た目の解体を実施したい
- 1. 物理ボリューム(50+50+50)
- 1.1 RAIDがある場合はここに入る
- 2. 論理ボリュームグループ(150)
  - 物理ボリュームの合算値
- 3. 論理ボリューム(25+125)
  - 論理的なパーティション
- 4. マウントポイント
  - どの用途で使用するか？
  - ルートシステムからどうアクセスするか？

### よくパーティションされる領域
- こいつらはファイルシステムのマウントポイントによって切り分ける
- `/home`,`/var`,`/usr`,`/boot`
- home
  - 引っこ抜いて他のデバイスに刺せるため
- var
  -  ログ情報などが肥大化するため
- usr
  - プログラム、ライブラリ、ドキュメントが配置
- boot
  - RAID構成がOS起動後のため、失敗することがあるため別パーティションとして、RAIDから外すことがある


### ハードディスクのレイアウト設計

- Redhat Linuxでに適切なスワップ領域
  - RAMが2GB以下の場合、RAMの2倍
  - RAMが8GB以下の場合、RAMと同量
  - RAMが64GB以下の場合、4GB〜RAMの0.5GB
  - RAMが64GB以上の場合、少なくとも4GB

# 2.2
## ファイルシステムについて考えていく
- tmpfs
## ブロックデバイスのパス
- ルートシステムとは全く別の意味のパス
- /dev/sda
- /dev/sda
### ブートローダ,GRAB
#### Grab Legacy(古いやつ)
- 設定ファイルは`/boot/grubmenu.lst`に存在
- どのカーネルを起動するのか選ぶ
  - 論理パーティションが認識できない
- ブートローダに表示されるメニュー
``` sample.cfg
# 初期で選択しているエントリの番号
default 0
# timeoutだけ待つ
timeout 10
# Grab起動時にメニュー上に表示される名前
title   Solaris
    # どのカーネルを起動するのか？の物理ディスクを選択する
    # grubはRAIDなどを認識できないので、物理ディスクの指定が必須
    root (hd0,0)
    # 使用するカーネルファイルと起動パラメータ
    kernel /boot/vmlinuz-version root=LABEL=/ dev_name=sda1
    # 初期RAMディスクのイメージの指定
    initrd /boot/initrd-version.img
title   Solaris (failsafe)
    root (hd0,0)
    kernel /boot/vmlinuz-version failsafe root=LABEL=/
    initrd /boot/initrd-version.img
title   Solaris Live Upgrade
    root (hd0,1)
    kernel /boot/vmlinuz-version root=LABEL=/dev/sda2
    initrd /boot/initrd-version.img
title   Another Operating System
    root (hd0,2)
    kernel /path/to/another/os/kernel.img
    initrd /path/to/another/os/initrd.img
```

#### Grub 2
- `/boot/grub/grub.cfg`
- ファイル例。これは直接編集しない
```sample
set default=0
set timeout=5

menuentry 'Ubuntu, with Linux 5.15.0-100-generic' --class ubuntu --class gnu-linux --class gnu {
    recordfail
    load_video
    gfxmode $linux_gfx_mode
    insmod gzio
    insmod part_gpt
    insmod ext2
    set root='hd0,gpt2'
    linux /boot/vmlinuz-5.15.0-100-generic root=UUID=1234abcd-5678-efgh-ijkl-9876mnopqrst ro quiet splash
    initrd /boot/initrd.img-5.15.0-100-generic
}

menuentry 'Ubuntu, with Linux 5.15.0-100-generic (recovery mode)' --class ubuntu --class gnu-linux --class gnu {
    recordfail
    load_video
    insmod gzio
    insmod part_gpt
    insmod ext2
    set root='hd0,gpt2'
    linux /boot/vmlinuz-5.15.0-100-generic root=UUID=1234abcd-5678-efgh-ijkl-9876mnopqrst ro recovery nomodeset
    initrd /boot/initrd.img-5.15.0-100-generic
}
```
#### `grub-mkconfig`
  - このコマンドで生成する
  - `grub-mkconfig -o /boot/grub/grub.cfg`
#### grub-mkconfigが参照するファイル、ディレクトリ
  - `/etc/default/grub`
    - 基本設定
  - `/etc/grub.d/`
    - メニューエントリの自動生成
  - `/boot/grub/grub.cfg`
    - こいつが生成される
#### /etc/default/grub に何書いてるん？
- GRUB_TIMEOUT
  - 起動メニューがタイムアウトするまでの秒数
- GRUB_DEFAULT
  - タイムアウトしたときの挙動
- GRUB_DISABLE_SUBMENU
- GRUB_TERMINAL_OUTPUT
- GRUB_CMDLINE_LINUX
  - カーネルに渡される起動オプション
#### ブートオプションの指定
- ブートシステムの指定
- カーネルのシェルから直接渡すことができる
  - `ro root=/dev/VolGroup00/LogVol00 rhgb quiet single`
    - ro ... read only
    - root=/dev/VolGroup00/LogVol00 ... ルートボリューム
    - rhgb ... Red Hat Graphical Boot (起動時のブート画面を出す)
    - quiet ... カーネルの詳細を最小限にする
    - single ... シングルユーザモード

# 2.3 共有ライブラリ支援
### ライブラリ
  - スタティックリンク
    - コンパイル時にプログラムに埋め込む
  - ダイナミックリンク
    - シンボリックリンク
    - `lib~.so~`というリンクでライブラリ側に置かれるファイル
    - 「リンクという作業」によって生成される
### コンパイル vs リンク
- 使い方は、コンパイル済みのファイルに対して、リンクをつける
- コンパイル
  - ソースファイル`.c`からオブジェクトファイル`.o`を生成する
  - オブジェクトファイルの生成時には、まだリンクは設定されていない
- リンク
  - オブジェクトファイルとライブラリからを生成する
  - 静的ライブラリ`.a`と、動的ライブラリ`.so`がある
- コマンド例：
  - `gcc main.o -lmylib -lm -lpthread -o myprogram`
    - myprogramを出力。ただし、オブジェクトファイルが必要とするリンクを全て指定する必要がある
    - lmylib や　lpthreadを参照
      - ここでは、静的リンクや、動的リンクを指定しなくても良い
- リンクパスの指定
  - `/lib`、`/usr/lib`、`usr/local/lib`
  - -Lでリンクパスを追加できる
    - `gcc main.o -L/home/user/mylib -o out` など

### gcc -l オプション
- libを省略することができる
- `-lm`と指定すれば、`-libm`のことを指すこともできる
- C言語でいうと、抽象メソッドに対して実態をぶち込む
### リンカーコマンド
- `ld -r`
- いくつかのリンクオブジェクトをまとめて新しいリンクを作成する

### ELF
- Executable and Linkable Format
- この規格によってリンクを読み取っている
- 実行ファイル・共有ライブラリ、オブジェクトファイルなどを表現するバイナリ形式
- 具体的に
  - 実行可能バイナリ
    - a.out や`/bin`配下に配置するファイル
  - 共有ライブラリ
    - .soや.a
  - リンカの入力ファイル
    - .o
  - カーネルモジュール
- 構成
  - ELFヘッダー
    - ファイル全体の情報
    - アーキテクチャ、エントリポイント、種別
  - プログラムヘッダー
    - 実行時に必要なセグメント情報
    - メモリへのマッピング
  - セクションヘッダー
    - リンカーが必要とする詳細情報
    - コードやデータの位置
- ファイル実行する場合は、`_start`から始まる、ここからのリンクの連鎖でプログラムは動作する

### lddコマンド
- 実行ファイルに対してリンクされている動的リンクを認識する
- `ldd /bin/cat`

### ライブラリの保管場所を追記する
- デフォルトの参照
  - `/lib`
  - `/usr/lib/`
- それ以外のパスを参照する場合は、`/etc/ld.so.conf`に記述する
- もしくは、gccなどの場合は、 -Lを追記する
- もしくは環境変数の `LD_LIBRARY_PATH`にディレクトリを追記する
  - ここに書いたものが一番優先される
- 備忘
  - 実際には実行毎にこれらを参照しているわけでは無い。
  - バイナリキャッシュの`/etc/ld.so.cache`に読み込んで実行している
  - `ldconfig`でこのキャッシュを更新できる

# Debian パッケージ管理
- 