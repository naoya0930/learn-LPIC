# GUIを実現する

### X Window System
- 純粋にXとか呼ばれる
- UNIX向けのGUIインタフェースの規格
- この規格に沿って色々な実装が実施されている
- X.Org Foundationが管理している
### Xのバージョン
- X10...1986
- X11...1987
- これ以降はX11が拡張して使用され続けけている。

### 現行仕様はX11
- 以下のようなライブラリがある
  - Xfree86
  - X.Org server
  - Xquartz (mac)
### Xの思想
- サーバクライアント方式を採用している
  - Xサーバ
    - モニター、ビデオカード、キーボードの管理
  - Xクライアント
    - ブラウザなどのアプリケーション
  - サーバとクライアントは分離可能と考える
- リモートデスクトップのように、全く異なる場所にあるディスプレイに対して描写を実行できる

### wayland　vs X
- wayland
  - gnome(Linuxデスクトップ環境)などがイベントを送る先
    - クリックした
    - マウスを動かしたなど
  - このようなイベントに対して、GPUにどのような演算をするのか教える
  - GPUはgnomeなどに直接値を戻す
- X
  - Xサーバがデスクトップ環境を取り次ぐ
  - GPUの計算結果も一度Xサーバが受け取ってから処理する

### X.Orgの編集(X11)
- 設定ファイル
  - `/etc/X11/xorg.conf`
  - `/etc/X11/xorg.conf.d/`配下に配置することもある
  - ハードウェア設定を実施できる
- 記述方法

```
Section {name}
    {param} "param"
    {param} "param"
EndSection
```

- 主要なセクション
  - Files ... フォントやカラーデータベースファイルのパス
  - Module ... ダイナミックモジュールの設定
  - InputDevice ... キーボードやマウスの設定
  - InputClass ... 入力装置のクラス
  - Device ... ビデオカードの設定
  - Monitor ... モニターの設定
  - Modes... ビデオモードの設定
  - Screen ... ディスプレイの色深度やサイズ
  - ServerLayout ... 入出力デバイスとスクリーンの設定
### フォント管理
- xfsという仕組みを使って管理していた。
  - x-font-server
  - フォント用のサーバが配置されることがあった。
  - xorg.confのfilesで指定する

### xorg.confを設定する
- ハードウェアをスキャンして自動でxorg.confを生成するコマンドもある
  - `Xorg -configure`
- xorg.confを仮実行してみる
  - `X -config /root/xorg.conf.new`
- 本番環境で使用するには`/etc/X11/xorg.conf`に配置する

### X Window systemのログ
- `/var/log/Xorg.{displaynum}.log`
- `~/.xsession-errors`

### X window systemの周辺システム
- ディスクトップ環境(DE)
  - 例
    - Gnome(Red Hut)
    - KDE Plasma(Qtベース)
    - Xfce(軽量)
  - ウィンドウマネージャ、タスクバー、設定設定ツールを含むGUIを構成する統合環境を指す
  - ディスプレイマネージャを含めてディスクトップ環境と言うこともある。
- ディスプレイマネージャ(DM)
  - ログイン画面を提供する
  - 例
    - GDM(Gnome Display manager)
    - SDDM(KDEの標準)
    - LightDM(Ubuntu)
    - XDM(古いもの)
- ウィンドウマネージャ(WM)
  - タイトルバー、描写、配置、最小化、最大化ボタンなどを担当
  - 例
    - Mutter(Gnome, Waylandコンポジタを内包)
    - KWin(KDEのWM,WAylandコンポジタを内包)
    - openbox,i3,awesome(単独で使用可能なVM)

### デスクトップ環境が含むマネージャ色々
- ウィンドウマネージャ
  - ウィンドウの配置など
- セッションマネージャ
  - ログアウト、アプリ起動
- パワーマネージャ
  - スリープ、電源オフ
- クリップボードマネージャ
  - XFCE: xfce4-clipman等
- デスクトップマネージャ
  - 背景など
- 通知マネージャ
  - トースト通知
- パネル、タスクバーのマネージャ
  - パネル、メニューの管理

### X window systemはデスクトップ環境に対して何をする？
- a. デスクトップ環境に対してイベントを送信している
  - ディスプレイに反映する
- b. インプットデバイスからイベントを受け取り、アプリに知らせる
  - マウスが動いた/キーボードが押された/クリック など
  - これらはカーネルが管理するドライバの処理を受け取っている
  - アプリに知らせる際にはデスクトップ環境を通過しない
  - ※ ウィンドウマネージャは枠・移動・重なりに関わるイベントを管理
    - 例：ユーザーがウィンドウの「タイトルバー」をドラッグ → これは「アプリ本体」ではなく「ウィンドウマネージャ」が処理する。
  - そのため X server は、入力イベントを「アクティブウィンドウ」や「ウィンドウマネージャ」など 適切なクライアントに直接渡す。
  - デスクトップ環境（GNOME, KDEなど）は、さらに「パネル」「通知」「設定UI」などを追加するだけで、X server のイベント配送経路には介在しません。
### GUIの起動
- 1. systemdが初期のプロセスを実行
- 2. systemdがディスプレイマネージャを呼び出し
  - graphical.targetの中に紐付け
- 3. ディスプレイマネージャがXサーバ(Xorg)を起動する
- 4. ディスプレイマネージャが、Xサーバにログイン画面を描写させる処理を実行
- 5. ログイン内容からデスクトップセッションを開始



### セッション vs ユーザ
- セッションはttyなどのインタフェースの単位
- 1ユーザが複数セッション持てる
- tty...テレタイプライタ
  - `dev/tty1`などのインタフェースを持つ

### 手動でX serverを起動する
- 普通はディスプレイ環境はディスプレイマネージャによって呼び出される
- ログイン後のCLI環境からXserverを呼び出し、GUI操作することもできる
- `startx`コマンドよって起動
- 内部で`xinit`コマンドを実行している
  - 別に直接xinitを呼ぶコマンドを打っても良い
#### Xの起動 コマンド vs ディスクトップマネージャ
- startxで起動
  - 設定ファイル
    - `~/.xinitrc`もしくは`/etc/X11/xinit/xinitrc`
    - 既にセッション情報は持っているため、x window systemだけを開始する役割
- ディスクトップマネージャから挙動
  - 設定ファイル
    - `~/.xsession`もしくは`~/.Xclients`もしくは`/etc/X11/xinit/Xclients`
    - ウィンドウを起動する際にそのセッションが持つ情報を併せてウィンドウマネージャに渡す
- 最終的には、どちらの起動方法にしてもウィンドウマネージャを起動させる
### Xサーバ・Xクライアントを分離して考える
- X サーバ
  - ディスプレイ（モニタ）や入力デバイス（キーボード・マウス）を直接管理する
  - 実際の描画や入力の低レイヤー処理を担当
- X クライアント
  - X サーバに対して「ウィンドウ作って描画して」「入力イベントを送って」と要求するアプリケーション
  - 例:
    - ウィンドウマネージャ（Mutter, KWin, xfwm4）
    - デスクトップ環境のセッション (GNOME, KDE)
    - 通常のアプリケーション（端末, ブラウザ, エディタなど）


### クライアントを指すrxvtって何の略？
- X window system用の端末エミュレータのこと
- our extended virtual terminalの略らしい

### ネットワーク経由でXサーバを利用する
- Xサーバ側にディスプレイがある
- Xクライアント側は処理演算などの情報をサーバに送ってくる

### 分離したXサーバ・Xクライアントへのアクセス`xhost`コマンド
- クライアント(アプリ)からサーバ(ディスプレイ)に描写要求する
- xクライアント(コンピュータリソース)がxサーバ(モニタ/入力デバイス)へアクセスを許可する
- xクライアント上で、、、
  - `xhost +{hostname}`...指定したホストをXサーバ接続許可リストに追加。IPでも良い
  - `xhost -{hostname}`...指定したホストをXサーバ接続許可リストから削除。IPでも良い
  - `xhost +`...全てのホストがXサーバに接続を許可
  - `xhost -`...Xサーバ接続許可リストによるアクセス制御を有効化
  - ここでのホストはマシンのホスト名を指す。
### X11転送の脆弱性
- 認証できる単位がホストネーム/IP依存
  - 偽造が容易い
- Xクライアント-Xサーバ間で暗号化されていない
  - 傍受ができ、ピクセル単位で盗み取れる
### 複数クライアントからのサーバ要求ってどうなるの？
- 描写に関しては実行される
- マウスやキーボードに関しては、フォーカスを持つウィンドウが持つ
  - アクティブなウィンドウと呼ばれるヤツ

### `rxvt`による接続
- 描写を実行するハードウェアをエミュレートする
- X11転送でよく使われる
- コマンドを実行したホストをクライアントに表示する
- 具体的には、、、
  - Xサーバから一部の設定を読み取る
    - フォント
    - カラーマップ
    - DPI
  - 描画、イベント入出などをやりとりする
### 環境変数 DISPLAY
- rxvtなどが描写する先を指定する
  - `DISPLAY=[hostname]:{display_num}[.screen_num]`
  - `:0`...ローカルマシンのディスプレイ0,スクリーン0
  - `:1`...ローカルマシンのディスプレイ1,スクリーン0
  - `localhost:10.0`
    - `ssh -X`で接続した際によく10番ディスプレイを使う
  - `192.168.1.100:0.0`...ネットワークで接続


# グラフィカルデスクトップ
### マネージャ
- ディスクトップマネージャなどの連携によってX window systemは動作可能
- 規格
  - X.org foundation
  - ICCCM(Inter-Client Communication Conventions Manual)
  - EWMH(Extended Window Manager Hints)
### ディスクトップマネージャ
- ログイン画面の表示を担当
  - XDM(X Display Manager)
    - X.Org標準
  - GDM(Gnome Display Manager)
    - Gnome標準
  - SDDM(Simple Desktop Display Manger)
    - KDE Plasma標準
  - LightDM(LightDM)
    - Ubuntuで採用
- ここからデスクトップ環境を起動する
  - 複数ある場合はそれを選択できる

### ウィンドウマネージャ
- 以下を管理
  - ウィンドウの外観
  - メニュー
  - アイコン
- ウィンドウマネージャの例
  - twm...最小限で軽量
  - FVVM...処理効率がよいシンプルなウィンドウマネージャ
  - Enlightnment...高度なカスタマイズが可能
  - Metacity...GNOME2標準
  - Mutter...GNOME3標準
  - Fluxbox...処理効率が良く、カスタマイズ性が高い
  - Compiz...立体的な画面効果が特徴
  - KWin...KDEの標準

### デスクトップ環境(統合デスクトップ環境)
- ウィンドウマネージャ、パワーマネージャ、ファイルマネージャ等を統合
- 統合デスクトップ環境の例
  - GNOME
    - 多くのLinuxディストリビューションで採用
    - GTK+というGUIツールキットがベース
    - ディスプレイマネージャとしてGDM
    - ウィンドウマネージャにMutterを採用
  - KDE Plasma(KDE:KDE Software Compilation環境)
    - openSUSE、Slackware、Kubuntuなどで採用
    - QtがGUIツールキットのベース
  - Xfce(ラズパイはたぶんこいつ)
  - LXDE
  - MATE

### アプリケーションによる接続
- リモートデスクトップ
- 仮想デスクトップ(VDI)
  - サーバ側で複数のデスクトップ環境を立ち上げる
    - ここでのサーバはVDIサーバのこと
  - 接続元クライアントはクリックイベント等とピクセル情報を送る
  - ※ X11は描写の情報（フォント、ベクタ型描写処理）を使用する
- VNC
  - デスクトップを提供する側でVNCサーバを立ち上げる
  - {hostname}:{display_num}の指定で接続
- RDP
  - windowsで主にサポート
- SPICE(Simple Protocol for Independent Computing Environment)
  - KVMやQEMUはこのプロトコルを使用してデスクトップを提供することが多い
  - 画面以外にもストレージへのアクセスや音声通信までをサポート
  - virt-manager,remote-viewer,libvert, SPICE GATEWAY
- XDMCP(X Display Manager Control Protocol)
  - ディスプレイマネージャをネットワーク越しに利用する
  - 暗号化はサポートしない


### アクセシビリティ
- 障害者を支援するソフトウェア
  - AT(Assistive Technology)
- キーボードアクセシビリティ
  - ハイコントラスト
  - 大きな文字
  - カーソルのお大きさ
  - ズーム
  - スクリーンリーダー
  - Capslockのビープ
  - 視覚警告
    - ビープ音に連動してスクリーンを点滅
  - スクリーンキーボード
  - リピートキー
    - 長押しで連打と認識する
  - マウスキー
    - テンキーでマウス操作
  - クリック支援
    - 主ボタンの押しっぱなしで副ボタンの押下と判定
- スティッキーキー（固定キー）
  - 2回服飾キー(Shift,alt)などを押下すると起動する
  - 他の入力が入ってくるまで、ShiftやAlt、Ctrlなどを押しっぱなし判定にする
    - この状態を「ラッチ」と呼ぶ
  - 素早く2回押すと、ずっと押された状態になる設定もある。
  - このときには他のキーを押しても解除されない
  - 押しっぱなしのキーを押すと解除される
    - この状態を「ロック」と呼ぶ
- スローキー
  - キー押下に対する認識時間を調整する
- バウンスキー
  - 素早く連続押下しても一回と認識する
- トグルキー
  - Numlock,capslock,scrollキーのLED点灯が認識できない時用に、オンの時にビープ、オフの時に2回ビープを鳴らす
- マウスキー
  - テンキーで操作