# ファイルとプロセスの管理

### 圧縮系
- gzip ... gz圧縮
  - `-d` `unzip`
    - 圧縮ファイルを展開
  - `-c`
    - 標準出力に出す
  - `-r`
    - ディレクトリのファイルをそれぞれ圧縮する
- bzip ... bz圧縮
- bzip2 ... bz2圧縮
- xz
### 圧縮系の内容閲覧
- zcat
- bzcat
- xzcat

### tar,ファイルアーカイブ
- 作成、解凍、内容確認 `-c`,`-x`,`-t`
- ファイル参照 `-f`
- gz,bzip,xz `-z`,`-j`,`-J`
- 詳細表示`-v`
- アーカイブ内にファイルを追加する`-r`
- アーカイブ内の差分ファイルを追加する `-u`
  - 新しいファイルは追加する
- 日付を指定して新しいもののみを選択する`-N`
- 複数デバイスへの分割を行う`-M`
- アーカイブ内からファイルを削除`--delete`
### cpio,ファイルアーカイブ
- ちょっと古い形式
- パイプを前提としている
- フラグ
  - `-i {option} {pattern}`...アーカイブからファイルを取り出して標準出力へ出す
  - `-o {option}`...アーカイブを標準出力に出す
  - `-p {option} {dir}`...ファイルを別のディレクトリにコピー
- オプション
  - `-A`...既存のアーカイブに追加
  - `-d`...必要ならディレクトリを作成
  - `-r`...ファイル名を対話的に変更
  - `-t`...コピーをせずに入力された内容を表示
  - `-v`...ファイル名の一覧を表示
### dd低レイヤコピーコマンド
- if=入力ファイル
- of=出力ファイル
- bs=一度にコピーするバイト数
- count=ブロックのコピー回数

# パーミッション
- 所有者、所有グループ、その他のユーザに対する3桁の権限
- 読み取り権限(r)、書き込み権限(w)、実行権限(x)の3つ
- `ls -l`から確認可能

### ls -l の内容
- `- rwx rwx rwx`の形式
  - 1番手前：ファイルの種類
    - `-`通常ファイル
    - `-l`リンク
    - `-d`ディレクトリ
  - 2番目以降；所有者、グループ、その他のアクセスユーザ
### chmod
- アクセス権の変更
  - chmodを実行できるのは所有ユーザ
  - シンボリックリンクに対してアクセス権を変更すると、元ファイルの権限を変更しようとする。
- オプション
  - `-R`...ディレクトリの全ての権限を変更
- 対象
  - u...所有者
  - g...グループ
  - o...そのほかユーザ
  - a...すべての権限について変更
- 操作
  - +...権限を追加する
  - -...権限を削除する
  - =...権限を指定する
- 権限
  - r...読み取り
  - w...書き込み
  - x...実行
  - s...SUIDもしくはSGID
  - t...スティッキービット
- サンプルコマンド
	- `chmod go+w sample.txt`
		- グループとその他のユーザに対して書き込み権限を許可する
	- `chmod o-rw sample.txt`
		- その他のグループの読み取りと書き込みの権限を削除する
	- `chmod 644 sample.txt`
		- 所有者に読み取りと書き込み、グループと他のユーザに読み取りの権限を与える
### SUIDとは
- set user ID(4)のこと
- 実行される際には所有者として実行する
- 実行権があることが前提
  - 1. 一般ユーザによって実行された場合
  - 2. そのコマンドによって呼び出される参照などは所有者として実行
- つけ方
  - `chmod u+s {filename}`
  - `chmod 4XXX {filename}` 
  - ユーザに対してつける
- `- rws --x --x`のような記載になる
- プロセスIDがユーザのものに書き換わる
### SGIDとは
- set group ID(2)のこと
- 実行される際にはグループとして実行される
- つけ方
  - `chmod g+s {filename}`
  - `chmod 2XXX {filename}`
- ディレクトリに付与する場合
  - 配下に作成されるファイルに同じグループ権限を渡す
  - 所有グループもそのディレクトリの所有グループになる
### スティッキービット
- `- rwx rwx rwt`
  - 慣例的にそのほかユーザの実行権限に記載する
  - stickeyのsじゃなくて、tなので注意！！！
- そのディレクトリ配下のファイルは自身が小勇者の物以外は削除できない
- 追記や編集は可能
- 付け方
  - `chmod o+t {filename}`
  - `chmod 1XXX {filename}`
### umask
- ユーザに設定するデフォルトの権限
- umaskコマンドで自分に付いた権限を確認できる
  - `002`,`027`などの値
- 基本権限からの引き算で決定する
- ファイルの作成
  - `666 - umask(002) = 664`
    - その他のユーザに編集権限を与えない
    - umasknに7が設定されている場合は、0とする。
- ディレクトリの作成
  - `777 - umask(002) = 775`
    - そのほかユーザに編集権限を与えない
### chown 所有者の変更
- 基本的にrootdしか使用できない
  - コマンドの実行自体はどのユーザでも許可されているが、、、
- `chown {user} {file/dir name}`
- `-R`...指定したディレクトリとその中身を全て変更する
- ☆グループ権限の変更
  - chgrpでなくても変更できる
  - `chown {user} file`
  - `chown :{group} {file}`
  - `chown .{group} {file}`
  - `chown {user}:{group} {file}`
  - `chown {user}.{group} {file}`
### chgrp グループの変更
- change groupの略
- `chgrp {group} {file/dir name}`
- `-R`...指定したディレクトリとその中身も変更する


# リンク
### ハードリンク
- ファイルに対してリンクを作成する
  - ディレクトリに対しては作成できない
  - 異なるファイルシステムに作成することはできない
- 以下の情報が同じリンク
- inode-id
  - ファイル種別
  - ファイルサイズ
  - アクセス権
  - 所有者
  - ディスクの物理的な保存場所
    - ブロック番号
- ファイルの名前は変更可能
- 作り方
  - `ln {元ファイル} {作成リンク名}`
- `ls -l`を使用してもリンクとしては扱わない
### シンボリックリンク
- ファイル/ディレクトリへのショートカット
- `ls -l`コマンドで`l`と表示される。
  - 権限はフル開放されるが、実際には、リンク先の権限に従う
- 元ファイルを削除すると、リンクエラーを起こす
- 作り方
  - `ln -s {元ファイル/ディレクトリ} {linkname}`
- ファイルシステムを超えたリンクを作成可能

### リンクの特定
- `ls -i`,`ls -l`,`ls -F`
  - -iでinode番号を表示。ハードリンクの場合これが同じ
  - -lでリンクを表示。シンボリックリンクの場合xxx->YYYという表示が出る
  - -Fでファイルの特定。シンボリックリンクの場合は末尾に@がつく
### リンクのコピー
- 通常のコピーの場合
  - リンクは、元のファイルをコピーしようとする
- `cp -d`を使用する場合(`--no-dereferenceの略,間接参照という意味らしい`)
  - リンクをリンクとして生成する

# プロセス管理
### プロセスの監視
- タスク
  - プロセス内の一連の処理
- プロセス
  - リソースの割り当て単位
  - プロセスは以下を持つ
    - プロセスID
      - initが1のやつ
    - ユーザID
    - グループID
  - rootにはカーネルから実行されているものもある
### プロセス監視コマンド ps
- オプション
  - `a`...他のユーザのプロセスも表示
  - `f`...親子関係をツリー上にする
  - `-f`...完全なフォーマットでプロセスを表示(カラム名とかも拾う)
  - `u`...ユーザ名も表示する
  - `x`...制御端末のないデーモンも表示
  - `-e`...すべてのプロセスを表示する(aとxの双方)
  - `-l`,`l`...詳細な情報を表示する
  - `-p {PID}`...特定のPIDのプロセス情報のみを表示
  - `-C {prpcessname}`...指定した名前のプロセスを表示
  - `-w`...長い行は折り返して表示
  - ※ ハイフンをつけないコマンドもある。
- 見える物(auxコマンドを使用)
  - USER
  - PID
  - CPU
  - MEMORY
  - VSZ
    - 仮想メモリサイズ
  - RSS
    - 駐屯メモリサイズ
  - TTY
    - 実行端末
  - STAT
    - プロセスの状態
      - R...ランニング
      - S...スリープ
      - Z...ゾンビ
  - START
  - TIME
    - 累積CPU時間
  - COMMAND
### 実行中のプロセスを表示top
- 2段組で実行の状態を表示する
- 1段目
  - 1行目：システムの稼働状態
  - 2行目：実行プロセス数
  - 3行目：CPUの状態
  - 4,5行目：メモリ、スワップメモリの状態
- 2段目
  - 各プロセスの状態
  - CPU利用順で表示する
### pstree プロセスを樹形図で表示
- pstree
  - `-p`...プロセスIDを表示
  - `-u`...ユーザIDを表示
  - `-g`...グループIDを表示
### kill プロセスを終了させる
- `kill -{option} {対象PID}`
- `kill -s [シグナル名/id] {対象PID}`
- `kill -SIG [シグナル名] {対象PID}`
- `kill -l`
  - 命令シグナルと、そのID一覧を確認する
  - 30個ぐらいある
- 主なシグナル
  - 基本的に何か特別な処理を埋め込んでない場合、如何なるシグナル受け取っても終了する
  - `HUP(SIGHUP) 1` 
    - ハングアップ
    - 端末の切断による終了
    - 設定の再読み込みが走ったりする
  - `INT(SIGINT) 2 割り込み（ctrl +C と同じ）`
    - シグナルインタラプトの略(signal interrupt)
  - `KILL(SIGKILL) 9 強制終了`
  - `TERM(SIGTERM) 15 終了`(何も指定しないとこれが送られる)
    - signal terminate
  - `CONT(SIGCONT) 18 停止しているプロセスを再開`
    - signal continue
  - `STOP(SIGSTOP) 19 一時停止`
  - `TSTOP(SIGTSTOP) 20 端末から入力された一時停止(ctrl+z)`
    - signal terminal stop
### pgrep プロセスIDを検索する
- `pgrep {UID}`
  - IDが所有するプロセスを表示する
- `pgrep -u [username|uID]`
  - ユーザ名が現在所有するプロセス(Effective User)を表示する
- `pgrep -U {username|uID}`
  - ユーザが起動したプロセス(Real UID)を表示する
- `pgrep -g {groupname}`
  - グループが所有するプロセスを表示する
- `pgrep {servicename}`
  - サービスの名前のPIDを表示する
### killall プロセス名からプロセスを削除する
- 完全一致でプロセスを削除する
- `killall -{option} {対象プロセス名}`
- `killall -s [シグナル名/id] {対象プロセス名}`
- `killall -SIG シグナル名 プロセス名`
- ※ 正規表現は利用できない
### pkill でもプロセス名から削除できるで
- `pkill {part_key}`
  - 部分一致でそのプロセスをすべて削除する
- `pkill -u {ユーザ名}`
  - そのユーザが持つプロセスを全て殺す
  - ユーザ名は完全一致
- `pkill -u {ユーザ名} {プロセス名}`
  - そのユーザが実行しているプロセス名を殺す
  - プロセス
- `pkill -g {グループ名}`
  - そのグループが持つプロセスを殺す
  - ユーザ名は完全一致
- 正規表現を利用可能
# ジョブ管理
### バックグラウンドで実行する
- 末尾に`&`をつけるとバックグラウンドで実行する
  - `ls &`
### 実行中のプロセスを参照する
- `jobs`
### ログアウトした後もプログラムを実行する
- `nohup {command} &`
- nohup...SIGHUPコマンド（親プロセスの終了）を無視する
- &... バックアップで実行する
### バックグラウンド/フォアグラウンドに移動する 
- `jobs`で確認したのちに...
  - `fg {jobnum}`...フォアグラウンドに移動
  - `bg {jobnum}`...バックグラウンドに移動
- 停止中`stopped`のプロセスも際実行できる
### free システムの状態を把握する
- option
  - `-m` MB単位で表示する（何も指定しなければKB表示）
  - `-s {sec}`指定した間隔で表示し続ける 
### uptime
- CPUが待機させていたプロセス数
- 見えるもの
  - 現在時刻、起動してからの日数と時間
  - ログインユーザ数
  - 1,5,15分ごとの平均待機プロセス数
    - 時間で割っているので少数が普通にある
### uname、アーキテクチャを確認する
- `-a`
  - ホスト名やカーネルのバージョンなども表示
### watch、コマンドを一定時間ごとに実行する
- `-n`...指定した秒ごとに更新
- `-d`...変化した部分をわかりやすく表示する
- `-t`...ヘッダの情報を表示しない
- `watch -d -n {time} {command}`

# 端末の管理
- 端末(tty)を複数管理する
  - tmuxやscreenがそれに該当する
### tmux
- 新しくtmuxプロセスを開始してその下にbashを起動する
- ttyが変わっているわけではないので、historyなどは共通に存在する
- tmuxに関するコマンド
  - `tmux` ...セッションを新規起動
  - `tmux new -s {名前}` ...セッションに名前をつけて起動
  - `tmux a`...中断したセッションに戻る attach
    - `tmux attach`
  - `tmux a -t {名前}` ...名前を指定してそのセッションに戻る
  - `tmux list-sessions`... セッションの一覧を表示
    - `tmux ls`
  - `tmux kill-session -t {name}`...指定したセッションを終了する
  - `tmux kill-server`...すべてのセッションをまとめて削除する
- ウィンドウ操作 `ctrl + b`を押してから
  - `d`...一時的に中断
  - `s`...セッションの一覧を表示
  - `c`...新規ウィンドウを表示
  - `{number}`...数字で指定したウィンドウに移動
  - `n`...次のウィンドウに移動
  - `p`...前のウィンドウに移動
  - `l`...以前のウィンドウに移動
  - `w`...ウィンドウの一覧を表示
  - `,`...ウィンドウ名を表示
  - `'`...ウィンドウ番号に指定して移動
  - `.`...ウィンドウ番号を変更
  - `&`...ウィンドウ名を終了
  - `exit`...ウィンドウを終了


### プロセスの実行優先度
- `ps -l`で確認可能
  - `PRI`カラムに表示される。
    - 低ければ低いほど優先される
    - 0~39:リアルタイムプロセス
    - 39~139:通常のプロセス
      - だいたい80が設定される
- `PRI`の計算
  - 基本優先度(OS定義) + nice値(ユーザ定義) 
- `nice値`
  - ユーザが指定可能な優先度
  - -20~19が利用可能
  - 負の値を設定できるのはルートユーザのみ
### nice,nice値を設定する
- `nice -{value} {command}`
  - ハイフン必須
- `nice -n {value} {command}`
  - 新たにnice値を設定してコマンドを実行する
- `nice {command}`
  - nice値10で実行する（デフォルト値の0でないことに注意）
### renice実行中のプロセスのnice値を制御する
- `renice {value} {PID}`
  - ハイフンはいらない
- `renice -n {value} {PID}`
- `renice -n {value} -p {PID}`
- `renice -n {value} -g {groupID}`
  - グループネームは使用できない。
- `renice -n {value} -u {userID}`
- `renice -n {value} -u {username} `



### よくあるユーザIDの割り当て
- 0...スーパユーザ
- 1-99...静的システムユーザ、bin,daemon,sync
- 100-199...システムサービス用sshd,www-data,system
- 1000以降...一般ユーザに割り当てられる

### kill(9) vs terminate(15)
- クリーンアップ処理をするか？
  - killの場合、ファイル、メモリ、一時ファイルを削除しない

### bg,fgとCONTシグナルって違うの？
- bg,fg
  - 端末の権限までサポート
  - fgの場合は、端末に端末を渡す
  - シェルが管理するプロセスのみ管理
- CONTシグナル
  - 停止状態から再開させる
  - シェル外のプロセスからでも管理できる
