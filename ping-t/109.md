# 管理タスク

## ユーザとグループの管理
### ユーザアカウント情報 `/etc/passwd`
- 例：`root:x:0:0:root:/root:/bin/bash`
- パラメータ
  - ユーザ名
  - パスワード...現在の仕様だと「x」が入っている
  - UID（ユーザID）...rootは0。一般ユーザは1000以降が割り当てられる傾向にある
  - GID
    - グループID
    - ここに書かれたものがプライマリグループになる。
    - 一つだけ指定できる
    - `/etc/group`に詳細が書いてある
  - GECOS
    - コメント
  - ホームディレクトリ
  - デフォルトシェル

### シャドウパスワード
- `/etc/shadow`ここにパスワードを配置する
- ルートユーザのみ
- root:$6$A1bCdEfG$abcdefghijklmnopqrstuvwx1234567890abcdEFGHijkLMNOPqrstu.:19785:0:99999:7:::
- ログイン名: root, uuser など
- 暗号化パスワード:$6$... → SHA-512 でハッシュ化されたパスワード
  - 「*」または「!」が入っている場合はログイン不可
- 最終パスワード変更日: 1970-01-01 からの日数（例: 19785 は適当な数値）
- 最小日数: パスワード再変更までの最短日数
- 最大日数: パスワードが有効な最大日数
- 警告日数: パスワード期限前の警告日数
- 無効日数: パスワード期限切れ後に無効化されるまでの日数
- アカウント有効期限: 1970-01-01 からの日数（空欄なら無期限）
- 予約: 未来用

### グループアカウント
- `/etc/group`にグループの設定が入っている
- 例：
  - `man:x:12:`
  - `proxy:x:13:yamada,iwata`
  - `kmem:x:15:`
- パラメータ
  - グループ名
  - パスワードフィールド
    - ここはシャドウ化されている。「x」
  - GID
  - ユーザリスト
    - コンマ区切りでユーザを入れる

### プライマリグループ/サブグループ
- プライマリグループ(基本グループ)
  - /etc/passwdに書かれる
  - ファイルを作成する際に管理グループ名となるのはコイツ
- サブグループ（参加グループ、補助グループ）

### ユーザ、グループ管理
- `useradd`
  - ユーザの作成
- オプション
  - `useradd -c {comment} user`
    - コメントフィールドに入力
  - `useradd -d {PATH} user`
    - ホームディレクトリの位置を指定する
  - `useradd -g {groupname/gid} user`
    - プライマリグループを指定
  - `useradd -G {groupname/gid} user`
    - サブグループを指定
  - `useradd -s {path}`
    - デフォルトシェルを指定する
  - `useradd -D {-option config}`
    - デフォルトの設定値を表示、もしくは指定
  - `useradd -m user`
    - ホームディレクトリを自動的に作成
    - Debian GNUなどで使用する

### ホームディレクトリへの配布ファイル
- `/etc/skel`
  - ユーザ作成と合わせてホームディレクトリを作成する際に自動的に複製されるファイル群
  - 所有者は新規のユーザに充てられる
  - `.bashrc`や`.profile`などが入ることが多い
  - ディレクトリもそのままコピーされる
    - シンボリックリンクはそのまま

### usermod
- 既存ユーザのアカウント情報を変更する
- オプション
  - `usermod -c {commnet} user`
  - `usermod -d {PATH} user`
    - ホームディレクトリの変更
    - 移行作業はされない(`-m`をつけると既存のものをコピーしてくれる)
  - `usermod -g {groupname/gid} user`
  - `usermod -G {groupname/gid} user`
  - `usermod -s {pass} user`
  - `usermod -L user`
    - パスワードをロックしてユーザを無効化する
  - `usermod -U user`
    - パスワードのロックを解除する

### userdel
- ユーザアカウントを削除する
- `userdel user`
- `userdel -r user`
  - ホームディレクトリも一緒に削除する
- ※ 削除した後に存在しないファイルがファイルシステムに残る可能性がある
### パスワード変更
- `passwd`
- `passwd user`
- `passwd -l user`
  - パスワードをロックして無効化
- `passed -u user`
  - パスワードのロックを解除する
  
### gropupadd
- グループを作成する
- `groudadd {groupname}`
- `groupadd {groupname} -U [user]`
  - ユーザも初めから追加する
### groupmod
- `groupmod -g {GID} group`
  - GIDを変更する
- `groupmod -n {groupname} group`
  - 名前を変更する
### groupdel
- グループを削除する
- `groupdel {group}`
- 1ユーザでもプライマリグループにしている場合は削除できない

### id
- `id {user}`
- そのユーザが所属しているグループを表示
- 以下を表示する
  - `uid`
  - `gid`
  - `groups`...その他所属してるグループ
### getent
- get entityの略称
- LDAPから、ローカルまでのユーザ情報を取得できる
- getent passwd
  - ユーザ情報
  - /etc/passwd,LDAP,NISなどを参照
- getent group
  - グループ情報
  - /etc/group,LDAP,NISを参照
- getent shadow
  - パスワード情報
  - /etc/shadow, LDAP,NISを参照
- getent hosts
  - ホスト名解決
  - /etc/hosts, DNS
- getent services
  - サービス名とポート番号
  - /etc/services
- getent protocols
  - ネットワークプロトコル名
  - /etc/protocols
- getent networks
  - ネットワーク名
  - /etc/networks
- getent aliases
  - メールエイリアス,/etc/aliasesなどを参照
- getent ethers
  - macアドレスとホスト名の対応
  - /etc/ethers
- getent rpc
  - rpcサービス
  - /etc/rpc


# job schedule
### cron
- crond デーモン、crontabコマンドによって定期実行を実現
### `crontab`コマンド
- `crontab -e`
  - エディタを使用してcrontabファイルを編集
- `crontab -l`
  - crontabファイルを出力
- `crontab -r`
  - crontabファイルを削除
- `crontab -i`
  - crontabファイルを削除する際に確認を入れる
- `crontab -u {username}`
  - ユーザを指定してcrontabファイルを編集する

### ユーザ用crontabファイル
- `/var/spool/cron/{username}`に存在
  - {usr}領域では無いので注意。
  - /var...可変を前提としたディレクトリに配置
- 直接編集すると設定が壊れるので基本はオプションから編集
- フォーマット
  - `分 時 日 月 曜 コマンド`
  - シャープはコメントとして扱う。
### システム用crontabファイル
- `/etc/cron.*`配下を全て呼び出す
- 実行ユーザを指定して設定できる
- フォーマット
  - `分 時 日　月 曜 ユーザ コマンド`
- よく配置されるシステムcronディレクトリ
  - `/etc/crontab`...システムのcrontabファイル。システムワイドcronとか呼ばれる
- `/etc/cron.d/`...パッケージ等が動作するために記載したりする
- `/etc/cron.daily/`,`/etc/cron.hourly/`,`/etc/cron.weekly`,`/etc/cron.monthly`


### cronコマンドのユーザ制限
- `/etc/cron.allow`
  - このファイルが存在している場合、名前のあるユーザのみが実行可能
  - denyは参照しない
- `/etc/cron.deny`
  - このファイルが存在している場合、名前のあるユーザは実行できない
  - 両方のファイルがなければ、誰でも使用できる
    - ディストリビューション依存？
- ※ ユーザのみ指定。グループは指定できない。

### atコマンド
- 一回限りの実行スケジュールをセットする
- `at {time_format}`から、実行したいコマンドを打ち込む
  - ctrl+d で入力を終了する
- atデーモン(atd)が見ている
- オプション
  - `at -d{jobid}`...ジョブの削除
  - `at -r{jobid}`...ジョブの削除
  - `atrm {jobid}`...ジョブの削除
  - `at -l`...予約中のジョブを表示
  - `atq`...予約中のジョブを表示
  - `at -f`...コマンドを記載したファイルを指定する
- time_format
  - `at 22:00 tommorow`
  - `at 10pm today`
  - `at now + 3days`
  - `at 10pm + 2weeks`などなど
  - `midnight`,`noon`,`teatime`(16:00)が予約されている
- ※ 標準出力がメールに設定されており、MTAが設定されている必要がある
  - 代わりにファイル出力など、リダイレクトさせることが多い
  - 古いコマンドだからこうなっている

### atコマンドアクセス制限
- `/etc/at.allow`
  - このファイルが存在すれば、そこに記載されたユーザだけが利用可能
  - at.denyは参照しない
- `/etc/at.deny`
  - aこのファイルが存在すれば、そこに記載されていないユーザは利用不可能
- 双方が存在しなければ、rootユーザだけがatを利用可能

### Systemd Unitによるスケジューリング
- `.timer`ユニットで書かれる
  - 定期的に`.service`を起動するユニット
- 書式例
```
[Unit]
Description={comment}

[Timer]
OnBootSec=10min
OnUnitActiveSec=1w

[install]
Wantedby=timers.target
```
- [Timer]セクションで設定できる項目
  - `OnCalender=`...cron風な日付設定
    - `OnCalender={曜日} 年-月-日 時:分:秒 `
  - `OnActiveSec=`...そのユニットが有効化されてからの経過秒
    - 10min とかの単語も使える
  - `OnBootSec=`
    - システムの起動からの秒数
  - `OnStartupSec=`
    - 前回実行されてからの経過時間
  - `OnUnitActiveSec=`
    - 前回停止してからの経過時間

#### systemd-runコマンド
- .timerユニットを生成できる
- `systemd-run --unit=test --on-active=3s --on-unit-active=60s uptime`
- このコマンドは`run/systemd/transient/`にファイルを作成するため、再起動すると消失する
- 上記のコマンドでは以下の2ファイルが作成される
  - test.service...コマンドを実行するためのunitファイル
  - test.timer...定期実行するためのtimer unitファイル


#### スケジュールの一覧を表示する
- `systectl list-timers`
#### コマンドの実行結果を取得する
- `journalctl -u testjob`
  - ユニットの`-u`オプション
#### スケジュールを削除する
- `jornalctl stop testjob.timer`

# ローカライゼーション
- 言語、通貨単位、日付の書式が対照
- internationalizationで、i18nと呼ばれることもある。

### ロケール
- 主要な環境。上から順に優先される
  - LC_ALL...全LC_*を上書きして実行
  - LC_*...各項目に対して、その設定を適応
  - LANG..デフォルト値
### LC_*のパラメータ
- LC_CTYPE
  - 文字の種類やその比較・分類
- LC_COLLATE
  - 文字の照会や整列の規定
- LC_MESSAGES
  - メッセージ表示に使用する言語
- LC_MONETARY
  - 通過に関する規定
- LC_NUMERIC
  - 数値の書式に関する規定
- LC_TIME
  - 日付や時刻の書式に関する規定
### 主なロケール
- C, POSIX...英語
- ja_JP,.euc.jp
- ja_JP.shiftJIS
- en_US.utf8

### 設定を確認するコマンド locale
- ロケール、local(usr/配下のディレクトリ)では無いので注意
- オプション
  - `local -a`...設定可能なロケールを一覧化
  - `local -m`...利用可能な文字コードを一覧化
    - そのディストリビューションが扱える文字コード


### 文字コード
- 利用可能な文字コード
  - ASCII
    - 7ビットで表現される128文字
  - ISO-8859
    - ASCIIの拡張の256文字
  - UTF-8
    - Unicodeで1バイトから6バイトで表現
  - 日本語EUC(EUC-JP)
    - UNIX標準の日本語コード
  - シフトJIS
    - WIndowsで利用される文字コード
  - ISO-2022-JP
    - 電子メールなどはコイツ(JISコードとも呼ばれる)

### 文字コードの変換 iconv
- `iconv -f {inputcharcode}　-t {outputcharcode} {file}`
- 代入もできる
  - `ls | iconv -f UTF-8 -t UTF32`
  - この場合は標準出力に出す
- オプション
  - -f...変換前の文字コード
  - -t...変換後の文字コード
  - -l...コマンド扱える文字コード
    - (実行にはディストリビューションが扱える必要があるのでここに載っている全てが扱えるわけでは無い)

### タイムゾーン
- タイムゾーンの情報
  - `usr/share/zoneinfo/`配下によく置かれる
- システムで利用しているタイムゾーン
  - `/etc/localtime`というファイルで保存
- 上記2ファイルの内容は同じなので、`cp`してやると更新できる
  - `cp /usr/share/zoneinfo/Asia/Tokyo /etc/lcoaltime`
  - シンボリックリンクでも良い
### コマンドによるタイムゾーンの設定
- 環境変数`TZ`
  - `export TZ="Asia/Tokyo"`など
- `tzselect`コマンド
  - cooed...大陸や地域を選択
  - TZ...その中での言語を選択
  - このコマンドは案内のみを実施する。変更はしない
- `tzconfig`コマンド
### debian系の時刻設定
- `/etc/timezone`というファイルを保存していることがある
  - 人間が確かめる用のタイムゾーンファイル
- `tzconfig`コマンドによって再設定できる
  - install: `dpkg-reconfigure tzdata`
  - 