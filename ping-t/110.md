# 必須なシステムサービス
- ログ・メールの整合性を取るための設定
### システムクロック
- ハードウェアクロック
  - コンピュータ内の電池で動く
  - 電源をOFFにしても動く
- システムクロック
  - カーネルに存在する時計
  - `date`コマンドはこちらを参照している
### dateコマンドによるシステムクロックの変更
- `sudo date [MMDDhhmm[CC|YY][.ss]]`
  - デフォルトはかなり特殊な記法
  - `sudo date 121020002018.12`
  - 2018年12月10日 20:00を指す
### dateコマンドによるシステムクロックの表示
- dateに`+`を含めると以下の書式が使用可能
- 書式
  - Y...年
  - m...月
  - d...日
  - H...時
  - M...分
  - a...曜日
  - b...月名
- 例
  - `date "+%Y/%m/%d (%a)"`
  - 2022/10/01 (Mon)

### システムクロックをハードウェアクロックにセットする `hwclock`
- `hwclock -r`
  - ハードウェアクロックを表示
- `hwclocl -w`,`hwclock --systohc`
  - システムクロックの時刻をハードウェアクロックに設定
- `hwclock -s`,`hwclock -hctosys`
  - システムクロックの時刻をハードウェアクロックに設定

### systemdによるクロック設定 `timedatectl`
- システムクロックとハードウェアクロックを同時に調整する
- オプション
  - `timedatectl`
    - 現在の日時、タイムゾーン、NTPを参照しているかを表示
  - `timedatectl status`
    - 現在の時刻を表示
  - `timedatectl set-time {時刻}`
    - 時刻を設定する
    - HH:MM:SSで設定
  - `timedatectl set-time {日付}`
    - YYYY-MM-DD
  - `timedatectl set-time {日付} {時間}`
    - YYYY-MM-DD HH:MM:SS
  - `timedatectl set-timezone {timezone}`
    - タイムゾーンの変更
  - `timedatectl timezones`
    - タイムゾーンのリスト
  - `timedatectl set-ntp {yes|no}`
    - NTPを参照するかどうか
    - これが有効になっていると、手動で時刻変更はエラーになる
### NTPサーバの仕組み
- 時刻を定義する一次サーバがいくつか存在する
  - GPSや原子時計がこれにあたる
  - 一次、二次と進むにつれ、Stratum1,Stratum2...と続く
### ntpから取得 `ntpdate`
- `ntpdate {ntpserver.domain}`
- 環境変数は参照せずに直接ドメインを指定する
- UDP 123 によって疎通する

### NTPサーバの運用
- SysVinit
  - `/etc/init.d/ntpd start`
- systemed
  - `systemctl start ntpd.service`

### NTPサーバの状態照会 `ntpq`
- `ntpq {option} {domain}`
- オプションなしで対話モードでNTPサーバの状態を確認する
  - 接続されている台数
- フレーズ
  - `peers`...登録されているNTPサーバ
    - オプション`-p`でも可能
  - `assoc`...サーバと関連づけられた情報
  - `monlist`...クライアントからのアクセスリストを表示
    - （セキュリティ上の理由で多くのサーバでは無効）
  - `iostats`...入出力統計を表示
  - `kerninfo`...カーネルとの時刻同期情報
    - （PLL、オフセットなど）
  - `sysinfo`...システム全体のNTP状態を表示
  - `ifstats`...ネットワークインターフェイスの統計を表示
### NTPサーバを使う側の関連の設定ファイル
- `/etc/ntp.conf`
  - `server {ntpserver.domain}`一番目
  - `server {ntpserver.domain}`二番目...
  - ...
  - `driftfile /etc/ntp.drift`...補正情報ファイルの指定
  - `logfile /var/log/ntp.log`...ログファイルの指定
### 補正情報ファイル
- クロックの誤差を修正するためのファイル

### 次世代のNTP
- 今まではntpd/ntpdateが使用されてきた
- `Chrony`というNTPサーバ、クライアントが使用されつつある
- ntpと併用することはできない
- デーモン名：`chronyd`
- 管理コマンド:`chronyc`
- 対話モードで状態の確認が可能
- フレーズ
    - `activity`...NTPサーバのオンライン数
    - `source`...時刻ソースの情報とぶれを表示
    - `sourcestats`...時刻ソースの統計情報
    - `tracking`...トラッキング履歴を確認
    - `quit`...終了

- ※ chronicというコマンドもあるので間違え注意
  - エラーした場合にのみ出力するもの


### システムログ
- 様々なシステムのログを受け取る
  - ログファイルとして出力する
  - レベルに依存して破棄する
  - 他のホストに出す などを実行する
- ログを処理するプログラム
  - rsyslog
  - syslog-ng
  - などなど

### rsyslog設定フファイル
- `/etc/rsyslog.conf`
  - モジュールの読み込み
    - 拡張機能を利用できる
      - `imuxsock`(ローカルのsyslogの読み取り)
      - `imjournal`(systemd journalを読み込み)などが有名
    - 記載例
      - `module(load="imuxsock")`...新しい記法
      - `ModLoad imuxsock`...古い記法
  - ルールの設定
    - ログメッセージのファシリティと重要度から動作を決定する
      - ファシリティfacility:
        - atuth,cron,mail,daemon,kernなど
        - syslogで規格が決まっている
      - 重要度 priority:
        - debug, info, notice, warning, err, crit, alert, emerg
      - 動作
        - ディレクトリを指定
        - りモートにも転送できる@serverなど
    - 例：
      - `authpriv.info    /var/log/secure`
      - 認証の重要度infoをsecureに吐き出す
  - テンプレート
    - 出力フォーマットを変更できる
  - flientbitはこのログに入ったものをパケットにして転送する
- `/etc/rsyslog.d/*`
  - ここにカスタムした.confを配置したりする


### rsyslog設定ファイルのプラグイン
- `imuxsock`...UNIXソケットにローカルロギングサポート
  - loggerコマンドが使用できるようになる
- `imjounal`...systemdのジャーナルサポート
- `imklog`...カーネルログのサポート
- `immark`...マークを出力(--MARK--)
- `imudp`...UDPでメッセージを受信
- `imtcp`...TCPでメッセージを受信

### rsyslog設定ファイルのファシリティ
- `auth,authpriv`...ログインを含む認証システムの出力
- `cron`...cronによる出力
- `daemon`...各種デーモンによる出力
- `kern`...カーネルによる出力
- `lpr`...印刷システムによる出力
- `mail`...メールサービス
- `user`...ユーザアプリケーション
- `local0 - local7`...ローカルシステムからの出力
  - 自由に扱える枠としている
  - アプリケーション側に設定して、syslog.confの設定を変更してログを観察できる
### rsyslog設定ファイルのプライオリティ
- 高優先度から
  - emerg
  - alert
  - crit
  - err
  - warning
  - notice
  - info
  - debug
  - none...ログを記録しない
    - 指定したファシリティのログは送信されなくなる
    - 送信先の指定は文法上必須
### rysylog設定ファイルの出力先
- `/var/log/messages`...ログファイルに出力
- `/dev/tty1`...端末に送信
- `@sv.example.com`...ホストにUDPで送信
- `@@sv.example.com`...ホストにTCPで送信
- `fn`...ユーザfnの端末に出力
- `*`...ログイン中の全てのユーザ端末に出力

### syslogが認識するもの
- RFC 3164、3195、5424で規定されている
  - 原則L7の情報しか持てない
- 標準出力、標準エラーは通常認識しない。
  - loggerコマンドなどでリダイレクトすると流せたりする
- プログラム中でsyslog関数を使う
- モジュールで拡張したもの
  - systemctlやimuxsockなど
- UDP/TCP 514で送られてくるsyslogイベント
- rsyslogによるポート監視したパケット

### rsyslog設定の更新
- `systemctl restart rsyslog`

### loggerコマンド
- `logger {message}`
- `logger [-p facility.priority] [-t tag] {message}`
  - ファシリティは任意に指定できる
- タグ...メッセージの最初に入る
  - `{tag}:{message}`の形式でメッセージが出力


### systemd-cat
- コマンドの出力をジャーナルに書き込む
  - 標準出力、標準入力の双方を書き込み
- `systemd-cat {command}`
- ジャーナルを確認
- `joutnalctl -xe`

### ログの内容
- ログは`/etc/rsyslog.conf`に沿って保存
- 汎用ログ
  - `/var/log/messge`
  - `/var/log/syslog`が使用されやすい
  - 内容
    - 日付
    - 出力ホスト名
    - メッセージ出力元
    - メッセージ
  - よく`tail -f`とかでモニタリングされてる
- 認証ログ
  - `var/log/secure`
    - 失敗した場合にもここに入る

### journalctlによるログ管理
- systemdが必須
- `journalctl {option}`
- オプション
  - `-f`...ログの末尾を追従
  - `-r`...ログを新しい順に表示
  - `-e`...ジャーナルの末尾を表示
  - `-x`...説明文付きで表示
  - `-k`...カーネルメッセージのみを表示
  - `-b`...ブート時のメッセージを表示
  - `-p {priority}`...指定したプライオリティより高いもののみを表示
  - `-u {Unit_name}`...指定したUnitのログを表示
  - `-full`...プレーンテキストで表示
  - `--no-pager`...ページ表示せずに一括で表示
- journalctlの仕組み
  - 以下のファイルにログをバイナリで保存
    - `/var/log/journal`
    - `/var/run/log/journal`
  - 設定ファイル
    - `/etc/systemd/journald.conf`
### journalctlを永続化する
- ログの配置は`/var/run/*`配下ではダメ
  - これは揮発性を持つため、再起動で消える
- 追加で設定ファイルにいくつか指定が必要
  - `Storage=persistent`の指定が必要
  - `SystemMaxUse=XX`を十分大きくする
  - `SystemKeepFree=XX`を小さくする
  - `SystemMaxFileSize=XX`
    - ジャーナルログ1ファイルあたりのサイズ
  - `SystemMaxFiles=XX`
    - 同一出力のナンバリングの上限

### ログインユーザ・端末に関する情報を表示する
- `who`
  - ユーザ
  - ログイン端末名
  - ログイン日時
  - ログイン元IPが見える
  - `/var/run/utmp`を参照
- `w`
  - whoに加えて、システム情報も併せて表示する
  - アクティブなユーザだけを表示する
  - `/proc`も参照
    - 現在時刻
    - システム稼働時間
    - 現在のログインユーザ数
    - システム負荷(1,5,15分間の平均)
    - ユーザ情報
      - ユーザ
      - 端末名
      - コマンドやプロセス名
- `last`
  - 最近ログインしたユーザを表示
  - `/var/log/wtmp`
    - who logとかwrite temporaryの略語らしい
- `lastlog`
  - ユーザごとの直近のログイン一覧
  - `/var/log/lastlog`
  - ユーザと直近のログイン時刻が出力

### ログファイルのナンバリング
- `logrotate`ユーティリティが実行している
- 最新のものはナンバリング無し
- 新しい順から1,2,3...とナンバリングする
### logrotate設定ファイル
- `/etc/logrotate.conf`
  - ローテーション周期
  - バックアップの保存期間
  - ローテーションさせた後に新規ファイルを作成するか？
  - ログファイルを圧縮するか？
  - などなど

# メール管理
### メール配送
- 1.送信側MUAクライアント
  - Mail User Agent
- 2.中継メールサーバMTA
  - Message Transfer Agent  
- 3.メールサーバMTA
- 4.メールサーバMDA
  - Message Delivery service
  - MTAからユーザのメールボックスに格納する機能
  - メールの中継には使用しない
- 5.メールボックス
- 6.POPサーバ
- 7.受信側MUA

### 配送の流れ
- MUAが内部DNSを使用して、MXレコード宛にメール送信
- MX先ではMTAが動いているのでメールを配送
- 複数のMTAを通過する
- 受信者のMTAにつく
- MDAがメールボックスに配送
  - ほとんどの場合、MTAとMDAは同じサーバ
- MAAに送信
  - POPやIMAPサーバ

### なぜ受信ユーザは直接POP/IMAPしないの？
- MTAを操作してメールを取り出すことは可能
- セキュリティ的に別途POP/IMAPプロキシを用意して運用していることが多い
- この時IMAPとMTA,メールボックスは同じサーバで運用されることが多い

#### SMTPサーバの代表
- sendmail
- Postfix(master)
- exim

### mail MTAの運用
- メールの中継、自身のメールの場合はメールボックスに保管することがミッション
  - `netstat -antp | grep 25`
  - 中継MTAサーバからの受信が見えるはず
  - ※ 最近のSMTPは587番や465番を使用する

### mail MTAの起動
- SysVinit
  - `/etc/init.d/postfix start`
- systemctl
  - `systemctl statr postfix.service`

### ユーザとしてmailを送信する
- `mail`コマンド
- オプションなしで実行すると、届いているメールを確認できる
- 1,2,3...などの番号を押すと、新着順でそのメールを開く
- mail [-s {subject}] [username|mail_adress]
  - コマンド実行後、対話モードに入る
  - 本文入力後、改行+[.]で送信する
    - ctrl+Dでも良い

### エイリアスによるメールの転送
- MTAの管理サーバの設定で転送の設定をする
- `/etc/aliases`(コマンドのエイリアスとは違い、こちらは複数形)
  - `root:admin, sample`
  - root宛のメールをadmin,sampleに転送
  - rootには届かなくなる
- `/etc/aliases`の更新を反映するコマンド
  - `newaliases`
    - MTAに設定の変更を教えてあげる
    - `/etc/aliases.db`を更新する
### メール受信クライアントによる転送
- `~/.forward`ファイルをユーザディレクトリ配下に配置
  - 内容には転送先のメールアドレスだけを転載すれば良い
  - `sample@mail.com, bri@bllue.com`

### メールキューの設定
- 送信待ちのメールのこと
- MTAがSMTP/TCPを受け入れない場合にここに保存される
- 他、DNSの設定が間違っている場合など
- コマンド`maailq`で確認可能


# プリンタ管理
### 印刷の仕組み
- CUPS(Commono Unix Printing System)
  - IPPの採用
    - Internet Printer Protocol
    - プリンタ用のプロトコル
    - インターネットも経由できる
  - PPDファイルサポート
    - PostScript Printer Description
    - adbeのPPDファイル
  - Webベースの設定
    - ブラウザから設定項目の編集が可能
  - プリンタクラス
    - 複数のプリンタを一台のプリンタと認識する
- CUPSはどこにあるのか？
  - 一部の複合機はCUPSを内蔵している
    - IPP対応プリンタというのがソレ

- CUPSは何をする？
  - ジョブの受領
  - プリントキューの管理
  - PPDフィルタの適応
  - プリンタへのジョブ配送

### PPD(PostScript Printer Description)について
- 印刷ジョブとは別にどう印刷するかを設定する
  - 用紙のサイズ
  - 解像度
  - 両面印刷
  - カラーモードなどなど
- ファイルを印刷する際にプリンタが理解できる形式にファイルを変換したりする
  - PDF、もしくはPostScript

### cupsの設定
- CUPSを起動しているサーバで
  - `/etc/cups/cupsd.conf`
    - 印刷要求を受け入れる設定
      - ジョブ受け入れポート(デフォルトは631)
      - アクセス制限
      - 最大キュー
      - セキュリティ
  - `/etc/cups/printers.conf`
### cupsの起動
- `etc/init.d/cups start`
- `systemctl start cups.service`
- IPPが空いていればCUPSは起動している
  - 確認：`netstat at |grep ipp`

### lpr印刷
- コマンドによって印刷を実行する
- lpr {file_name}
  - ファイルを印刷
- echo hellp | lpr
  - 標準出力を印刷
- オプション
  - `lpr -#{num}`...部数の指定
  - `lpr - P {printer_name}`....印刷するプリンタの指定

### 印刷のキューの問い合わせ lpqコマンド
- `lpq`
  - デフォルトのプリンタのジョブの状態を表示
- `lpq -P {printer_name}`
  - 指定したプリンタのジョブの状態を表示

### 印刷キューを削除する
- 一般ユーザ：自分の発行した印刷要求を削除
- スーパユーザ：全ての印刷要求を削除
- `lprm`
  - `lprm -P {プリンタ名}`
  - `lprm -`
